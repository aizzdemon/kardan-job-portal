<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard - BooterSpace Job Portal</title>

<script src="https://cdn.tailwindcss.com"></script>
<!-- Using Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }

.popup-overlay {
	position: fixed;
	inset: 0;
	background: rgba(0,0,0,0.7);
	display: none;
	align-items: center;
	justify-content: center;
	z-index: 50;
	backdrop-filter: blur(3px);
	overflow-y: auto;
	padding: 20px 0;
}
.popup {
	background: white;
	border-radius: 1rem;
	box-shadow: 0 15px 30px rgba(0,0,0,0.3);
	padding: 2rem;
	width: 95%;
	max-width: 600px;
	margin: auto;
	animation: fadeIn 0.3s ease-in-out;
}
@keyframes fadeIn {
	from { transform: scale(0.9); opacity: 0; }
	to { transform: scale(1); opacity: 1; }
}
.preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
.clear-both { clear: both; }
</style>
</head>
<body class="bg-gray-100">

<!-- Navbar Container -->
<div id="navbarContainer"></div>

<script>
  // Dynamically load navbar from navbar.html
  fetch('navbar.html')
    .then(response => response.text())
    .then(html => {
      document.getElementById('navbarContainer').innerHTML = html;
    })
    .catch(err => console.error('Failed to load navbar:', err));
</script>

<!-- Header -->
<section class="text-center my-6">
	<h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
	<p class="text-gray-500 mt-1">üëã Welcome, <span id="userName" class="font-semibold text-gray-800">Loading...</span></p>
	<p id="userEmail" class="text-gray-500 text-sm"></p>
</section>

<!-- Main Layout -->
<div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-6 px-4 mb-16">
	<!-- Left -->
	<div class="md:w-1/3 space-y-4">
		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-blue-600 mb-2">Your Applications</h4>
			<p class="text-gray-500">You haven‚Äôt applied for any jobs yet.</p>
			<a href="jobs.html" class="mt-2 inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-150">+ Find Jobs</a>
		</div>

		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-red-600 mb-2">Saved Jobs</h4>
			<p class="text-gray-500">No saved jobs yet.</p>
			<a href="jobs.html" class="mt-2 inline-block bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-150">üîç Browse Listings</a>
		</div>

		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-green-600 mb-2">Profile Management</h4>
			<p class="text-gray-500">Keep your profile up-to-date.</p>
			<button id="profileBtn" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-150">‚úèÔ∏è Edit Profile</button>
		</div>

		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-yellow-600 mb-2">Post a New Job</h4>
			<p class="text-gray-500">Share opportunities with others.</p>
			<!-- This button is now linked to open the popup -->
			<button id="postJobBtn" class="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-150">üìù Post Job</button>
		</div>
	</div>

	<!-- Right -->
	<div id="postedJobsSection" class="md:w-2/3 bg-white p-6 rounded-xl shadow">
		<h4 class="font-bold text-2xl text-gray-800 mb-4">üìã Your Posted Jobs</h4>
		<div id="jobsList" class="space-y-4 text-sm text-gray-700">
			<p class='text-gray-500 text-center py-8'>Loading jobs...</p>
		</div>
		<!-- Load More Button Container -->
		<div id="loadMoreContainer" class="text-center pt-4" style="display:none;">
			<button id="loadMoreBtn" onclick="loadMoreJobs()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold shadow-md">
				Load More Jobs (0 remaining)
			</button>
		</div>
	</div>
</div>

<!-- Profile Management Popup (Unchanged) -->
<div id="profilePopup" class="popup-overlay">
	<div class="popup">
		<h3 class="text-xl font-bold mb-4 text-center text-gray-800">üë§ Edit Profile</h3>
		<form id="profileForm" class="space-y-3">
			<div><label class="block mb-1 font-medium">Full Name</label><input type="text" id="profileName" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Email</label><input type="email" id="profileEmail" class="w-full border rounded-lg p-2 bg-gray-100" disabled /></div>
			<div><label class="block mb-1 font-medium">Experience</label><input type="text" id="profileExperience" class="w-full border rounded-lg p-2" placeholder="e.g., 2 years in Sales" /></div>
			<div><label class="block mb-1 font-medium">Education</label><input type="text" id="profileEducation" class="w-full border rounded-lg p-2" placeholder="e.g., B.Tech, XYZ University" /></div>
			<div class="flex justify-between pt-3">
				<button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üíæ Save Changes</button>
				<button type="button" id="closeProfilePopupBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
			</div>
		</form>
	</div>
</div>

<!-- Job Posting Popup -->
<div id="postJobPopup" class="popup-overlay">
	<div class="popup">
		<h3 class="text-xl font-bold mb-4 text-center text-gray-800">üìù Post a New Job</h3>
		<form id="postJobForm" class="space-y-3">
			<div><label class="block mb-1 font-medium">Job Title</label><input type="text" id="jobTitle" class="w-full border rounded-lg p-2" required placeholder="e.g., Senior Frontend Developer" /></div>
			<div><label class="block mb-1 font-medium">Company Name</label><input type="text" id="jobCompanyName" class="w-full border rounded-lg p-2" required placeholder="e.g., BooterSpace Inc." /></div>
			<div>
				<label class="block mb-1 font-medium">Employment Type</label>
				<select id="jobEmploymentType" class="w-full border rounded-lg p-2" required>
					<option value="">Select Type *</option>
					<option value="Full-time">Full-time</option>
					<option value="Part-time">Part-time</option>
					<option value="Internship">Internship</option>
				</select>
			</div>
			
			<div>
				<label class="block mb-1 font-medium">Salary Range (Optional)</label>
				<input type="text" id="jobSalary" class="w-full border rounded-lg p-2" placeholder="e.g., $70,000 - $90,000 or Competitive" />
			</div>

			<div><label class="block mb-1 font-medium">Location</label><input type="text" id="jobLocation" class="w-full border rounded-lg p-2" required placeholder="e.g., Remote (US only) or New York" /></div>
			<div><label class="block mb-1 font-medium">Application Link</label><input type="url" id="jobApplyLink" class="w-full border rounded-lg p-2" required placeholder="https://company.com/apply-here" /></div>

			<div>
				<label class="block mb-1 font-medium">Company Logo URL (Optional)</label>
				<input type="url" id="jobCompanyImageUrl" class="w-full border rounded-lg p-2" placeholder="https://yourcompany.com/logo.png" />
			</div>

			<div>
				<label class="block mb-1 font-medium">Job Header Image URL (Optional)</label>
				<input type="url" id="jobJobImageUrl" class="w-full border rounded-lg p-2" placeholder="https://jobportal.com/header-image.jpg" />
			</div>
			
			<div><label class="block mb-1 font-medium">Job Details / Description</label><textarea id="jobDetails" rows="5" class="w-full border rounded-lg p-2" required placeholder="Provide a detailed job description, responsibilities, and requirements."></textarea></div>
			<div class="flex justify-between pt-3">
				<button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">üöÄ Publish Job</button>
				<button type="button" id="closeJobPostPopupBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
			</div>
		</form>
	</div>
</div>

<!-- Edit Job Popup -->
<div id="editJobPopup" class="popup-overlay">
	<div class="popup">
		<h3 class="text-xl font-bold mb-4 text-center text-gray-800">‚úçÔ∏è Edit Job Posting</h3>
		<form id="editJobForm" class="space-y-3">
			<input type="hidden" id="editJobId" />
			<div><label class="block mb-1 font-medium">Job Title</label><input type="text" id="editJobTitle" class="w-full border rounded-lg p-2" required placeholder="e.g., Senior Frontend Developer" /></div>
			<div><label class="block mb-1 font-medium">Company Name</label><input type="text" id="editJobCompanyName" class="w-full border rounded-lg p-2" required placeholder="e.g., BooterSpace Inc." /></div>
			<div>
				<label class="block mb-1 font-medium">Employment Type</label>
				<select id="editJobEmploymentType" class="w-full border rounded-lg p-2" required>
					<option value="">Select Type *</option>
					<option value="Full-time">Full-time</option>
					<option value="Part-time">Part-time</option>
					<option value="Internship">Internship</option>
				</select>
			</div>
			
			<div>
				<label class="block mb-1 font-medium">Salary Range (Optional)</label>
				<input type="text" id="editJobSalary" class="w-full border rounded-lg p-2" placeholder="e.g., $70,000 - $90,000 or Competitive" />
			</div>

			<div><label class="block mb-1 font-medium">Location</label><input type="text" id="editJobLocation" class="w-full border rounded-lg p-2" required placeholder="e.g., Remote (US only) or New York" /></div>
			<div><label class="block mb-1 font-medium">Application Link</label><input type="url" id="editJobApplyLink" class="w-full border rounded-lg p-2" required placeholder="https://company.com/apply-here" /></div>

			<div>
				<label class="block mb-1 font-medium">Company Logo URL (Optional)</label>
				<input type="url" id="editJobCompanyImageUrl" class="w-full border rounded-lg p-2" placeholder="https://yourcompany.com/logo.png" />
			</div>

			<div>
				<label class="block mb-1 font-medium">Job Header Image URL (Optional)</label>
				<input type="url" id="editJobJobImageUrl" class="w-full border rounded-lg p-2" placeholder="https://jobportal.com/header-image.jpg" />
			</div>
			
			<div><label class="block mb-1 font-medium">Job Details / Description</label><textarea id="editJobDetails" rows="5" class="w-full border rounded-lg p-2" required placeholder="Provide a detailed job description, responsibilities, and requirements."></textarea></div>
			<div class="flex justify-between pt-3">
				<button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">‚úÖ Update Job</button>
				<button type="button" id="closeEditJobPopupBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
			</div>
		</form>
	</div>
</div>

<!-- Job Post Success Popup (Unchanged) -->
<div id="jobSuccessPopup" class="popup-overlay">
	<div class="popup text-center max-w-sm">
		<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
			<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
		</svg>
		<h3 class="text-2xl font-bold mb-2 text-gray-800">Job Posted!</h3>
		<p class="text-gray-600 mb-6">Your job, "<span id="successJobTitle" class="font-semibold text-indigo-600"></span>", has been published.</p>
		<div class="flex justify-center gap-3 pt-3">
			<button id="successEditBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold">‚úèÔ∏è Edit</button>
			<button id="successDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold">üóëÔ∏è Delete</button>
			<button id="successOkBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold">üëå OK</button>
		</div>
	</div>
</div>

<!-- NEW: Job Update Success Popup -->
<div id="jobUpdateSuccessPopup" class="popup-overlay">
	<div class="popup text-center max-w-sm">
		<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
			<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
		</svg>
		<h3 class="text-2xl font-bold mb-2 text-gray-800">Job Updated!</h3>
		<p class="text-gray-600 mb-6">Your job, "<span id="updateSuccessJobTitle" class="font-semibold text-indigo-600"></span>", has been successfully modified.</p>
		<div class="flex justify-center pt-3">
			<button id="updateSuccessOkBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold">üëå Close</button>
		</div>
	</div>
</div>


<!-- Footer -->
<footer class="text-center text-gray-500 py-4 text-sm">
	¬© 2025 BooterSpace Job Portal | <a href="#" class="underline">Privacy</a> | <a href="#" class="underline">Terms</a>
</footer>

<script type="module">
	// Firebase config from the original code
	const firebaseConfig = {
		apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
		authDomain: "kar-kardan.firebaseapp.com",
		projectId: "kar-kardan",
		storageBucket: "kar-kardan.firebasestorage.app",
		messagingSenderId: "554147696994",
		appId: "1:554147696994:web:221dcb883e3b65dcea5c3b",
		measurementId: "G-RRC3X485KQ"
	};

	firebase.initializeApp(firebaseConfig);
	const auth = firebase.auth();
	const db = firebase.firestore();

	// Global variables for pagination state
	let allJobs = [];
	const JOB_LIMIT = 10;
	let jobsToShow = JOB_LIMIT;

	// Global element references for the new success popup
	const jobSuccessPopup = document.getElementById('jobSuccessPopup');
	const successJobTitleSpan = document.getElementById('successJobTitle');
	const successEditBtn = document.getElementById('successEditBtn');
	const successDeleteBtn = document.getElementById('successDeleteBtn');
	const successOkBtn = document.getElementById('successOkBtn');
	
	// NEW: Update success popup elements
	const jobUpdateSuccessPopup = document.getElementById('jobUpdateSuccessPopup');
	const updateSuccessJobTitleSpan = document.getElementById('updateSuccessJobTitle');
	const updateSuccessOkBtn = document.getElementById('updateSuccessOkBtn');


	// --- Utility Functions ---

	// Function to handle job deletion
	async function deleteJob(jobId) {
		try {
			if (confirm('Are you sure you want to delete this job post?')) { 
				await db.collection('jobs').doc(jobId).delete();
				console.log("Job deleted successfully:", jobId);
				jobSuccessPopup.style.display = 'none'; // Close success popup if active
				jobUpdateSuccessPopup.style.display = 'none'; // Close update popup if active
			}
		} catch (error) {
			console.error("Error removing document: ", error);
			console.error('Failed to delete job.');
		}
	}

	// Function to open the POST success popup
	function showJobSuccessPopup(jobId, jobTitle) {
		successJobTitleSpan.innerText = jobTitle;
		jobSuccessPopup.style.display = 'flex';
		
		// Unbind previous listeners to prevent accumulating them
		successEditBtn.onclick = null;
		successDeleteBtn.onclick = null;
		
		// Set up buttons for the specific job
		successEditBtn.onclick = () => {
			jobSuccessPopup.style.display = 'none';
			window.openEditJobPopup(jobId);
		};

		successDeleteBtn.onclick = () => {
			deleteJob(jobId);
		};
	}
	
	// NEW: Function to open the UPDATE success popup
	function showJobUpdateSuccessPopup(jobTitle) {
		updateSuccessJobTitleSpan.innerText = jobTitle;
		jobUpdateSuccessPopup.style.display = 'flex';
	}


	// --- Initialization and Core Logic ---

	// Logout
	document.getElementById('logoutBtn').onclick = () => {
		auth.signOut().then(() => {
			location.href = 'login.html';
		}).catch(error => {
			console.error("Logout Error:", error);
		});
	};

	// Close popups when clicking OK or outside the overlay
	successOkBtn.onclick = () => jobSuccessPopup.style.display = 'none';
	jobSuccessPopup.addEventListener('click', (e) => {
		if (e.target.id === 'jobSuccessPopup') {
			jobSuccessPopup.style.display = 'none';
		}
	});

	// NEW: Close update popup when clicking OK or outside the overlay
	updateSuccessOkBtn.onclick = () => jobUpdateSuccessPopup.style.display = 'none';
	jobUpdateSuccessPopup.addEventListener('click', (e) => {
		if (e.target.id === 'jobUpdateSuccessPopup') {
			jobUpdateSuccessPopup.style.display = 'none';
		}
	});


	// Show logged in user info and load data
	auth.onAuthStateChanged(user => {
		if(!user) {
			location.href='login.html';
			return;
		}
		
		// Load profile and name first, then jobs
		loadProfile(user);
		loadJobs(user.uid);
	});

	// Function to load profile data and update the dashboard header
	function loadProfile(user){
		const uid = user.uid;
		document.getElementById('profileEmail').value = user.email; // Set email in popup
		
		db.collection('users').doc(uid).get().then(doc=>{
			let displayName = user.email.split('@')[0]; // Fallback name
			let fullName = '';
			if(doc.exists){
				const data = doc.data();
				fullName = data.fullName || '';
				displayName = fullName || displayName; // Use saved full name if exists
				
				// Set values in the Profile Popup
				document.getElementById('profileName').value = fullName;
				document.getElementById('profileExperience').value = data.experience || '';
				document.getElementById('profileEducation').value = data.education || '';
			}
			
			// Update dashboard display
			document.getElementById('userName').innerText = displayName;
			document.getElementById('userEmail').innerText = user.email;
		}).catch(error => {
			console.error("Error loading profile:", error);
			// Still set default name if Firestore fails
			document.getElementById('userName').innerText = user.displayName || user.email.split('@')[0];
			document.getElementById('userEmail').innerText = user.email;
		});
	}

	// Profile popup controls
	const profilePopup = document.getElementById('profilePopup');
	const profileBtn = document.getElementById('profileBtn');
	const closeProfilePopupBtn = document.getElementById('closeProfilePopupBtn');

	if(profileBtn) profileBtn.onclick = () => profilePopup.style.display = 'flex';
	if(closeProfilePopupBtn) closeProfilePopupBtn.onclick = () => profilePopup.style.display = 'none';

	// Update profile form submission
	document.getElementById('profileForm').onsubmit = async (e)=>{
		e.preventDefault();
		const user = auth.currentUser;
		if (!user) return;
		
		const newFullName = document.getElementById('profileName').value;

		try {
			// 1. Update Firestore user profile data
			await db.collection('users').doc(user.uid).set({
				fullName: newFullName,
				email: user.email,
				experience: document.getElementById('profileExperience').value,
				education: document.getElementById('profileEducation').value
			}, {merge: true});

			// 2. Update Firebase Auth display name for immediate frontend consistency
			if (user.displayName !== newFullName) {
				await user.updateProfile({ displayName: newFullName });
			}
			
			// 3. Refresh dashboard display using the updated user object
			loadProfile(auth.currentUser); 

			profilePopup.style.display='none';
			// Using console log instead of alert for better UX flow
			console.log('Profile updated successfully!'); 
		} catch (error) {
			console.error("Error updating profile:", error);
			// Using console log instead of alert
			console.error('Failed to update profile. Check console for details.'); 
		}
	};

	// Job Posting Popup Logic
	const postJobPopup = document.getElementById('postJobPopup');
	const postJobBtn = document.getElementById('postJobBtn');
	const closeJobPostPopupBtn = document.getElementById('closeJobPostPopupBtn');
	const postJobForm = document.getElementById('postJobForm');

	if(postJobBtn) postJobBtn.onclick = () => postJobPopup.style.display = 'flex';
	if(closeJobPostPopupBtn) closeJobPostPopupBtn.onclick = () => postJobPopup.style.display = 'none';

	// Job Posting Form Submission
	postJobForm.onsubmit = async (e)=>{
		e.preventDefault();
		const user = auth.currentUser;
		if (!user) {
			console.error('You must be logged in to post a job.');
			return;
		}
		
		const jobTitle = document.getElementById('jobTitle').value; // Capture title before reset
		const jobData = {
			title: jobTitle,
			companyName: document.getElementById('jobCompanyName').value,
			employmentType: document.getElementById('jobEmploymentType').value,
			salary: document.getElementById('jobSalary').value,
			location: document.getElementById('jobLocation').value,
			applyLink: document.getElementById('jobApplyLink').value,
			companyImageUrl: document.getElementById('jobCompanyImageUrl').value,
			jobImageUrl: document.getElementById('jobJobImageUrl').value,
			details: document.getElementById('jobDetails').value,
			postedBy: user.uid,
			timestamp: firebase.firestore.FieldValue.serverTimestamp()
		};

		try {
			const docRef = await db.collection('jobs').add(jobData);
			postJobPopup.style.display = 'none';
			postJobForm.reset(); // Clear the form
			console.log('Job posted successfully! It should appear in your list shortly.');
			
			// Show the POST success popup
			showJobSuccessPopup(docRef.id, jobTitle);

		} catch(error) {
			console.error("Error posting job: ", error);
			// Using console log instead of alert
			console.error('Failed to post job. Check console for details.');
		}
	};

	// Edit Job Popup Logic
	const editJobPopup = document.getElementById('editJobPopup');
	const closeEditJobPopupBtn = document.getElementById('closeEditJobPopupBtn');
	const editJobForm = document.getElementById('editJobForm');

	if(closeEditJobPopupBtn) closeEditJobPopupBtn.onclick = () => editJobPopup.style.display = 'none';

	// Function to open the edit popup and populate fields
	window.openEditJobPopup = async (jobId) => {
		try {
			const doc = await db.collection('jobs').doc(jobId).get();
			if (!doc.exists) {
				console.error("Job not found:", jobId);
				return;
			}
			const job = doc.data();
			
			// Set the hidden ID
			document.getElementById('editJobId').value = jobId;

			// Populate all fields
			document.getElementById('editJobTitle').value = job.title || '';
			document.getElementById('editJobCompanyName').value = job.companyName || '';
			document.getElementById('editJobEmploymentType').value = job.employmentType || '';
			document.getElementById('editJobSalary').value = job.salary || '';
			document.getElementById('editJobLocation').value = job.location || '';
			document.getElementById('editJobApplyLink').value = job.applyLink || '';
			document.getElementById('editJobCompanyImageUrl').value = job.companyImageUrl || '';
			document.getElementById('editJobJobImageUrl').value = job.jobImageUrl || '';
			document.getElementById('editJobDetails').value = job.details || '';

			editJobPopup.style.display = 'flex';
		} catch (error) {
			console.error("Error loading job for edit:", error);
			// Using console log instead of alert
			console.error('Failed to load job details for editing.'); 
		}
	};

	// Edit Job Form Submission (Update Logic) - FIX APPLIED HERE
	editJobForm.onsubmit = async (e) => {
		e.preventDefault();
		const jobId = document.getElementById('editJobId').value;
		if (!jobId) return;

		const jobTitle = document.getElementById('editJobTitle').value; // Get the title for the success message

		const updatedData = {
			// FIX: Ensure we are using the 'edit' input IDs here
			title: jobTitle,
			companyName: document.getElementById('editJobCompanyName').value,
			employmentType: document.getElementById('editJobEmploymentType').value,
			salary: document.getElementById('editJobSalary').value,
			location: document.getElementById('editJobLocation').value,
			applyLink: document.getElementById('editJobApplyLink').value,
			companyImageUrl: document.getElementById('editJobCompanyImageUrl').value,
			jobImageUrl: document.getElementById('editJobJobImageUrl').value,
			details: document.getElementById('editJobDetails').value,
		};

		try {
			// Use updateDoc (or set with merge: true) to modify the existing document
			await db.collection('jobs').doc(jobId).update(updatedData);

			editJobPopup.style.display = 'none';
			console.log('Job updated successfully!'); 
			
			// NEW: Show the UPDATE success popup
			showJobUpdateSuccessPopup(jobTitle);

		} catch (error) {
			console.error("Error updating job: ", error);
			// Using console log instead of alert
			console.error('Failed to update job. Check console for details.'); 
		}
	};

	// --- Pagination Functions ---

	// New function to handle loading more jobs
	window.loadMoreJobs = function() {
		// Increase the count by the limit (10) or a smaller number for the next batch
		jobsToShow = Math.min(allJobs.length, jobsToShow + JOB_LIMIT); 
		renderJobs(); // Re-render the list with the new limit
	}

	// New function to render the jobs based on the current 'jobsToShow' limit
	function renderJobs() {
		const jobsList = document.getElementById('jobsList');
		const loadMoreContainer = document.getElementById('loadMoreContainer');
		const loadMoreBtn = document.getElementById('loadMoreBtn');

		jobsList.innerHTML = ''; // Clear existing list

		// Determine which jobs to display (slice the global array)
		const jobsToRender = allJobs.slice(0, jobsToShow);

		if (jobsToRender.length === 0 && allJobs.length === 0) {
			jobsList.innerHTML = "<p class='text-gray-500 text-center py-8'>No jobs posted yet. Use the 'Post Job' button to share an opportunity!</p>";
			loadMoreContainer.style.display = 'none';
			return;
		}

		// Render the jobs
		jobsToRender.forEach(job => {
			const div = document.createElement('div');
			div.className = "border p-3 rounded-lg shadow-sm bg-gray-50 flex justify-between items-center hover:shadow-md transition duration-200";
			
			const datePosted = job.timestamp ? job.timestamp.toDate().toLocaleDateString() : 'Date N/A';
			
			// Simplified Display
			div.innerHTML = `
				<div class="flex-grow">
					<h5 class="font-semibold text-lg text-gray-800">${job.title}</h5>
					<p class="text-gray-600 text-sm">@ ${job.companyName} | ${job.location || 'N/A'}</p>
					<p class="text-xs text-gray-400 mt-1">Posted on: ${datePosted}</p>
				</div>
				<div class="flex gap-2">
					<button data-job-id="${job.id}" onclick="openEditJobPopup('${job.id}')" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200 transition">‚úèÔ∏è Edit</button>
					<button data-job-id="${job.id}" class="delete-job-btn text-sm bg-red-100 text-red-700 px-3 py-1 rounded-lg hover:bg-red-200 transition">üóëÔ∏è Delete</button>
				</div>
			`;
			jobsList.appendChild(div);
		});

		// Handle Load More button visibility and text
		if (allJobs.length > jobsToShow) {
			loadMoreContainer.style.display = 'block';
			const remaining = allJobs.length - jobsToShow;
			loadMoreBtn.innerText = `Load More Jobs (${remaining} remaining)`;
		} else {
			loadMoreContainer.style.display = 'none';
		}
		
		// Attach listener for delete buttons
		jobsList.querySelectorAll('.delete-job-btn').forEach(button => {
			button.addEventListener('click', async (e) => {
				const jobId = e.target.dataset.jobId;
				deleteJob(jobId); // Use the reusable delete function
			});
		});
	}

	// Function to load and render jobs
	function loadJobs(uid){
		const jobsList = document.getElementById('jobsList');
		jobsList.innerHTML = "<p class='text-gray-500 text-center py-8'>Loading jobs...</p>";

		// Query without orderBy for simple fetching
		const jobQuery = db.collection('jobs')
			.where('postedBy', '==', uid); 

		jobQuery.onSnapshot(snapshot => {
			if(snapshot.empty) {
				allJobs = [];
				jobsToShow = JOB_LIMIT;
				renderJobs(); // Will render "No jobs posted yet" message
				return;
			}
			
			// Extract and sort all jobs client-side (most recent first)
			const jobsArray = [];
			snapshot.forEach(doc => {
				jobsArray.push({
					id: doc.id,
					...doc.data()
				});
			});
			
			jobsArray.sort((a, b) => {
				const timeA = a.timestamp ? a.timestamp.toDate().getTime() : 0;
				const timeB = b.timestamp ? b.timestamp.toDate().getTime() : 0;
				return timeB - timeA; // Descending order
			});

			// Store sorted array and reset view count
			allJobs = jobsArray;
			// Only reset jobsToShow if the current view is past the new total length, otherwise maintain the current jobsToShow count
			if (jobsToShow > allJobs.length) {
				jobsToShow = allJobs.length > JOB_LIMIT ? allJobs.length : JOB_LIMIT;
			}
			
			renderJobs(); // Render the current batch
		}, error => {
			console.error("Error loading jobs:", error);
			jobsList.innerHTML = "<p class='text-red-500 text-center py-8'>Error loading jobs. Check console for details.</p>";
			document.getElementById('loadMoreContainer').style.display = 'none';
		});
	}
</script>
</body>
</html>

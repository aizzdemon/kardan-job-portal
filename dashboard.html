import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  where,
  Timestamp 
} from 'firebase/firestore';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInAnonymously, 
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  Briefcase, 
  Plus, 
  Clock, 
  CheckCircle, 
  MapPin, 
  Building2, 
  ExternalLink, 
  X,
  LayoutDashboard,
  User
} from 'lucide-react';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

export default function App() {
  const [user, setUser] = useState(null);
  const [jobs, setJobs] = useState([]);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [loading, setLoading] = useState(true);
  const [posting, setPosting] = useState(false);
  const [showSuccess, setShowSuccess] = useState(false);

  // --- Auth Logic (Rule 3) ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Auth error:", error);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setLoading(false);
    });
    return () => unsubscribe();
  }, []);

  // --- Data Fetching (Aligned with your Firestore Rules) ---
  useEffect(() => {
    if (!user) return;

    // Rule Match: We now use the root '/jobs' collection as per your rules
    const jobsCollection = collection(db, 'jobs');
    
    // We filter by userId in memory or via simple query to show "My Jobs"
    // Note: Your rules allow reading approved jobs publicly, but for a dashboard,
    // providers usually want to see ALL their own jobs (pending or approved).
    const q = query(jobsCollection); 

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const jobsList = snapshot.docs
        .map(doc => ({ id: doc.id, ...doc.data() }))
        // Filter in-memory to show only jobs belonging to this provider
        .filter(job => job.userId === user.uid);
      
      setJobs(jobsList.sort((a, b) => b.createdAt?.seconds - a.createdAt?.seconds));
    }, (error) => {
      console.error("Firestore error:", error);
    });

    return () => unsubscribe();
  }, [user]);

  const handlePostJob = async (e) => {
    e.preventDefault();
    if (!user) return;
    setPosting(true);

    const formData = new FormData(e.target);
    
    // Data mapping to match your Firestore 'allow create' requirements:
    // 1. userId must match request.auth.uid
    // 2. status must be "pending"
    const jobData = {
      title: formData.get('jobTitle'),
      company: formData.get('companyName'),
      logo: formData.get('companyLogo') || 'https://via.placeholder.com/100?text=Logo',
      location: formData.get('jobPlace'),
      salary: formData.get('salary'),
      link: formData.get('jobLink'),
      description: formData.get('jobDescription'),
      status: 'pending', // Matches rule requirement for creation
      userId: user.uid,   // Matches rule requirement: request.resource.data.userId == request.auth.uid
      createdAt: Timestamp.now()
    };

    try {
      const jobsCollection = collection(db, 'jobs');
      await addDoc(jobsCollection, jobData);
      
      setShowSuccess(true);
      setTimeout(() => {
        setShowSuccess(false);
        setIsModalOpen(false);
        e.target.reset();
      }, 2000);
    } catch (error) {
      console.error("Error adding job:", error);
      // In a real app, you'd show a user-friendly error message here
    } finally {
      setPosting(false);
    }
  };

  if (loading) {
    return (
      <div className="flex h-screen items-center justify-center bg-gray-50">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
      </div>
    );
  }

  const displayName = user?.displayName || `Provider #${user?.uid?.substring(0, 5)}`;

  return (
    <div className="min-h-screen bg-gray-50 text-gray-900 font-sans">
      {/* Sidebar / Header */}
      <nav className="bg-white border-b sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16 items-center">
            <a 
              href="index.html" 
              className="flex items-center gap-2 group transition-transform active:scale-95"
            >
              <div className="bg-green-600 p-2 rounded-lg text-white group-hover:bg-green-700 transition-colors">
                <Briefcase size={24} />
              </div>
              <span className="font-black text-2xl tracking-tighter">
                <span className="text-black">Booter</span>
                <span className="text-blue-600">Space</span>
              </span>
            </a>
            
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-3 text-right">
                <div className="hidden md:block">
                  <p className="text-sm font-bold text-gray-800">{displayName}</p>
                  <p className="text-xs text-green-600 font-medium">Verified Account</p>
                </div>
                <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center border text-gray-500">
                  <User size={20} />
                </div>
              </div>
              <button 
                onClick={() => setIsModalOpen(true)}
                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-all shadow-sm active:scale-95"
              >
                <Plus size={20} />
                <span className="hidden sm:inline">Post Job</span>
              </button>
            </div>
          </div>
        </div>
      </nav>

      {/* Main Content */}
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header className="mb-8">
          <h1 className="text-2xl font-bold flex items-center gap-2 text-gray-800">
            <LayoutDashboard className="text-green-600" />
            Welcome back, {user?.displayName || 'Provider'}
          </h1>
          <p className="text-gray-500 mt-1">Manage your job listings in the BooterSpace network.</p>
        </header>

        {/* Stats Grid */}
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
          <div className="bg-white p-6 rounded-xl border shadow-sm">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">Total Postings</p>
            <p className="text-3xl font-bold mt-2">{jobs.length}</p>
          </div>
          <div className="bg-white p-6 rounded-xl border shadow-sm">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">Pending Approval</p>
            <p className="text-3xl font-bold mt-2 text-amber-500">
              {jobs.filter(j => j.status === 'pending').length}
            </p>
          </div>
          <div className="bg-white p-6 rounded-xl border shadow-sm">
            <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">Live Jobs</p>
            <p className="text-3xl font-bold mt-2 text-green-600">
              {jobs.filter(j => j.status === 'approved').length}
            </p>
          </div>
        </div>

        {/* Listings Table / Cards */}
        <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
          <div className="px-6 py-4 border-b bg-gray-50/50 flex justify-between items-center">
            <h2 className="font-bold text-gray-700">Your Recent Listings</h2>
            <span className="text-xs text-gray-400 font-mono italic">Role: Job Provider</span>
          </div>
          
          {jobs.length === 0 ? (
            <div className="p-12 text-center">
              <div className="mx-auto w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4 text-gray-400">
                <Briefcase size={32} />
              </div>
              <h3 className="text-lg font-semibold text-gray-600">No jobs posted yet</h3>
              <p className="text-gray-400 max-w-xs mx-auto mt-2">Start hiring by clicking the "Post Job" button at the top.</p>
            </div>
          ) : (
            <div className="divide-y">
              {jobs.map((job) => (
                <div key={job.id} className="p-6 hover:bg-gray-50 transition-colors flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div className="flex gap-4">
                    <img 
                      src={job.logo} 
                      alt={job.company} 
                      className="w-12 h-12 rounded-lg object-cover border bg-white"
                      onError={(e) => e.target.src = 'https://via.placeholder.com/100?text=Job'}
                    />
                    <div>
                      <h3 className="font-bold text-lg leading-tight text-gray-800">{job.title}</h3>
                      <div className="flex flex-wrap gap-x-4 gap-y-1 mt-1 text-sm text-gray-500 items-center">
                        <span className="flex items-center gap-1 font-medium"><Building2 size={14} /> {job.company}</span>
                        <span className="flex items-center gap-1"><MapPin size={14} /> {job.location}</span>
                        {job.salary && <span className="text-green-600 font-bold">{job.salary}</span>}
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center justify-between md:justify-end gap-4">
                    <div className={`px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1.5 ${
                      job.status === 'pending' 
                        ? 'bg-amber-100 text-amber-700' 
                        : 'bg-green-100 text-green-700'
                    }`}>
                      {job.status === 'pending' ? <Clock size={12} /> : <CheckCircle size={12} />}
                      {job.status === 'pending' ? 'Pending Review' : 'Live'}
                    </div>
                    <a 
                      href={job.link} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      className="p-2 hover:bg-gray-200 rounded-lg text-gray-400 hover:text-gray-700 transition-colors"
                      title="View External Link"
                    >
                      <ExternalLink size={20} />
                    </a>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </main>

      {/* Post Job Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div 
            className="absolute inset-0 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300"
            onClick={() => setIsModalOpen(false)}
          ></div>
          
          <div className="relative bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
            <div className="p-6 border-b flex justify-between items-center bg-gray-50/50">
              <h2 className="text-xl font-bold text-gray-800">Post New Job</h2>
              <button 
                onClick={() => setIsModalOpen(false)}
                className="p-2 hover:bg-gray-200 rounded-full transition-colors text-gray-500"
              >
                <X size={20} />
              </button>
            </div>

            <div className="p-6 max-h-[80vh] overflow-y-auto">
              {showSuccess ? (
                <div className="py-12 text-center animate-in zoom-in">
                  <div className="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <CheckCircle size={48} />
                  </div>
                  <h3 className="text-2xl font-bold text-gray-800">Successfully Posted!</h3>
                  <p className="text-gray-500 mt-2">Your job post is now pending admin approval.</p>
                </div>
              ) : (
                <form id="jobForm" onSubmit={handlePostJob} className="space-y-4">
                  <div className="grid grid-cols-1 gap-4">
                    <div>
                      <label className="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">Job Title*</label>
                      <input 
                        name="jobTitle" 
                        type="text" 
                        placeholder="e.g. Senior Product Designer" 
                        className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all bg-gray-50" 
                        required 
                      />
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">Company Name*</label>
                        <input 
                          name="companyName" 
                          type="text" 
                          placeholder="Your Company" 
                          className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-gray-50" 
                          required 
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">Location*</label>
                        <input 
                          name="jobPlace" 
                          type="text" 
                          placeholder="Remote / New York" 
                          className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-gray-50" 
                          required 
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">Company Logo URL</label>
                      <input 
                        name="companyLogo" 
                        type="url" 
                        placeholder="https://example.com/logo.png" 
                        className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-gray-50" 
                      />
                    </div>

                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">Salary Range</label>
                        <input 
                          name="salary" 
                          type="text" 
                          placeholder="e.g. $80k - $120k" 
                          className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-gray-50" 
                        />
                      </div>
                      <div>
                        <label className="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">Application Link*</label>
                        <input 
                          name="jobLink" 
                          type="url" 
                          placeholder="https://company.com/apply" 
                          className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-gray-50" 
                          required 
                        />
                      </div>
                    </div>

                    <div>
                      <label className="block text-xs font-bold uppercase tracking-wider text-gray-500 mb-1">Job Description*</label>
                      <textarea 
                        name="jobDescription" 
                        rows="4" 
                        placeholder="Briefly describe the role..." 
                        className="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none bg-gray-50" 
                        required
                      ></textarea>
                    </div>
                  </div>

                  <button 
                    type="submit" 
                    disabled={posting}
                    className={`w-full ${posting ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'} text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2`}
                  >
                    {posting ? (
                      <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                    ) : 'Publish Job Listing'}
                  </button>
                </form>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

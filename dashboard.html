import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import {
  getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
} from 'firebase/auth';
import {
  getFirestore, collection, query, where, onSnapshot,
  doc, setDoc, addDoc, updateDoc, deleteDoc, getDoc,
  Timestamp,
} from 'firebase/firestore';
import {
    Home, Briefcase, PlusCircle, User, Edit, Trash2, X, AlertTriangle, Loader, Save,
} from 'lucide-react';

// --- Global Variables Check (Mandatory Canvas Setup) ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-job-dashboard-app';
const firebaseConfig = typeof __firebase_config !== 'undefined'
  ? JSON.parse(__firebase_config)
  : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Utility Components ---

/** A simple, reusable button component. */
const Button = ({ children, onClick, icon: Icon, primary = true, disabled = false, className = '' }) => (
  <button
    onClick={onClick}
    disabled={disabled}
    className={`
      flex items-center justify-center space-x-2 px-4 py-2 text-sm font-semibold rounded-lg transition duration-150 ease-in-out shadow-md
      ${primary
        ? 'bg-indigo-600 text-white hover:bg-indigo-700 disabled:bg-indigo-400'
        : 'bg-white text-gray-700 border border-gray-300 hover:bg-gray-50 disabled:bg-gray-100'
      }
      ${className}
    `}
  >
    {Icon && <Icon className="w-5 h-5" />}
    <span>{children}</span>
  </button>
);

/** Custom Modal component. */
const Modal = ({ isOpen, onClose, title, children }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center p-5 border-b border-gray-100">
          <h2 className="text-xl font-bold text-gray-800">{title}</h2>
          <Button onClick={onClose} primary={false} icon={X} className="!p-2 !shadow-none hover:bg-red-50 hover:text-red-600 border-none" />
        </div>
        <div className="p-6">
          {children}
        </div>
      </div>
    </div>
  );
};


// --- Job Management Forms ---

/** Form for creating or editing a job. */
const JobForm = ({ db, auth, initialData, onClose, onSave }) => {
  const [formData, setFormData] = useState({
    title: initialData?.title || '',
    company: initialData?.company || '',
    location: initialData?.location || '',
    applyLink: initialData?.applyLink || '',
    description: initialData?.description || '',
    uid: auth.currentUser?.uid || '',
    ...initialData,
  });
  const [isSaving, setIsSaving] = useState(false);
  const isEditing = !!initialData?.id;

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({ ...prev, [name]: value }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!auth.currentUser) return console.error("Authentication required to post/edit job.");
    setIsSaving(true);
    
    // Ensure UID is set for security rules compliance
    const jobData = {
        ...formData,
        uid: auth.currentUser.uid,
        updatedAt: Timestamp.now(),
        // Only set createdAt for new jobs
        ...(isEditing ? {} : { createdAt: Timestamp.now() }),
    };

    try {
      if (isEditing) {
        // Update existing document
        const jobRef = doc(db, 'jobs', initialData.id);
        await updateDoc(jobRef, jobData);
        onSave('Job updated successfully!');
      } else {
        // Create new document
        await addDoc(collection(db, 'jobs'), jobData);
        onSave('New job posted successfully!');
      }
      onClose();
    } catch (error) {
      console.error("Error saving job:", error);
      alert(`Failed to save job: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <h3 className="text-lg font-semibold text-gray-700">{isEditing ? 'Edit Job Posting' : 'Post New Job'}</h3>
      
      <div>
        <label htmlFor="title" className="block text-sm font-medium text-gray-700">Job Title *</label>
        <input type="text" id="title" name="title" value={formData.title} onChange={handleChange} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" />
      </div>
      <div>
        <label htmlFor="company" className="block text-sm font-medium text-gray-700">Company *</label>
        <input type="text" id="company" name="company" value={formData.company} onChange={handleChange} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" />
      </div>
      <div>
        <label htmlFor="location" className="block text-sm font-medium text-gray-700">Location *</label>
        <input type="text" id="location" name="location" value={formData.location} onChange={handleChange} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" />
      </div>
      <div>
        <label htmlFor="applyLink" className="block text-sm font-medium text-gray-700">Apply Link *</label>
        <input type="url" id="applyLink" name="applyLink" value={formData.applyLink} onChange={handleChange} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" />
      </div>
      <div>
        <label htmlFor="description" className="block text-sm font-medium text-gray-700">Description</label>
        <textarea id="description" name="description" value={formData.description} onChange={handleChange} rows="4" className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
      </div>

      <div className="flex justify-end space-x-3 pt-2">
        <Button onClick={onClose} primary={false} type="button">Cancel</Button>
        <Button primary type="submit" disabled={isSaving} icon={isSaving ? Loader : Save} className={isSaving ? 'animate-pulse' : ''}>
          {isEditing ? (isSaving ? 'Updating...' : 'Save Changes') : (isSaving ? 'Posting...' : 'Post Job')}
        </Button>
      </div>
    </form>
  );
};


/** Form for editing the user profile. */
const ProfileForm = ({ db, auth, initialData, onClose, onSave }) => {
  const [name, setName] = useState(initialData?.name || '');
  const [isSaving, setIsSaving] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!auth.currentUser) return console.error("Authentication required to update profile.");
    setIsSaving(true);
    
    try {
      const userRef = doc(db, 'users', auth.currentUser.uid);
      await setDoc(userRef, { name, userId: auth.currentUser.uid }, { merge: true });
      onSave('Profile updated successfully!');
      onClose();
    } catch (error) {
      console.error("Error updating profile:", error);
      alert(`Failed to update profile: ${error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <h3 className="text-lg font-semibold text-gray-700">Edit Profile</h3>
      
      <div>
        <label htmlFor="name" className="block text-sm font-medium text-gray-700">Your Name</label>
        <input type="text" id="name" name="name" value={name} onChange={(e) => setName(e.target.value)} required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" />
      </div>

      <div className="flex justify-end space-x-3 pt-2">
        <Button onClick={onClose} primary={false} type="button">Cancel</Button>
        <Button primary type="submit" disabled={isSaving} icon={isSaving ? Loader : Save} className={isSaving ? 'animate-pulse' : ''}>
          {isSaving ? 'Saving...' : 'Save Profile'}
        </Button>
      </div>
    </form>
  );
};


// --- Main Application Component ---

const App = () => {
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  const [userProfile, setUserProfile] = useState(null);
  const [jobs, setJobs] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showJobModal, setShowJobModal] = useState(false);
  const [editingJob, setEditingJob] = useState(null);
  const [showProfileModal, setShowProfileModal] = useState(false);
  const [message, setMessage] = useState(null);

  // 1. Firebase Initialization and Authentication
  useEffect(() => {
    if (!firebaseConfig) {
        console.error("Firebase config is missing.");
        setIsLoading(false);
        return;
    }
    
    try {
      const app = initializeApp(firebaseConfig);
      const firestore = getFirestore(app);
      const authInstance = getAuth(app);
      setDb(firestore);
      setAuth(authInstance);

      // Listen for auth state changes
      const unsubscribe = onAuthStateChanged(authInstance, (user) => {
        if (user) {
          setUserId(user.uid);
        } else {
          setUserId(null);
        }
        setIsAuthReady(true);
        setIsLoading(false);
      });

      // Sign in with custom token or anonymously
      const signIn = async () => {
        try {
          if (initialAuthToken) {
            await signInWithCustomToken(authInstance, initialAuthToken);
          } else {
            // Sign in anonymously if no token is provided
            await signInAnonymously(authInstance);
          }
        } catch (error) {
          console.error("Firebase sign-in failed:", error);
          setIsAuthReady(true); // Still set ready even on failure
          setIsLoading(false);
        }
      };
      
      signIn();
      return () => unsubscribe();

    } catch (error) {
        console.error("Firebase initialization failed:", error);
        setIsLoading(false);
    }
  }, []);

  // 2. Data Fetching (Profile and Jobs)
  useEffect(() => {
    if (!isAuthReady || !db || !userId) return;

    // --- Fetch User Profile ---
    const userRef = doc(db, 'users', userId);
    const unsubProfile = onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
            setUserProfile({ id: docSnap.id, ...docSnap.data() });
        } else {
            // If profile doesn't exist, set a default
            setUserProfile({ id: userId, name: 'New User', userId });
        }
    }, (error) => console.error("Error fetching user profile:", error));


    // --- Fetch User's Posted Jobs ---
    const jobsRef = collection(db, 'jobs');
    // Query for jobs where the 'uid' matches the current user's ID
    const q = query(jobsRef, where('uid', '==', userId));
    
    const unsubJobs = onSnapshot(q, (snapshot) => {
        const postedJobs = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data(),
        }));
        // Sort jobs by creation date (newest first)
        postedJobs.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
        setJobs(postedJobs);
    }, (error) => console.error("Error fetching jobs:", error));

    return () => {
        unsubProfile();
        unsubJobs();
    };

  }, [db, userId, isAuthReady]); // Re-run when DB, User ID, or Auth readiness changes

  // Helper to display transient messages
  const handleMessage = (msg) => {
    setMessage(msg);
    setTimeout(() => setMessage(null), 4000);
  };

  // --- Job CRUD Operations ---
  const handleEditJob = (job) => {
    setEditingJob(job);
    setShowJobModal(true);
  };

  const handleDeleteJob = async (jobId) => {
    if (!window.confirm('Are you sure you want to delete this job posting? This cannot be undone.')) return;
    
    try {
      await deleteDoc(doc(db, 'jobs', jobId));
      handleMessage('Job deleted successfully!');
    } catch (error) {
      console.error("Error deleting job:", error);
      alert(`Failed to delete job: ${error.message}`);
    }
  };

  const handleCloseJobModal = () => {
    setShowJobModal(false);
    setEditingJob(null);
  };

  // --- UI Rendering Logic ---

  if (isLoading || !isAuthReady) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-50">
        <div className="flex flex-col items-center space-y-4 p-8 bg-white rounded-xl shadow-lg">
            <Loader className="w-8 h-8 text-indigo-500 animate-spin" />
            <p className="text-gray-600 font-medium">Authenticating and loading dashboard...</p>
        </div>
      </div>
    );
  }

  // Fallback if DB/Auth somehow failed to initialize
  if (!db || !auth || !userId) {
    return (
        <div className="flex items-center justify-center min-h-screen bg-gray-50">
            <div className="flex flex-col items-center space-y-4 p-8 bg-white rounded-xl shadow-lg border border-red-300">
                <AlertTriangle className="w-8 h-8 text-red-500" />
                <h1 className="text-xl font-bold text-red-700">Initialization Error</h1>
                <p className="text-gray-600 text-center">
                    The application failed to initialize Firebase or authenticate the user. Please check the console for details.
                </p>
                <code className="text-sm bg-gray-100 p-2 rounded">User ID: {userId || 'N/A'}</code>
            </div>
        </div>
    );
  }

  const displayName = userProfile?.name || 'Loading Name...';
  
  return (
    <div className="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8 font-[Inter]">
      
      {/* Transient Message Alert */}
      {message && (
        <div className="fixed top-4 right-4 z-50 p-4 bg-green-500 text-white rounded-lg shadow-xl animate-bounce-in">
          {message}
        </div>
      )}

      <div className="max-w-4xl mx-auto">
        
        {/* Header and User Info */}
        <header className="bg-white p-6 rounded-xl shadow-lg mb-8 flex justify-between items-center flex-wrap gap-4">
          <div className="flex items-center space-x-4">
            <User className="w-8 h-8 text-indigo-600" />
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Welcome, {displayName}</h1>
              <p className="text-sm text-gray-500">
                <span className="font-semibold">User ID:</span> {userId}
              </p>
            </div>
          </div>
          
          <div className="flex space-x-3">
            <Button
              onClick={() => setShowProfileModal(true)}
              primary={false}
              icon={Edit}
              className="border-indigo-500 text-indigo-600 hover:bg-indigo-50"
            >
              Edit Profile
            </Button>
            <Button
              onClick={() => { setShowJobModal(true); setEditingJob(null); }}
              icon={PlusCircle}
            >
              Post New Job
            </Button>
          </div>
        </header>

        {/* Profile Management Section */}
        <section className="bg-white p-6 rounded-xl shadow-lg mb-8 border-l-4 border-indigo-500">
            <h2 className="text-xl font-semibold text-gray-800 flex items-center space-x-2 mb-2">
                <User className="w-5 h-5" />
                <span>Profile Management</span>
            </h2>
            <p className="text-gray-600">
                Keep your profile up-to-date. Current Name: <span className="font-medium text-indigo-600">{displayName}</span>
            </p>
            
            <Modal
              isOpen={showProfileModal}
              onClose={() => setShowProfileModal(false)}
              title="Manage Your Profile"
            >
              <ProfileForm 
                db={db}
                auth={auth}
                initialData={userProfile}
                onClose={() => setShowProfileModal(false)}
                onSave={handleMessage}
              />
            </Modal>
        </section>

        {/* Posted Jobs List */}
        <section className="bg-white p-6 rounded-xl shadow-lg">
          <h2 className="text-xl font-semibold text-gray-800 flex items-center space-x-2 mb-4 pb-2 border-b">
            <Briefcase className="w-5 h-5" />
            <span>Your Posted Jobs ({jobs.length})</span>
          </h2>

          {jobs.length === 0 ? (
            <div className="text-center py-10 text-gray-500">
              <PlusCircle className="w-10 h-10 mx-auto mb-3 text-indigo-200" />
              <p>You haven't posted any jobs yet. Click "Post New Job" to start!</p>
            </div>
          ) : (
            <div className="space-y-4">
              {jobs.map(job => (
                <div key={job.id} className="p-4 border border-gray-100 rounded-lg hover:shadow-md transition duration-150 flex justify-between items-center bg-white">
                  <div>
                    <h3 className="text-lg font-bold text-gray-800">{job.title}</h3>
                    <p className="text-sm text-gray-600">{job.company} - {job.location}</p>
                    <a 
                        href={job.applyLink} 
                        target="_blank" 
                        rel="noopener noreferrer" 
                        className="text-indigo-500 hover:text-indigo-700 text-xs mt-1 block truncate w-64"
                    >
                        {job.applyLink}
                    </a>
                  </div>
                  <div className="flex space-x-2">
                    <Button 
                      onClick={() => handleEditJob(job)} 
                      primary={false} 
                      icon={Edit}
                      className="!p-2 text-indigo-600 hover:bg-indigo-50"
                    />
                    <Button 
                      onClick={() => handleDeleteJob(job.id)} 
                      primary={false} 
                      icon={Trash2}
                      className="!p-2 text-red-600 hover:bg-red-50"
                    />
                  </div>
                </div>
              ))}
            </div>
          )}
        </section>

        {/* Job Post/Edit Modal */}
        <Modal
          isOpen={showJobModal}
          onClose={handleCloseJobModal}
          title={editingJob ? 'Edit Job Posting' : 'Post a New Job'}
        >
          <JobForm 
            db={db}
            auth={auth}
            initialData={editingJob}
            onClose={handleCloseJobModal}
            onSave={handleMessage}
          />
        </Modal>

      </div>
    </div>
  );
};

export default App;

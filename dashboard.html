<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard - BooterSpace Job Portal</title>

<script src="https://cdn.tailwindcss.com"></script>
<!-- Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }

.popup-overlay {
	position: fixed;
	inset: 0;
	background: rgba(0,0,0,0.7);
	display: none;
	align-items: center;
	justify-content: center;
	z-index: 50;
	backdrop-filter: blur(3px);
	overflow-y: auto;
	padding: 20px 0;
}
.popup {
	background: white;
	border-radius: 1rem;
	box-shadow: 0 15px 30px rgba(0,0,0,0.3);
	padding: 2rem;
	width: 95%;
	max-width: 600px;
	margin: auto;
	animation: fadeIn 0.3s ease-in-out;
}
@keyframes fadeIn {
	from { transform: scale(0.9); opacity: 0; }
	to { transform: scale(1); opacity: 1; }
}
.preview-img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
.clear-both { clear: both; }
</style>
</head>
<body class="bg-gray-100">

<!-- Navbar Container (optional) -->
<div id="navbarContainer"></div>

<script>
  // optional: load navbar if file exists
  fetch('navbar.html').then(r => {
    if (!r.ok) throw new Error('no navbar');
    return r.text();
  }).then(html => {
    document.getElementById('navbarContainer').innerHTML = html;
  }).catch(()=> {
    // no navbar ‚Äî that's fine
    document.getElementById('navbarContainer').innerHTML = `
      <nav class="bg-white shadow p-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
          <a href="index.html" class="font-bold text-xl">KARDAN</a>
          <div>
            <button id="logoutBtn" class="bg-red-500 text-white px-3 py-1 rounded">Logout</button>
          </div>
        </div>
      </nav>
    `;
  });
</script>

<!-- Header -->
<section class="text-center my-6">
	<h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
	<p class="text-gray-500 mt-1">üëã Welcome, <span id="userName" class="font-semibold text-gray-800">Loading...</span></p>
	<p id="userEmail" class="text-gray-500 text-sm"></p>
</section>

<!-- Main Layout -->
<div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-6 px-4 mb-16">
	<!-- Left -->
	<div class="md:w-1/3 space-y-4">
		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-blue-600 mb-2">Your Applications</h4>
			<p class="text-gray-500">You haven‚Äôt applied for any jobs yet.</p>
			<a href="jobs.html" class="mt-2 inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-150">+ Find Jobs</a>
		</div>

		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-red-600 mb-2">Saved Jobs</h4>
			<p class="text-gray-500">No saved jobs yet.</p>
			<a href="jobs.html" class="mt-2 inline-block bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-150">üîç Browse Listings</a>
		</div>

		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-green-600 mb-2">Profile Management</h4>
			<p class="text-gray-500">Keep your profile up-to-date.</p>
			<button id="profileBtn" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-150">‚úèÔ∏è Edit Profile</button>
		</div>

		<div class="bg-white shadow rounded-xl p-5 text-center">
			<h4 class="text-lg font-semibold text-yellow-600 mb-2">Post a New Job</h4>
			<p class="text-gray-500">Share opportunities with others.</p>
			<button id="postJobBtn" class="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-150">üìù Post Job</button>
		</div>
	</div>

	<!-- Right -->
	<div id="postedJobsSection" class="md:w-2/3 bg-white p-6 rounded-xl shadow">
		<h4 class="font-bold text-2xl text-gray-800 mb-4">üìã Your Posted Jobs</h4>
		<div id="jobsList" class="space-y-4 text-sm text-gray-700">
			<p class='text-gray-500 text-center py-8'>Loading jobs...</p>
		</div>
		<!-- Load More Button Container -->
		<div id="loadMoreContainer" class="text-center pt-4" style="display:none;">
			<button id="loadMoreBtn" onclick="loadMoreJobs()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold shadow-md">
				Load More Jobs (0 remaining)
			</button>
		</div>
	</div>
</div>

<!-- Profile Popup -->
<div id="profilePopup" class="popup-overlay">
	<div class="popup">
		<h3 class="text-xl font-bold mb-4 text-center text-gray-800">üë§ Edit Profile</h3>
		<form id="profileForm" class="space-y-3">
			<div><label class="block mb-1 font-medium">Full Name</label><input type="text" id="profileName" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Email</label><input type="email" id="profileEmail" class="w-full border rounded-lg p-2 bg-gray-100" disabled /></div>
			<div><label class="block mb-1 font-medium">Experience</label><input type="text" id="profileExperience" class="w-full border rounded-lg p-2" placeholder="e.g., 2 years in Sales" /></div>
			<div><label class="block mb-1 font-medium">Education</label><input type="text" id="profileEducation" class="w-full border rounded-lg p-2" placeholder="e.g., B.Tech, XYZ University" /></div>
			<div class="flex justify-between pt-3">
				<button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üíæ Save Changes</button>
				<button type="button" id="closeProfilePopupBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
			</div>
		</form>
	</div>
</div>

<!-- Post Job Popup -->
<div id="postJobPopup" class="popup-overlay">
	<div class="popup">
		<h3 class="text-xl font-bold mb-4 text-center text-gray-800">üìù Post a New Job</h3>
		<form id="postJobForm" class="space-y-3">
			<div><label class="block mb-1 font-medium">Job Title</label><input type="text" id="jobTitle" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Company Name</label><input type="text" id="jobCompanyName" class="w-full border rounded-lg p-2" required /></div>
			<div>
				<label class="block mb-1 font-medium">Employment Type</label>
				<select id="jobEmploymentType" class="w-full border rounded-lg p-2" required>
					<option value="">Select Type *</option>
					<option value="Full-time">Full-time</option>
					<option value="Part-time">Part-time</option>
					<option value="Internship">Internship</option>
				</select>
			</div>
			<div><label class="block mb-1 font-medium">Salary Range (Optional)</label><input type="text" id="jobSalary" class="w-full border rounded-lg p-2" /></div>
			<div><label class="block mb-1 font-medium">Location</label><input type="text" id="jobLocation" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Application Link</label><input type="url" id="jobApplyLink" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Company Logo URL (Optional)</label><input type="url" id="jobCompanyImageUrl" class="w-full border rounded-lg p-2" /></div>
			<div><label class="block mb-1 font-medium">Job Header Image URL (Optional)</label><input type="url" id="jobJobImageUrl" class="w-full border rounded-lg p-2" /></div>
			<div><label class="block mb-1 font-medium">Job Details / Description</label><textarea id="jobDetails" rows="5" class="w-full border rounded-lg p-2" required></textarea></div>
			<div class="flex justify-between pt-3">
				<button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">üöÄ Publish Job</button>
							<button type="button" id="closeJobPostPopupBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
			</div>
		</form>
	</div>
</div>


  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
      authDomain: "kar-kardan.firebaseapp.com",
      projectId: "kar-kardan",
      storageBucket: "kar-kardan.appspot.com",
      messagingSenderId: "554147696994",
      appId: "1:554147696994:web:221dcb883e3b65dcea5c3b",
      measurementId: "G-RRC3X485KQ"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
      } else {
        alert("‚ö†Ô∏è You must be logged in to post a job.");
        window.location.href = "login.html";
      }
    });

    document.getElementById("publishBtn").addEventListener("click", async function () {
      if (!currentUser) return;

      const jobTitle = document.getElementById("jobTitle").value.trim();
      const companyName = document.getElementById("companyName").value.trim();
      const companyLogo = document.getElementById("companyLogo").value.trim() || null;
      const jobPlace = document.getElementById("jobPlace").value.trim();
      const salary = document.getElementById("salary").value.trim() || null;
      const jobLink = document.getElementById("jobLink").value.trim();
      const jobDescription = document.getElementById("jobDescription").value.trim();

      if (!jobTitle || !companyName || !jobPlace || !jobLink || !jobDescription) {
        alert("Please fill in all required fields.");
        return;
      }

      try {
        await db.collection("jobs").add({
          uid: currentUser.uid,
          title: jobTitle,
          company: companyName,
          logoUrl: companyLogo,
          location: jobPlace,
          salary: salary,
          applyLink: jobLink,
          about: jobDescription,
          postedBy: currentUser.email || "Anonymous",
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          dislikes: 0
        });

        document.getElementById("successMessage").classList.remove("hidden");
        document.getElementById("jobForm").reset();
      } catch (error) {
        console.error("Error posting job:", error);
        alert("Failed to post job. Check console for details.");
      }
    });
  </script>

<!-- Edit Job Popup -->
<div id="editJobPopup" class="popup-overlay">
	<div class="popup">
		<h3 class="text-xl font-bold mb-4 text-center text-gray-800">‚úçÔ∏è Edit Job Posting</h3>
		<form id="editJobForm" class="space-y-3">
			<input type="hidden" id="editJobId" />
			<div><label class="block mb-1 font-medium">Job Title</label><input type="text" id="editJobTitle" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Company Name</label><input type="text" id="editJobCompanyName" class="w-full border rounded-lg p-2" required /></div>
			<div>
				<label class="block mb-1 font-medium">Employment Type</label>
				<select id="editJobEmploymentType" class="w-full border rounded-lg p-2" required>
					<option value="">Select Type *</option>
					<option value="Full-time">Full-time</option>
					<option value="Part-time">Part-time</option>
					<option value="Internship">Internship</option>
				</select>
			</div>
			<div><label class="block mb-1 font-medium">Salary Range (Optional)</label><input type="text" id="editJobSalary" class="w-full border rounded-lg p-2" /></div>
			<div><label class="block mb-1 font-medium">Location</label><input type="text" id="editJobLocation" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Application Link</label><input type="url" id="editJobApplyLink" class="w-full border rounded-lg p-2" required /></div>
			<div><label class="block mb-1 font-medium">Company Logo URL (Optional)</label><input type="url" id="editJobCompanyImageUrl" class="w-full border rounded-lg p-2" /></div>
			<div><label class="block mb-1 font-medium">Job Header Image URL (Optional)</label><input type="url" id="editJobJobImageUrl" class="w-full border rounded-lg p-2" /></div>
			<div><label class="block mb-1 font-medium">Job Details / Description</label><textarea id="editJobDetails" rows="5" class="w-full border rounded-lg p-2" required></textarea></div>
			<div class="flex justify-between pt-3">
				<button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">‚úÖ Update Job</button>
				<button type="button" id="closeEditJobPopupBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
			</div>
		</form>
	</div>
</div>

<!-- Post Success Popup -->
<div id="jobSuccessPopup" class="popup-overlay">
	<div class="popup text-center max-w-sm">
		<h3 class="text-2xl font-bold mb-2 text-gray-800">Job Posted!</h3>
		<p class="text-gray-600 mb-6">Your job, "<span id="successJobTitle" class="font-semibold text-indigo-600"></span>", has been published.</p>
		<div class="flex justify-center gap-3 pt-3">
			<button id="successEditBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">‚úèÔ∏è Edit</button>
			<button id="successDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">üóëÔ∏è Delete</button>
			<button id="successOkBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">üëå OK</button>
		</div>
	</div>
</div>

<!-- Update Success Popup -->
<div id="jobUpdateSuccessPopup" class="popup-overlay">
	<div class="popup text-center max-w-sm">
		<h3 class="text-2xl font-bold mb-2 text-gray-800">Job Updated!</h3>
		<p class="text-gray-600 mb-6">Your job, "<span id="updateSuccessJobTitle" class="font-semibold text-indigo-600"></span>", has been successfully modified.</p>
		<div class="flex justify-center pt-3">
			<button id="updateSuccessOkBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">üëå Close</button>
		</div>
	</div>
</div>

<!-- Footer -->
<footer class="text-center text-gray-500 py-4 text-sm">
	¬© 2025 BooterSpace Job Portal | <a href="#" class="underline">Privacy</a> | <a href="#" class="underline">Terms</a>
</footer>

<!-- ---- Main JS ---- -->
<script>
/* =========================
   Firebase config - replace with your actual config if different
   ========================= */
const firebaseConfig = {
	apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
	authDomain: "kar-kardan.firebaseapp.com",
	projectId: "kar-kardan",
	storageBucket: "kar-kardan.firebasestorage.app",
	messagingSenderId: "554147696994",
	appId: "1:554147696994:web:221dcb883e3b65dcea5c3b",
	measurementId: "G-RRC3X485KQ"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* -------------------------
   State & Element refs
   ------------------------- */
let allJobs = [];
const JOB_LIMIT = 10;
let jobsToShow = JOB_LIMIT;

const jobSuccessPopup = document.getElementById('jobSuccessPopup');
const successJobTitleSpan = document.getElementById('successJobTitle');
const successEditBtn = document.getElementById('successEditBtn');
const successDeleteBtn = document.getElementById('successDeleteBtn');
const successOkBtn = document.getElementById('successOkBtn');

const jobUpdateSuccessPopup = document.getElementById('jobUpdateSuccessPopup');
const updateSuccessJobTitleSpan = document.getElementById('updateSuccessJobTitle');
const updateSuccessOkBtn = document.getElementById('updateSuccessOkBtn');

/* -------------------------
   Utility: Safe element getter
   ------------------------- */
function $id(id) { return document.getElementById(id); }

/* -------------------------
   Auth & Init
   ------------------------- */
auth.onAuthStateChanged(user => {
	if (!user) {
		// redirect to login if not logged in
		// if you want to allow anonymous view, remove this
		window.location.href = 'login.html';
		return;
	}
	loadProfile(user);
	loadJobs(user.uid);
});

/* -------------------------
   Logout (guarded)
   ------------------------- */
const logoutBtn = $id('logoutBtn');
if (logoutBtn) {
	logoutBtn.addEventListener('click', () => {
		auth.signOut().then(() => window.location.href = 'login.html').catch(err => console.error('Logout error', err));
	});
}

/* -------------------------
   Profile: load & update
   ------------------------- */
function loadProfile(user) {
	try {
		const uid = user.uid;
		if ($id('profileEmail')) $id('profileEmail').value = user.email || '';

		db.collection('users').doc(uid).get().then(doc => {
			let displayName = (user.email || '').split('@')[0];
			let fullName = '';

			if (doc.exists) {
				const data = doc.data();
				fullName = data.fullName || '';
				displayName = fullName || displayName;

				if ($id('profileName')) $id('profileName').value = fullName;
				if ($id('profileExperience')) $id('profileExperience').value = data.experience || '';
				if ($id('profileEducation')) $id('profileEducation').value = data.education || '';
			}

			if ($id('userName')) $id('userName').innerText = displayName;
			if ($id('userEmail')) $id('userEmail').innerText = user.email || '';
		}).catch(err => {
			console.error('Load profile error', err);
			if ($id('userName')) $id('userName').innerText = user.displayName || (user.email || '').split('@')[0];
			if ($id('userEmail')) $id('userEmail').innerText = user.email || '';
		});
	} catch (err) {
		console.error('loadProfile exception', err);
	}
}

// Profile popup controls
const profilePopup = $id('profilePopup');
const profileBtn = $id('profileBtn');
const closeProfilePopupBtn = $id('closeProfilePopupBtn');

if (profileBtn) profileBtn.onclick = () => profilePopup.style.display = 'flex';
if (closeProfilePopupBtn) closeProfilePopupBtn.onclick = () => profilePopup.style.display = 'none';

$id('profileForm').addEventListener('submit', async (e) => {
	e.preventDefault();
	const user = auth.currentUser;
	if (!user) return;

	const newFullName = $id('profileName').value;

	try {
		await db.collection('users').doc(user.uid).set({
			fullName: newFullName,
			email: user.email,
			experience: $id('profileExperience').value,
			education: $id('profileEducation').value
		}, { merge: true });

		// update auth displayName (compat)
		if (user.updateProfile) {
			await user.updateProfile({ displayName: newFullName }).catch(()=>{ /* ignore if not supported */ });
		}

		loadProfile(auth.currentUser);
		profilePopup.style.display = 'none';
		console.log('Profile updated');
	} catch (err) {
		console.error('Profile update failed', err);
	}
});

/* -------------------------
   Post Job logic
   ------------------------- */
const postJobPopup = $id('postJobPopup');
const postJobBtn = $id('postJobBtn');
const closeJobPostPopupBtn = $id('closeJobPostPopupBtn');

if (postJobBtn) postJobBtn.onclick = () => postJobPopup.style.display = 'flex';
if (closeJobPostPopupBtn) closeJobPostPopupBtn.onclick = () => postJobPopup.style.display = 'none';

$id('postJobForm').addEventListener('submit', async (e) => {
	e.preventDefault();
	const user = auth.currentUser;
	if (!user) return console.error('Not logged in');

	const jobTitle = $id('jobTitle').value || 'Untitled role';
	const jobData = {
		title: jobTitle,
		companyName: $id('jobCompanyName').value || '',
		employmentType: $id('jobEmploymentType').value || '',
		salary: $id('jobSalary').value || '',
		location: $id('jobLocation').value || '',
		applyLink: $id('jobApplyLink').value || '',
		companyImageUrl: $id('jobCompanyImageUrl').value || '',
		jobImageUrl: $id('jobJobImageUrl').value || '',
		details: $id('jobDetails').value || '',
		postedBy: user.uid,
		timestamp: firebase.firestore.FieldValue.serverTimestamp()
	};

	try {
		const docRef = await db.collection('jobs').add(jobData);
		postJobPopup.style.display = 'none';
		$id('postJobForm').reset();
		console.log('Job posted', docRef.id);
		showJobSuccessPopup(docRef.id, jobTitle);
	} catch (err) {
		console.error('Error posting job', err);
	}
});

/* -------------------------
   Edit Job logic
   ------------------------- */
const editJobPopup = $id('editJobPopup');
const closeEditJobPopupBtn = $id('closeEditJobPopupBtn');

if (closeEditJobPopupBtn) closeEditJobPopupBtn.onclick = () => editJobPopup.style.display = 'none';

window.openEditJobPopup = async (jobId) => {
	try {
		const doc = await db.collection('jobs').doc(jobId).get();
		if (!doc.exists) return console.error('Job not found', jobId);
		const job = doc.data();

		$id('editJobId').value = jobId;
		$id('editJobTitle').value = job.title || '';
		$id('editJobCompanyName').value = job.companyName || '';
		$id('editJobEmploymentType').value = job.employmentType || '';
		$id('editJobSalary').value = job.salary || '';
		$id('editJobLocation').value = job.location || '';
		$id('editJobApplyLink').value = job.applyLink || '';
		$id('editJobCompanyImageUrl').value = job.companyImageUrl || '';
		$id('editJobJobImageUrl').value = job.jobImageUrl || '';
		$id('editJobDetails').value = job.details || '';

		editJobPopup.style.display = 'flex';
	} catch (err) {
		console.error('openEditJobPopup error', err);
	}
};

$id('editJobForm').addEventListener('submit', async (e) => {
	e.preventDefault();
	const jobId = $id('editJobId').value;
	if (!jobId) return;

	const jobTitle = $id('editJobTitle').value || 'Untitled role';
	const updatedData = {
		title: jobTitle,
		companyName: $id('editJobCompanyName').value || '',
		employmentType: $id('editJobEmploymentType').value || '',
		salary: $id('editJobSalary').value || '',
		location: $id('editJobLocation').value || '',
		applyLink: $id('editJobApplyLink').value || '',
		companyImageUrl: $id('editJobCompanyImageUrl').value || '',
		jobImageUrl: $id('editJobJobImageUrl').value || '',
		details: $id('editJobDetails').value || ''
	};

	try {
		await db.collection('jobs').doc(jobId).update(updatedData);
		editJobPopup.style.display = 'none';
		console.log('Job updated');
		showJobUpdateSuccessPopup(jobTitle);
	} catch (err) {
		console.error('Update failed', err);
	}
});

/* -------------------------
   Success popups control
   ------------------------- */
function showJobSuccessPopup(jobId, jobTitle) {
	if (successJobTitleSpan) successJobTitleSpan.innerText = jobTitle;
	if (jobSuccessPopup) jobSuccessPopup.style.display = 'flex';

	// unbind previous
	successEditBtn.onclick = null;
	successDeleteBtn.onclick = null;

	successEditBtn.onclick = () => {
		if (jobSuccessPopup) jobSuccessPopup.style.display = 'none';
		window.openEditJobPopup(jobId);
	};
	successDeleteBtn.onclick = () => deleteJob(jobId);
}

successOkBtn && (successOkBtn.onclick = () => { if (jobSuccessPopup) jobSuccessPopup.style.display = 'none'; });

function showJobUpdateSuccessPopup(jobTitle) {
	if (updateSuccessJobTitleSpan) updateSuccessJobTitleSpan.innerText = jobTitle;
	if (jobUpdateSuccessPopup) jobUpdateSuccessPopup.style.display = 'flex';
}
updateSuccessOkBtn && (updateSuccessOkBtn.onclick = () => { if (jobUpdateSuccessPopup) jobUpdateSuccessPopup.style.display = 'none'; });

/* -------------------------
   Delete job
   ------------------------- */
async function deleteJob(jobId) {
	try {
		const ok = confirm('Are you sure you want to delete this job post?');
		if (!ok) return;
		await db.collection('jobs').doc(jobId).delete();
		console.log('Deleted', jobId);
		// Close popups if open
		if (jobSuccessPopup) jobSuccessPopup.style.display = 'none';
		if (jobUpdateSuccessPopup) jobUpdateSuccessPopup.style.display = 'none';
	} catch (err) {
		console.error('Delete failed', err);
	}
}

/* -------------------------
   Pagination & Rendering
   ------------------------- */
window.loadMoreJobs = function() {
	jobsToShow = Math.min(allJobs.length, jobsToShow + JOB_LIMIT);
	renderJobs();
};

function renderJobs() {
	const jobsList = $id('jobsList');
	const loadMoreContainer = $id('loadMoreContainer');
	const loadMoreBtn = $id('loadMoreBtn');

	if (!jobsList) return;

	jobsList.innerHTML = '';

	const jobsToRender = allJobs.slice(0, jobsToShow);

	if (jobsToRender.length === 0 && allJobs.length === 0) {
		jobsList.innerHTML = "<p class='text-gray-500 text-center py-8'>No jobs posted yet. Use the 'Post Job' button to share an opportunity!</p>";
		if (loadMoreContainer) loadMoreContainer.style.display = 'none';
		return;
	}

	jobsToRender.forEach(job => {
		const div = document.createElement('div');
		div.className = "border p-3 rounded-lg shadow-sm bg-gray-50 flex justify-between items-center hover:shadow-md transition duration-200";

		const datePosted = job.timestamp && job.timestamp.toDate ? safeDate(job.timestamp) : 'Date N/A';
		div.innerHTML = `
			<div class="flex-grow">
				<h5 class="font-semibold text-lg text-gray-800">${escapeHtml(job.title || 'Untitled')}</h5>
				<p class="text-gray-600 text-sm">@ ${escapeHtml(job.companyName || 'N/A')} | ${escapeHtml(job.location || 'N/A')}</p>
				<p class="text-xs text-gray-400 mt-1">Posted on: ${datePosted}</p>
			</div>
			<div class="flex gap-2">
				<button data-job-id="${job.id}" data-action="edit" class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-lg hover:bg-blue-200 transition">‚úèÔ∏è Edit</button>
				<button data-job-id="${job.id}" data-action="delete" class="text-sm bg-red-100 text-red-700 px-3 py-1 rounded-lg hover:bg-red-200 transition">üóëÔ∏è Delete</button>
			</div>
		`;
		jobsList.appendChild(div);
	});

	// load more visibility
	if (allJobs.length > jobsToShow) {
		if (loadMoreContainer) loadMoreContainer.style.display = 'block';
		if (loadMoreBtn) loadMoreBtn.innerText = `Load More Jobs (${allJobs.length - jobsToShow} remaining)`;
	} else {
		if (loadMoreContainer) loadMoreContainer.style.display = 'none';
	}

	// attach listeners (delegated style)
	jobsList.querySelectorAll('button[data-action]').forEach(btn => {
		btn.onclick = (e) => {
			const action = btn.dataset.action;
			const jobId = btn.dataset.jobId;
			if (action === 'edit') openEditJobPopup(jobId);
			if (action === 'delete') deleteJob(jobId);
		};
	});
}

/* -------------------------
   Load jobs for current user
   ------------------------- */
function loadJobs(uid) {
	const jobsList = $id('jobsList');
	if (jobsList) jobsList.innerHTML = "<p class='text-gray-500 text-center py-8'>Loading jobs...</p>";

	const jobQuery = db.collection('jobs').where('postedBy', '==', uid);

	// Use onSnapshot to keep real-time updates
	jobQuery.onSnapshot(snapshot => {
		if (snapshot.empty) {
			allJobs = [];
			jobsToShow = JOB_LIMIT;
			renderJobs();
			return;
		}

		const jobsArray = [];
		snapshot.forEach(doc => {
			jobsArray.push({ id: doc.id, ...doc.data() });
		});

		// sort descending by timestamp (newest first)
		jobsArray.sort((a, b) => {
			const ta = a.timestamp && a.timestamp.toDate ? a.timestamp.toDate().getTime() : 0;
			const tb = b.timestamp && b.timestamp.toDate ? b.timestamp.toDate().getTime() : 0;
			return tb - ta;
		});

		allJobs = jobsArray;
		// reset jobsToShow smartly: if current count > total, set to at least JOB_LIMIT or total
		if (jobsToShow > allJobs.length) {
			jobsToShow = Math.max(JOB_LIMIT, Math.min(allJobs.length, JOB_LIMIT));
		}
		// ensure at least show JOB_LIMIT or less if not enough
		jobsToShow = Math.min(Math.max(jobsToShow, JOB_LIMIT), allJobs.length || JOB_LIMIT);

		renderJobs();
	}, err => {
		console.error('jobs onSnapshot error', err);
		if (jobsList) jobsList.innerHTML = "<p class='text-red-500 text-center py-8'>Error loading jobs. Check console for details.</p>";
		if ($id('loadMoreContainer')) $id('loadMoreContainer').style.display = 'none';
	});
}

/* -------------------------
   Helpers
   ------------------------- */
function safeDate(ts) {
	try {
		const d = ts.toDate ? ts.toDate() : new Date(ts);
		return d.toLocaleDateString();
	} catch {
		return 'Date N/A';
	}
}

// minimal html escaping to avoid injection in innerHTML
function escapeHtml(str) {
	if (!str) return '';
	return String(str).replace(/[&<>"']/g, function (s) {
		return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[s];
	});
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KARDAN Admin Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .nav-btn.active { border-color: #4f46e5; background-color: #f5f3ff; color: #4f46e5; }
    .nav-btn.active .badge { background-color: #4f46e5; color: white; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.7); z-index: 50; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(8px); }
    .modal.active { display: flex; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<!-- AUTH MODAL -->
<div id="loginDiv" class="fixed inset-0 bg-white z-50 flex items-center justify-center p-4">
  <div class="w-full max-w-md space-y-8">
    <div class="text-center">
      <h1 class="text-4xl font-black text-indigo-600 tracking-tighter">KARDAN</h1>
      <p class="text-slate-500 mt-2 font-medium">Administrator Authentication</p>
    </div>
    <div class="bg-white p-8 rounded-3xl shadow-2xl border border-slate-100 space-y-4">
      <input id="email" type="email" placeholder="Admin Email" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all"/>
      <input id="password" type="password" placeholder="Password" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all"/>
      <button id="loginBtn" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 active:scale-[0.98] transition-all shadow-lg shadow-indigo-200">Verify Identity</button>
      <p id="loginError" class="text-red-500 text-xs text-center font-bold"></p>
    </div>
  </div>
</div>

<!-- MAIN DASHBOARD -->
<div id="adminDiv" class="hidden opacity-0 transition-opacity duration-500">
  <header class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-30 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200">
          <span class="text-white font-black">K</span>
        </div>
        <div>
          <h2 class="font-black text-slate-800 leading-none">KARDAN HQ</h2>
          <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">Master Terminal</p>
        </div>
      </div>
      <button id="logoutBtn" class="text-xs font-black text-slate-400 hover:text-red-500 transition-colors uppercase tracking-widest">Terminate Session</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- NAVIGATION TABS -->
    <div id="tabContainer" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-3 mb-8">
      <!-- Tabs injected via JS -->
    </div>

    <!-- CONTENT AREA -->
    <div id="content" class="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-100 p-8 min-h-[500px]">
      <div class="flex flex-col items-center justify-center h-full py-20 opacity-20">
        <div class="w-12 h-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="font-bold">Syncing with Firestore...</p>
      </div>
    </div>
  </main>
</div>

<!-- REVIEW MODAL -->
<div id="reviewModal" class="modal">
  <div class="bg-white w-full max-w-xl rounded-[2rem] shadow-2xl overflow-hidden">
    <div class="p-6 border-b flex justify-between items-center bg-slate-50">
      <h3 class="font-black text-slate-800">Record Inspection</h3>
      <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 text-slate-400">&times;</button>
    </div>
    <div class="p-8 max-h-[60vh] overflow-y-auto space-y-4" id="modalFields"></div>
    <div class="p-6 bg-slate-50 flex gap-3 justify-end">
      <button onclick="closeModal()" class="px-6 py-3 text-sm font-bold text-slate-500 hover:bg-white rounded-xl transition-all">Cancel</button>
      <button id="modalSaveBtn" class="bg-indigo-600 text-white px-8 py-3 rounded-xl text-sm font-bold shadow-lg shadow-indigo-100 active:scale-95 transition-all">Commit Changes</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
    authDomain: "kar-kardan.firebaseapp.com",
    projectId: "kar-kardan",
    storageBucket: "kar-kardan.firebasestorage.app",
    messagingSenderId: "554147696994",
    appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const ADMIN_UID = "nkXAUBb7ffZQ5CtyShWl6YcQ39t2";

  let activeTab = 'users';

  // State Management
  const tabs = [
    { id: 'users', label: 'Users', icon: 'üë•', color: 'slate' },
    { id: 'requests', label: 'Reqs', icon: 'üõ°Ô∏è', color: 'rose' },
    { id: 'providers', label: 'Providers', icon: '‚≠ê', color: 'indigo' },
    { id: 'pending', label: 'Pending', icon: '‚è≥', color: 'amber' },
    { id: 'live', label: 'Live', icon: 'üíº', color: 'green' },
    { id: 'posts', label: 'Posts', icon: 'üí¨', color: 'blue' },
    { id: 'reports', label: 'Reports', icon: 'üö©', color: 'red' },
    { id: 'logs', label: 'Logs', icon: 'üìú', color: 'slate' }
  ];

  // Auth Listeners
  onAuthStateChanged(auth, (user) => {
    if (user && user.uid === ADMIN_UID) {
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("adminDiv").classList.remove("hidden");
      setTimeout(() => document.getElementById("adminDiv").classList.add("opacity-100"), 10);
      renderTabs();
      switchTab('users');
    } else {
      document.getElementById("loginDiv").classList.remove("hidden");
      document.getElementById("adminDiv").classList.add("hidden");
      document.getElementById("adminDiv").classList.remove("opacity-100");
    }
  });

  // Login Handler
  document.getElementById("loginBtn").onclick = async () => {
    const e = document.getElementById("email").value;
    const p = document.getElementById("password").value;
    const error = document.getElementById("loginError");
    error.innerText = "";
    
    try {
      const cred = await signInWithEmailAndPassword(auth, e, p);
      if (cred.user.uid !== ADMIN_UID) {
        await signOut(auth);
        error.innerText = "ACCESS DENIED: Insufficient Privileges.";
      }
    } catch (err) {
      error.innerText = "AUTHENTICATION FAILED: " + err.message;
    }
  };

  document.getElementById("logoutBtn").onclick = () => signOut(auth);

  // Tab Rendering
  async function renderTabs() {
    const container = document.getElementById("tabContainer");
    
    // Initial render
    container.innerHTML = tabs.map(t => `
      <button id="btn-${t.id}" class="nav-btn bg-white border p-4 rounded-[1.5rem] shadow-sm transition-all flex flex-col items-center relative hover:shadow-md group">
        <span class="text-2xl group-hover:scale-110 transition-transform">${t.icon}</span>
        <span class="text-[10px] font-black mt-2 uppercase tracking-tighter text-slate-500">${t.label}</span>
        <span id="badge-${t.id}" class="absolute top-2 right-2 bg-${t.color}-100 text-${t.color}-600 text-[9px] px-1.5 py-0.5 rounded-full font-black">...</span>
      </button>
    `).join('');

    // Attach click events
    tabs.forEach(t => {
      document.getElementById(`btn-${t.id}`).onclick = () => switchTab(t.id);
    });

    updateBadges();
  }

  async function updateBadges() {
    try {
      const [u, pr, vp, pj, aj, ps, rp] = await Promise.all([
        getDocs(collection(db, "users")),
        getDocs(query(collection(db, "users"), where("isRequestingProvider", "==", true))),
        getDocs(query(collection(db, "users"), where("role", "==", "provider"))),
        getDocs(query(collection(db, "jobs"), where("status", "==", "pending"))),
        getDocs(query(collection(db, "jobs"), where("status", "==", "approved"))),
        getDocs(collection(db, "posts")),
        getDocs(collection(db, "reports"))
      ]);

      document.getElementById("badge-users").innerText = u.size;
      document.getElementById("badge-requests").innerText = pr.size;
      document.getElementById("badge-providers").innerText = vp.size;
      document.getElementById("badge-pending").innerText = pj.size;
      document.getElementById("badge-live").innerText = aj.size;
      document.getElementById("badge-posts").innerText = ps.size;
      document.getElementById("badge-reports").innerText = rp.size;
    } catch (e) { console.error("Badge Sync Error:", e); }
  }

  window.switchTab = async (tabId) => {
    activeTab = tabId;
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`btn-${tabId}`).classList.add('active');
    
    const content = document.getElementById("content");
    content.innerHTML = `<div class="flex items-center justify-center h-64"><div class="w-8 h-8 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin"></div></div>`;

    switch(tabId) {
      case 'users': await loadUsers(); break;
      case 'requests': await loadRequests(); break;
      case 'providers': await loadVerifiedProviders(); break;
      case 'pending': await loadJobsByStatus('pending', 'amber'); break;
      case 'live': await loadJobsByStatus('approved', 'green'); break;
      case 'posts': await loadPosts(); break;
      case 'reports': await loadReports(); break;
      case 'logs': content.innerHTML = `<h2 class="text-2xl font-black mb-4">System Logs</h2><p class="text-slate-400">Security audit trails active.</p>`; break;
    }
    updateBadges();
  };

  async function loadUsers() {
    const snap = await getDocs(collection(db, "users"));
    let html = `<div class="flex justify-between items-center mb-8 border-b pb-6">
      <h2 class="text-2xl font-black text-slate-800">User Registry</h2>
      <span class="bg-slate-100 text-slate-500 text-xs font-black px-4 py-2 rounded-full uppercase">${snap.size} Total</span>
    </div><div class="space-y-3">`;
    
    snap.forEach(docSnap => {
      const u = docSnap.data();
      html += `<div class="p-4 border border-slate-100 bg-slate-50/30 rounded-2xl flex justify-between items-center hover:bg-white transition-all">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 rounded-xl bg-white shadow-sm flex items-center justify-center font-black text-indigo-600">${(u.name || '?').charAt(0)}</div>
          <div><p class="font-bold text-sm">${u.name || 'Anonymous'}</p><p class="text-[10px] text-slate-400 font-bold uppercase">${u.role || 'candidate'}</p></div>
        </div>
        <button onclick="inspectRecord('users', '${docSnap.id}')" class="text-[10px] font-black text-indigo-600 uppercase tracking-widest bg-white px-4 py-2 rounded-lg shadow-sm border border-indigo-50 hover:bg-indigo-600 hover:text-white transition-all">Inspect</button>
      </div>`;
    });
    document.getElementById("content").innerHTML = html + "</div>";
  }

  async function loadVerifiedProviders() {
    const [uSnap, jSnap] = await Promise.all([
      getDocs(query(collection(db, "users"), where("role", "==", "provider"))),
      getDocs(collection(db, "jobs"))
    ]);

    const counts = {};
    jSnap.forEach(d => {
      const pId = d.data().providerId || d.data().postedBy;
      if(pId) counts[pId] = (counts[pId] || 0) + 1;
    });

    let html = `<div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-black text-indigo-600">Verified Providers</h2>
      <span class="bg-indigo-50 text-indigo-600 text-xs font-black px-4 py-2 rounded-full uppercase">Trusted Network</span>
    </div><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

    uSnap.forEach(docSnap => {
      const u = docSnap.data();
      const jobCount = counts[docSnap.id] || 0;
      html += `<div class="p-6 border border-indigo-50 bg-indigo-50/10 rounded-3xl flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-white rounded-2xl flex items-center justify-center text-xl shadow-sm">‚≠ê</div>
          <div>
            <p class="font-black text-slate-800">${u.name}</p>
            <p class="text-[10px] text-slate-400 font-bold uppercase">${u.email || 'No email registered'}</p>
          </div>
        </div>
        <div class="text-right bg-white p-3 rounded-2xl border border-indigo-50 min-w-[80px]">
          <p class="text-xl font-black text-indigo-600 leading-none">${jobCount}</p>
          <p class="text-[8px] font-black text-slate-400 uppercase mt-1">Jobs Live</p>
        </div>
      </div>`;
    });
    document.getElementById("content").innerHTML = html + "</div>";
  }

  async function loadJobsByStatus(status, color) {
    const snap = await getDocs(query(collection(db, "jobs"), where("status", "==", status)));
    let html = `<div class="flex justify-between items-center mb-8">
      <h2 class="text-2xl font-black text-${color}-600 capitalize">${status} Jobs</h2>
    </div><div class="space-y-4">`;

    if(snap.empty) html += `<div class="text-center py-20 opacity-20 font-bold">No items found in this queue.</div>`;

    snap.forEach(docSnap => {
      const j = docSnap.data();
      html += `<div class="p-5 border border-slate-100 rounded-[1.5rem] bg-slate-50/30 flex justify-between items-start">
        <div>
          <h4 class="font-black text-slate-800">${j.title}</h4>
          <p class="text-xs text-slate-400 font-bold mt-1 uppercase tracking-tight">${j.company} &bull; ${j.location || 'Remote'}</p>
        </div>
        <div class="flex gap-2">
          ${status === 'pending' ? 
            `<button onclick="updateStatus('jobs', '${docSnap.id}', 'approved')" class="bg-green-600 text-white px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-green-100">Approve</button>` : ''}
          <button onclick="handleDelete('jobs', '${docSnap.id}')" class="bg-white text-red-500 border border-red-50 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-50 transition-all">Delete</button>
        </div>
      </div>`;
    });
    document.getElementById("content").innerHTML = html + "</div>";
  }

  async function loadRequests() {
    const snap = await getDocs(query(collection(db, "users"), where("isRequestingProvider", "==", true)));
    let html = `<h2 class="text-2xl font-black mb-8 text-rose-600">Pending Applications</h2>`;
    
    snap.forEach(docSnap => {
      const u = docSnap.data();
      html += `<div class="p-6 border-l-8 border-rose-500 bg-rose-50/10 rounded-r-3xl mb-4 flex justify-between items-center shadow-sm">
        <div>
          <p class="font-black text-slate-800">${u.name}</p>
          <p class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Wants Provider Role</p>
        </div>
        <div class="flex gap-2">
          <button onclick="inspectRecord('users', '${docSnap.id}')" class="text-[10px] font-black px-4 py-2 bg-white border border-rose-100 rounded-xl uppercase">Profile</button>
          <button onclick="promoteToProvider('${docSnap.id}')" class="bg-rose-600 text-white px-6 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-rose-200">Grant Access</button>
        </div>
      </div>`;
    });
    document.getElementById("content").innerHTML = html;
  }

  // Action Logic
  window.updateStatus = async (coll, id, status) => {
    await updateDoc(doc(db, coll, id), { status });
    switchTab(activeTab);
  };

  window.handleDelete = async (coll, id) => {
    if(!confirm("Are you sure you want to permanently erase this record?")) return;
    await deleteDoc(doc(db, coll, id));
    switchTab(activeTab);
  };

  window.promoteToProvider = async (uid) => {
    await updateDoc(doc(db, "users", uid), {
      role: 'provider',
      isRequestingProvider: false,
      isVerified: true
    });
    switchTab('providers');
  };

  window.inspectRecord = async (coll, id) => {
    const modal = document.getElementById("reviewModal");
    const container = document.getElementById("modalFields");
    modal.classList.add("active");
    container.innerHTML = `<div class="animate-pulse space-y-4">
      <div class="h-4 bg-slate-100 rounded w-1/4"></div>
      <div class="h-10 bg-slate-50 rounded w-full"></div>
    </div>`;

    const snap = await getDocs(query(collection(db, coll))); 
    // Optimization: we could use getDoc but getDocs is more reliable in some wrapper envs
    const target = snap.docs.find(d => d.id === id);
    const data = target.data();

    container.innerHTML = "";
    Object.keys(data).forEach(k => {
      if(typeof data[k] === 'object') return;
      container.innerHTML += `
        <div>
          <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">${k}</label>
          <input type="text" data-field="${k}" value="${data[k]}" class="w-full p-3 bg-slate-50 border-none rounded-xl text-sm font-bold mt-1 focus:ring-2 focus:ring-indigo-500 transition-all">
        </div>
      `;
    });

    document.getElementById("modalSaveBtn").onclick = async () => {
      const updates = {};
      container.querySelectorAll('input').forEach(i => updates[i.dataset.field] = i.value);
      await updateDoc(doc(db, coll, id), updates);
      closeModal();
      switchTab(activeTab);
    };
  };

  window.closeModal = () => document.getElementById("reviewModal").classList.remove("active");

</script>
</body>
</html>

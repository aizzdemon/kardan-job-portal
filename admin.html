<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard ‚Äì BooterSpace</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); }
    .nav-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
    .nav-btn.active .badge { background-color: #4f46e5; color: white; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 50; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px); }
    .modal.active { display: flex; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    
    .stats-card { transition: all 0.2s ease; }
    .stats-card:hover { transform: translateY(-2px); }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<!-- USER EDIT MODAL -->
<div id="editUserModal" class="modal">
  <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
    <div class="p-6 border-b flex justify-between items-center bg-slate-50">
      <h3 class="font-black text-slate-800">Profile Details</h3>
      <button onclick="closeUserModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
    </div>
    <div class="p-6 max-h-[70vh] overflow-y-auto">
      <form id="editUserForm" class="space-y-4">
        <input type="hidden" id="editUserId">
        <div id="dynamicFields" class="space-y-4">
          <!-- Form fields injected here -->
        </div>
      </form>
    </div>
    <div class="p-6 border-t bg-slate-50 flex gap-3 justify-end">
      <button onclick="closeUserModal()" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg">Close</button>
      <button onclick="saveUserDetails()" id="saveUserBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg hover:bg-indigo-700 transition">Save Changes</button>
    </div>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginDiv" class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-black text-indigo-600">KARDAN</h1>
      <p class="text-slate-500 font-medium">Administrative Gateway</p>
    </div>
    <div class="space-y-4">
      <input id="email" type="email" placeholder="Admin Email" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 transition"/>
      <input id="password" type="password" placeholder="Password" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 transition"/>
      <button onclick="login()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 active:scale-95 transition shadow-lg">Authorize Access</button>
      <p id="loginError" class="text-red-500 text-sm text-center font-medium"></p>
    </div>
  </div>
</div>

<!-- ADMIN INTERFACE -->
<div id="adminDiv" class="hidden pb-20">
  <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl font-black text-indigo-600">KARDAN</span>
        <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full font-black uppercase tracking-widest">Master Admin</span>
      </div>
      <button onclick="logout()" class="text-sm font-bold text-slate-500 hover:text-red-600 transition">Logout</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- Navigation Tabs with Badges -->
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
      <button onclick="setActiveTab('users')" id="btn-users" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center relative">
        <span class="text-2xl">üë•</span>
        <span class="text-sm font-bold mt-2">All Users</span>
        <span id="badge-users" class="badge absolute top-2 right-2 bg-slate-100 text-slate-600 text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
      </button>

      <button onclick="setActiveTab('providerRequests')" id="btn-providerRequests" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center relative">
        <span class="text-2xl">üõ°Ô∏è</span>
        <span class="text-sm font-bold mt-2">Provider Req.</span>
        <span id="badge-requests" class="badge absolute top-2 right-2 bg-red-100 text-red-600 text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
      </button>

      <button onclick="setActiveTab('pendingJobs')" id="btn-pendingJobs" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center relative">
        <span class="text-2xl">‚è≥</span>
        <span class="text-sm font-bold mt-2">Pending Jobs</span>
        <span id="badge-pendingJobs" class="badge absolute top-2 right-2 bg-amber-100 text-amber-600 text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
      </button>

      <button onclick="setActiveTab('jobs')" id="btn-jobs" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center relative">
        <span class="text-2xl">üíº</span>
        <span class="text-sm font-bold mt-2">Live Jobs</span>
        <span id="badge-jobs" class="badge absolute top-2 right-2 bg-green-100 text-green-600 text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
      </button>

      <button onclick="setActiveTab('posts')" id="btn-posts" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center relative">
        <span class="text-2xl">üí¨</span>
        <span class="text-sm font-bold mt-2">Posts</span>
        <span id="badge-posts" class="badge absolute top-2 right-2 bg-blue-100 text-blue-600 text-[10px] px-2 py-0.5 rounded-full font-bold">0</span>
      </button>
    </div>

    <div id="content" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 min-h-[500px]">
      <!-- Content Dynamic -->
    </div>
  </main>
</div>

<script>
/* ============================
   Firebase & Config
============================ */
const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_UID = "nkXAUBb7ffZQ5CtyShWl6YcQ39t2";
let activeTab = 'users';

/* ============================
   Core Auth & Dashboard
============================ */
auth.onAuthStateChanged(user => {
  if (user && user.uid === ADMIN_UID) {
    document.getElementById("loginDiv").classList.add("hidden");
    document.getElementById("adminDiv").classList.remove("hidden");
    refreshBadgeCounts();
    setActiveTab('users');
  } else {
    document.getElementById("loginDiv").classList.remove("hidden");
    document.getElementById("adminDiv").classList.add("hidden");
  }
});

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  try {
    const cred = await auth.signInWithEmailAndPassword(email, password);
    if(cred.user.uid !== ADMIN_UID) {
       await auth.signOut();
       document.getElementById("loginError").innerText = "Not an admin account.";
    }
  } catch(e) { document.getElementById("loginError").innerText = e.message; }
}

async function logout() { await auth.signOut(); }

/* ============================
   Utility & Stats
============================ */
async function refreshBadgeCounts() {
    try {
        const uSnap = await db.collection("users").get();
        const pSnap = await db.collection("users").where("isRequestingProvider", "==", true).get();
        const pjSnap = await db.collection("jobs").where("status", "==", "pending").get();
        const jSnap = await db.collection("jobs").where("status", "==", "approved").get();
        const postSnap = await db.collection("posts").get();

        document.getElementById("badge-users").innerText = uSnap.size;
        document.getElementById("badge-requests").innerText = pSnap.size;
        document.getElementById("badge-pendingJobs").innerText = pjSnap.size;
        document.getElementById("badge-jobs").innerText = jSnap.size;
        document.getElementById("badge-posts").innerText = postSnap.size;
    } catch(e) { console.error(e); }
}

function setActiveTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`btn-${tab}`).classList.add('active');
    
    const content = document.getElementById("content");
    content.innerHTML = `<div class="flex justify-center py-20"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>`;

    switch(tab) {
        case 'users': loadUsers(); break;
        case 'providerRequests': loadProviderRequests(); break;
        case 'pendingJobs': loadPendingJobs(); break;
        case 'jobs': loadApprovedJobs(); break;
        case 'posts': loadPosts(); break;
    }
}

/* ============================
   PROVIDER REQUESTS MODULE
============================ */
async function loadProviderRequests() {
    const content = document.getElementById("content");
    try {
        const snap = await db.collection("users").where("isRequestingProvider", "==", true).get();
        
        let html = `<div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold">Provider Verification Queue</h2>
                        <p class="text-xs text-slate-500 font-bold uppercase">Awaiting Approval</p>
                    </div>`;

        if (snap.empty) {
            html += `<div class="text-center py-20 text-slate-400 italic">No pending provider registrations.</div>`;
        } else {
            html += `<div class="space-y-4">`;
            snap.docs.forEach(doc => {
                const u = doc.data();
                html += `
                <div class="p-5 border border-red-100 bg-red-50/20 rounded-2xl flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center font-black text-red-600 text-xl">
                            ${(u.name || 'U').charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800">${u.name || u.fullName || 'Unnamed'}</h4>
                            <p class="text-xs text-slate-500">${u.email || 'No Email'}</p>
                            <div class="flex gap-2 mt-1">
                                <span class="text-[10px] bg-red-500 text-white px-1.5 py-0.5 rounded uppercase font-black">Provider Candidate</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <button onclick="openEditUser('${doc.id}')" class="flex-1 md:flex-none bg-white border border-slate-200 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 transition">View Details</button>
                        <button onclick="approveProvider('${doc.id}')" class="flex-1 md:flex-none bg-green-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-green-700 shadow-md transition">Approve</button>
                        <button onclick="rejectProvider('${doc.id}')" class="flex-1 md:flex-none bg-red-50 text-red-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-100 transition">Reject</button>
                    </div>
                </div>`;
            });
            html += `</div>`;
        }
        content.innerHTML = html;
        refreshBadgeCounts();
    } catch(e) { content.innerHTML = `<p class="text-red-500">${e.message}</p>`; }
}

async function approveProvider(uid) {
    if(confirm("Confirm promotion to Job Provider? This user will be able to post listings.")) {
        try {
            await db.collection("users").doc(uid).update({
                role: 'provider',
                isRequestingProvider: false,
                isVerified: true
            });
            loadProviderRequests();
        } catch(e) { alert(e.message); }
    }
}

async function rejectProvider(uid) {
    if(confirm("Reject this request? User will remain a standard candidate.")) {
        try {
            await db.collection("users").doc(uid).update({
                isRequestingProvider: false
            });
            loadProviderRequests();
        } catch(e) { alert(e.message); }
    }
}

/* ============================
   Standard Modules (Users/Jobs/Posts)
============================ */
async function loadUsers() {
    const content = document.getElementById("content");
    try {
        const snap = await db.collection("users").get();
        let html = `<h2 class="text-xl font-bold mb-6">User Database</h2><div class="space-y-2">`;
        snap.forEach(doc => {
            const u = doc.data();
            html += `<div class="p-3 border rounded-xl flex justify-between items-center bg-white hover:border-indigo-200 transition">
                <div><p class="font-bold text-sm">${u.name || 'User'}</p><p class="text-[10px] text-slate-400 uppercase font-bold">${u.role || 'candidate'}</p></div>
                <button onclick="openEditUser('${doc.id}')" class="text-indigo-600 text-xs font-bold bg-indigo-50 px-3 py-1.5 rounded-lg">View Profile</button>
            </div>`;
        });
        content.innerHTML = html + "</div>";
        refreshBadgeCounts();
    } catch(e) { content.innerHTML = e.message; }
}

async function loadPendingJobs() {
    const content = document.getElementById("content");
    try {
        const snap = await db.collection("jobs").where("status", "==", "pending").get();
        let html = `<h2 class="text-xl font-bold mb-6 text-amber-600">Pending Review</h2>`;
        if(snap.empty) html += `<p class="text-center py-10 text-slate-400">Queue is empty.</p>`;
        snap.forEach(doc => {
            const j = doc.data();
            html += `<div class="p-4 border border-amber-100 bg-amber-50/20 rounded-xl mb-3 flex justify-between items-center">
                <div><h4 class="font-bold text-sm">${j.title}</h4><p class="text-xs text-slate-500">${j.company}</p></div>
                <div class="flex gap-2">
                    <button onclick="updateJob('${doc.id}', 'approved')" class="bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold">Approve</button>
                    <button onclick="deleteRecord('jobs', '${doc.id}')" class="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold">Delete</button>
                </div>
            </div>`;
        });
        content.innerHTML = html;
        refreshBadgeCounts();
    } catch(e) { content.innerHTML = e.message; }
}

async function loadApprovedJobs() {
    const content = document.getElementById("content");
    const snap = await db.collection("jobs").where("status", "==", "approved").get();
    let html = `<h2 class="text-xl font-bold mb-6">Active Job Board</h2>`;
    snap.forEach(doc => {
        const j = doc.data();
        html += `<div class="p-3 border rounded-xl mb-2 flex justify-between items-center">
            <div><p class="font-bold text-sm">${j.title}</p><p class="text-[10px] text-slate-400">${j.company}</p></div>
            <button onclick="deleteRecord('jobs', '${doc.id}')" class="text-red-500 text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-red-50 transition">Remove</button>
        </div>`;
    });
    content.innerHTML = html;
}

async function loadPosts() {
    const content = document.getElementById("content");
    const snap = await db.collection("posts").orderBy("timestamp", "desc").get();
    let html = `<h2 class="text-xl font-bold mb-6">Community Stream</h2>`;
    snap.forEach(doc => {
        const p = doc.data();
        html += `<div class="p-4 border rounded-xl mb-3">
            <p class="text-sm text-slate-700 mb-2">${p.content || p.text || 'No text'}</p>
            <button onclick="deleteRecord('posts', '${doc.id}')" class="text-red-400 text-[10px] font-bold uppercase tracking-wider">Remove Post</button>
        </div>`;
    });
    content.innerHTML = html;
}

/* ============================
   Detail/Edit Logic
============================ */
async function openEditUser(userId) {
    const modal = document.getElementById("editUserModal");
    const container = document.getElementById("dynamicFields");
    document.getElementById("editUserId").value = userId;
    modal.classList.add("active");
    container.innerHTML = "Loading profile...";

    try {
        const uDoc = await db.collection("users").doc(userId).get();
        const data = uDoc.data();
        container.innerHTML = "";
        
        // Render all fields
        Object.keys(data).forEach(key => {
            if(['createdAt', 'timestamp', 'uid'].includes(key)) return;
            const val = data[key];
            container.innerHTML += `<div>
                <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 tracking-widest">${key}</label>
                <input type="text" data-key="${key}" value="${val}" class="w-full p-3 border rounded-xl text-sm bg-slate-50 focus:bg-white transition outline-none focus:ring-2 focus:ring-indigo-500"/>
            </div>`;
        });
    } catch(e) { container.innerHTML = "Error loading."; }
}

async function saveUserDetails() {
    const userId = document.getElementById("editUserId").value;
    const inputs = document.querySelectorAll("#dynamicFields [data-key]");
    const updatedData = {};
    inputs.forEach(el => { updatedData[el.dataset.key] = el.value; });

    try {
        await db.collection("users").doc(userId).update(updatedData);
        closeUserModal();
        setActiveTab(activeTab);
    } catch(e) { alert(e.message); }
}

function closeUserModal() { document.getElementById("editUserModal").classList.remove("active"); }

/* Shared Actions */
async function updateJob(id, status) {
    await db.collection("jobs").doc(id).update({ status });
    setActiveTab(activeTab);
}

async function deleteRecord(coll, id) {
    if(confirm("Permanently delete this?")) {
        await db.collection(coll).doc(id).delete();
        setActiveTab(activeTab);
    }
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BooterSpace | Network</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">

<!-- üîç SEARCH BAR -->
<div class="bg-white border-b sticky top-0 z-10">
  <div class="max-w-4xl mx-auto p-4 relative">
    <input id="searchInput"
      placeholder="Search people..."
      class="w-full border rounded px-4 py-2 text-sm" />

    <!-- Dropdown -->
    <div id="dropdown"
      class="absolute bg-white border rounded w-full mt-1 hidden z-20 max-h-60 overflow-y-auto"></div>
  </div>
</div>

<!-- MAIN AREA -->
<div id="mainView" class="max-w-4xl mx-auto p-4 space-y-4"></div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser;
let allUsers = [];
let myConnections = new Set();

/* ================= AUTH ================= */
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "login.html";
  currentUser = user;
  await fetchAllUsers();
  await fetchMyConnections();
  loadMyProfile();
});

/* ================= FETCH ================= */
async function fetchAllUsers() {
  const snap = await db.collection("users").get();
  allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
}

async function fetchMyConnections() {
  const snap = await db.collection("connections")
    .where("from", "==", currentUser.uid).get();

  snap.forEach(d => myConnections.add(d.data().to));
}

/* ================= MY PROFILE ================= */
async function loadMyProfile() {
  const doc = await db.collection("users").doc(currentUser.uid).get();
  const u = doc.data();

  mainView.innerHTML = `
    <div class="bg-white p-6 rounded border">
      <div class="flex gap-6 items-center">
        <img src="${u.photoURL || 'https://i.imgur.com/6VBx3io.png'}"
          class="w-24 h-24 rounded-full border" />
        <div>
          <h2 class="text-xl font-bold">${u.fullName}</h2>
          <p class="text-sm text-gray-500">${currentUser.email}</p>
          <p class="text-sm">${u.education || ""}</p>
          <p class="text-sm">${u.university || ""}</p>
          <p class="text-sm">${u.experience || ""}</p>
          <p class="text-sm font-bold mt-2">
            Connections: ${myConnections.size}
          </p>
        </div>
      </div>
    </div>
  `;
}

/* ================= SEARCH INPUT ================= */
const input = document.getElementById("searchInput");
const dropdown = document.getElementById("dropdown");

input.addEventListener("focus", () => {
  mainView.innerHTML = "";
});

input.addEventListener("input", () => {
  const q = input.value.toLowerCase().trim();
  if (!q) return dropdown.classList.add("hidden");

  const matches = allUsers.filter(u =>
    u.id !== currentUser.uid &&
    (u.fullName || "").toLowerCase().includes(q)
  );

  renderDropdown(matches.slice(0, 6));
});

input.addEventListener("keypress", e => {
  if (e.key === "Enter") runSearch(input.value);
});

/* ================= DROPDOWN ================= */
function renderDropdown(list) {
  dropdown.innerHTML = "";
  dropdown.classList.remove("hidden");

  list.forEach(u => {
    dropdown.innerHTML += `
      <div onclick="runSearch('${u.fullName}')"
        class="p-2 hover:bg-gray-100 cursor-pointer flex gap-2 items-center">
        <img src="${u.photoURL || 'https://i.imgur.com/6VBx3io.png'}"
          class="w-8 h-8 rounded-full" />
        <span class="text-sm font-semibold">${u.fullName}</span>
      </div>
    `;
  });
}

/* ================= SEARCH RESULTS ================= */
function runSearch(q) {
  dropdown.classList.add("hidden");
  const query = q.toLowerCase();

  const results = allUsers.filter(u =>
    u.id !== currentUser.uid &&
    (
      (u.fullName || "").toLowerCase().includes(query) ||
      (u.education || "").toLowerCase().includes(query) ||
      (u.university || "").toLowerCase().includes(query)
    )
  );

  renderResults(results);
}

/* ================= RENDER LIST ================= */
function renderResults(users) {
  mainView.innerHTML = `
    <div class="bg-white p-4 rounded border font-bold">
      Search Results (${users.length})
    </div>
  `;

  users.forEach(u => {
    const connected = myConnections.has(u.id);

    mainView.innerHTML += `
      <div class="bg-white p-4 rounded border flex justify-between items-center">
        <div class="flex gap-4 items-center">
          <img src="${u.photoURL || 'https://i.imgur.com/6VBx3io.png'}"
            class="w-14 h-14 rounded-full border" />
          <div>
            <p class="font-bold">${u.fullName}</p>
            <p class="text-xs text-gray-500">
              ${u.education || ""} ‚Ä¢ ${u.experience || ""}
            </p>
          </div>
        </div>

        <div class="flex gap-2">
          <button onclick="viewProfile('${u.id}')"
            class="border px-3 py-1 rounded text-xs font-bold">
            View
          </button>
          <button
            ${connected ? "disabled" : ""}
            onclick="connectUser('${u.id}')"
            class="border border-blue-600 text-blue-600 px-3 py-1 rounded text-xs font-bold">
            ${connected ? "Connected" : "Connect"}
          </button>
        </div>
      </div>
    `;
  });
}

/* ================= VIEW PROFILE ================= */
async function viewProfile(uid) {
  const doc = await db.collection("users").doc(uid).get();
  const u = doc.data();

  mainView.innerHTML = `
    <div class="bg-white p-6 rounded border">
      <button onclick="runSearch(input.value)"
        class="text-blue-600 text-sm mb-4">‚Üê Back</button>

      <div class="flex gap-6 items-center">
        <img src="${u.photoURL || 'https://i.imgur.com/6VBx3io.png'}"
          class="w-24 h-24 rounded-full border" />
        <div>
          <h2 class="text-xl font-bold">${u.fullName}</h2>
          <p>${u.education || ""}</p>
          <p>${u.university || ""}</p>
          <p>${u.experience || ""}</p>
        </div>
      </div>
    </div>
  `;
}

/* ================= CONNECT ================= */
async function connectUser(uid) {
  await db.collection("connections").add({
    from: currentUser.uid,
    to: uid,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  myConnections.add(uid);
  runSearch(input.value);
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile - KARDAN</title>

  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Lucide Icons (REQUIRED for navbar) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- ========== NAVBAR COMPONENT ========== -->
  <div id="navbar"></div>
  <script type="module" src="./navbar.js"></script>

  <!-- ========== MAIN PROFILE ========== -->
  <main class="max-w-6xl mx-auto p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

    <!-- USER INFO -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-xl font-bold mb-4">User Info</h2>
      <p id="userEmail" class="text-gray-700"></p>
    </div>

    <!-- RIGHT SIDE -->
    <div class="md:col-span-2 flex flex-col gap-6">

      <!-- QUICK ACTIONS -->
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-xl font-bold mb-4">Quick Actions</h2>
        <div class="flex flex-wrap gap-4">
          <a href="post-job.html" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow">
            + Post a Job
          </a>
          <a href="post-book.html" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow">
            + Post a Book
          </a>
          <a href="post-place.html" class="bg-purple-500 text-white px-4 py-2 rounded-lg shadow">
            + Post a Place
          </a>
        </div>
      </div>

      <!-- POSTED JOBS -->
      <div class="bg-white p-4 rounded shadow">
        <h2 class="text-xl font-bold mb-4">Your Posted Jobs</h2>
        <ul id="jobsList" class="space-y-4"></ul>
      </div>

    </div>
  </main>

  <!-- ========== EDIT JOB POPUP ========== -->
  <div id="editPopup"
    class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">

    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg p-6 relative">
      <button id="closePopup"
        class="absolute top-3 right-3 text-gray-500 text-2xl">&times;</button>

      <h2 class="text-xl font-bold mb-4 text-center">Edit Job</h2>

      <form id="editJobForm" class="space-y-3">
        <input type="hidden" id="editJobId">

        <input id="editJobTitle" class="w-full p-2 border rounded" placeholder="Job Title" required>
        <input id="editCompanyName" class="w-full p-2 border rounded" placeholder="Company">
        <input id="editJobLocation" class="w-full p-2 border rounded" placeholder="Location">
        <input id="editSalary" class="w-full p-2 border rounded" placeholder="Salary">

        <select id="editJobType" class="w-full p-2 border rounded">
          <option>Full-Time</option>
          <option>Part-Time</option>
          <option>Internship</option>
          <option>Contract</option>
        </select>

        <textarea id="editDescription" class="w-full p-2 border rounded" placeholder="Description"></textarea>
        <input id="editJobApplyLink" class="w-full p-2 border rounded" placeholder="Apply Link">
        <input id="editCompanyLogo" class="w-full p-2 border rounded" placeholder="Company Logo URL">

        <button class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
          Update Job
        </button>
      </form>
    </div>
  </div>

  <!-- ========== PROFILE SCRIPT ========== -->
  <script>
    // Firebase Init (safe check)
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
        authDomain: "kar-kardan.firebaseapp.com",
        projectId: "kar-kardan",
        storageBucket: "kar-kardan.firebasestorage.app",
        messagingSenderId: "554147696994",
        appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
      });
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    const jobsList = document.getElementById("jobsList");
    const editPopup = document.getElementById("editPopup");
    const closePopup = document.getElementById("closePopup");
    const editJobForm = document.getElementById("editJobForm");

    let currentUid = null;

    // AUTH CHECK
    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "login.html";
      currentUid = user.uid;
      document.getElementById("userEmail").textContent =
        "Logged in as: " + user.email;
      loadJobs();
    });

    // LOAD JOBS
    async function loadJobs() {
      jobsList.innerHTML = "";
      const snap = await db.collection("jobs")
        .where("uid", "==", currentUid)
        .orderBy("timestamp", "desc")
        .get();

      if (snap.empty) {
        jobsList.innerHTML = "<p>No jobs posted yet.</p>";
        return;
      }

      snap.forEach(doc => {
        const j = doc.data();
        const li = document.createElement("li");
        li.className = "p-4 border rounded flex justify-between";
        li.innerHTML = `
          <div>
            <h3 class="font-bold">${j.title || "Untitled"}</h3>
            <p class="text-sm">${j.companyName || ""} ${j.location || ""}</p>
          </div>
          <div class="flex gap-2">
            <button class="edit-btn bg-blue-500 text-white px-2 py-1 rounded"
              data-id="${doc.id}">Edit</button>
            <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded"
              data-id="${doc.id}">Delete</button>
          </div>
        `;
        jobsList.appendChild(li);
      });
    }

    // CLICK HANDLERS
    jobsList.onclick = e => {
      if (e.target.classList.contains("edit-btn"))
        openEdit(e.target.dataset.id);
      if (e.target.classList.contains("delete-btn"))
        deleteJob(e.target.dataset.id);
    };

    async function deleteJob(id) {
      await db.collection("jobs").doc(id).delete();
      loadJobs();
    }

    function openEdit(id) {
      db.collection("jobs").doc(id).get().then(d => {
        const j = d.data();
        editJobId.value = id;
        editJobTitle.value = j.title || "";
        editCompanyName.value = j.companyName || "";
        editJobLocation.value = j.location || "";
        editSalary.value = j.salary || "";
        editJobType.value = j.type || "Full-Time";
        editDescription.value = j.description || "";
        editJobApplyLink.value = j.applyLink || "";
        editCompanyLogo.value = j.companyLogo || "";
        editPopup.classList.remove("hidden");
      });
    }

    closePopup.onclick = () => editPopup.classList.add("hidden");

    editJobForm.onsubmit = async e => {
      e.preventDefault();
      await db.collection("jobs").doc(editJobId.value).update({
        title: editJobTitle.value,
        companyName: editCompanyName.value,
        location: editJobLocation.value,
        salary: editSalary.value,
        type: editJobType.value,
        description: editJobTitle.value,
        applyLink: editJobApplyLink.value,
        companyLogo: editCompanyLogo.value,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      editPopup.classList.add("hidden");
      loadJobs();
    };
  </script>

</body>
</html>



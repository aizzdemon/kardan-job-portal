<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>User Profile - KARDAN</title>

    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        /* Hide content by default until auth check passes */
        body { visibility: hidden; }
        .auth-checked body { visibility: visible; }

        .avatar-option {
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }
        .avatar-option:hover {
            transform: scale(1.1);
        }
        .avatar-option.selected {
            border: 3px solid #3b82f6;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- ========== NAVBAR COMPONENT ========== -->
    <div id="navbar"></div>

    <script>
        const navbarPlaceholder = document.getElementById("navbar");
        if (navbarPlaceholder) {
            navbarPlaceholder.innerHTML = `
                <nav class="bg-white shadow-sm p-4 mb-6 border-b">
                    <div class="max-w-6xl mx-auto flex justify-between items-center">
                        <h1 class="text-2xl font-bold text-blue-600">KARDAN</h1>
                        <div class="flex gap-4">
                            <a href="index.html" class="text-gray-600 hover:text-blue-600">Home</a>
                            <button id="logoutBtn" class="text-red-500 hover:text-red-700">Logout</button>
                        </div>
                    </div>
                </nav>
            `;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    </script>

    <!-- ========== MAIN PROFILE ========== -->
    <main class="max-w-4xl mx-auto p-6">
        <div class="bg-white p-8 rounded-xl shadow-md mb-6">
            <div class="flex flex-col md:flex-row items-center gap-6 mb-8 border-b pb-6">
                <!-- Profile Image Display -->
                <div class="relative group">
                    <img id="profilePic" src="https://api.dicebear.com/7.x/bottts/svg?seed=default" 
                         alt="Profile" class="w-24 h-24 rounded-full object-cover border-4 border-blue-50 bg-blue-50">
                    <button onclick="toggleEditModal(true)" class="absolute bottom-0 right-0 bg-blue-600 text-white p-1.5 rounded-full shadow-lg hover:bg-blue-700 transition">
                        <i data-lucide="camera" class="w-4 h-4"></i>
                    </button>
                </div>
                
                <div class="text-center md:text-left">
                    <h2 id="displayName" class="text-2xl font-bold text-gray-800 italic">Loading Name...</h2>
                    <p id="userEmail" class="text-gray-500"></p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100 flex items-center gap-3">
                    <i data-lucide="graduation-cap" class="text-blue-500"></i>
                    <div>
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Education</h3>
                        <p id="displayEducation" class="text-gray-700 font-medium">Not specified</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100 flex items-center gap-3">
                    <i data-lucide="briefcase" class="text-blue-500"></i>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Experience Level</h3>
                        <p id="displayExperience" class="text-gray-700 font-medium">Not specified</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100 flex items-center gap-3">
                    <i data-lucide="calendar" class="text-blue-500"></i>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Date of Birth</h3>
                        <p id="displayDOB" class="text-gray-700 font-medium">Not specified</p>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg border border-gray-100 flex items-center gap-3">
                    <i data-lucide="fingerprint" class="text-blue-500"></i>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Account ID</h3>
                        <span id="userIdDisplay" class="text-xs text-gray-400 font-mono"></span>
                    </div>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="toggleEditModal(true)" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-sm flex items-center gap-2">
                    <i data-lucide="edit-3" class="w-4 h-4"></i> Edit Profile
                </button>
                <button id="mainLogoutBtn" class="border border-red-200 text-red-500 px-6 py-2 rounded-lg hover:bg-red-50 transition">
                    Sign Out
                </button>
            </div>
        </div>
    </main>

    <!-- ========== EDIT PROFILE MODAL ========== -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-y-auto max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                <h2 class="text-xl font-bold">Edit Profile Details</h2>
                <button onclick="toggleEditModal(false)" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <form id="profileForm" class="p-6 space-y-4">
                <!-- Avatar Selection Section -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Clip Art Avatar</label>
                    <div id="avatarGrid" class="grid grid-cols-4 gap-3 mb-3">
                        <!-- DiceBear Avatars will be injected here -->
                    </div>
                    <div class="text-center mb-4">
                        <button type="button" onclick="generateAvatars()" class="text-xs text-blue-600 hover:underline">
                            Refresh Avatars
                        </button>
                    </div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Or Custom Image URL</label>
                    <input type="url" id="editAvatarUrl" class="w-full p-2 border rounded-lg text-sm" placeholder="https://example.com/image.png">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="editName" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="John Doe">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input type="date" id="editDOB" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Highest Education</label>
                        <select id="editEducation" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Select</option>
                            <option>High School</option>
                            <option>Associate Degree</option>
                            <option>Bachelor's Degree</option>
                            <option>Master's Degree</option>
                            <option>PhD / Doctorate</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Experience</label>
                        <select id="editExperience" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">Select</option>
                            <option>Fresher</option>
                            <option>Junior (1-2Y)</option>
                            <option>Mid (3-5Y)</option>
                            <option>Senior (5-10Y)</option>
                            <option>Executive</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4 flex gap-3">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-bold transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== PROFILE SCRIPT ========== -->
    <script>
        // Firebase Init
        if (!firebase.apps.length) {
            firebase.initializeApp({
                apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
                authDomain: "kar-kardan.firebaseapp.com",
                projectId: "kar-kardan",
                storageBucket: "kar-kardan.firebasestorage.app",
                messagingSenderId: "554147696994",
                appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
            });
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // UI References
        const displayFields = {
            name: document.getElementById("displayName"),
            email: document.getElementById("userEmail"),
            edu: document.getElementById("displayEducation"),
            exp: document.getElementById("displayExperience"),
            dob: document.getElementById("displayDOB"),
            uid: document.getElementById("userIdDisplay"),
            pic: document.getElementById("profilePic")
        };

        const editModal = document.getElementById("editModal");
        const profileForm = document.getElementById("profileForm");
        const avatarGrid = document.getElementById("avatarGrid");
        const editAvatarInput = document.getElementById("editAvatarUrl");

        let selectedAvatarUrl = "";

        // AUTH CHECK (GUARD)
        auth.onAuthStateChanged(user => {
            if (!user) {
                // If not logged in, redirect to login page immediately
                window.location.href = "login.html";
                return;
            }
            
            // User is authenticated, reveal content and load data
            document.documentElement.classList.add("auth-checked");
            
            displayFields.email.textContent = user.email;
            displayFields.uid.textContent = "UID: " + user.uid;
            fetchUserProfile(user.uid);
        });

        async function fetchUserProfile(uid) {
            try {
                const doc = await db.collection("users").doc(uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    displayFields.name.textContent = data.fullName || "New User";
                    displayFields.edu.textContent = data.education || "Not specified";
                    displayFields.exp.textContent = data.experience || "Not specified";
                    displayFields.dob.textContent = data.dob || "Not specified";
                    if (data.photoURL) displayFields.pic.src = data.photoURL;

                    // Fill form
                    document.getElementById("editName").value = data.fullName || "";
                    document.getElementById("editEducation").value = data.education || "";
                    document.getElementById("editExperience").value = data.experience || "";
                    document.getElementById("editDOB").value = data.dob || "";
                    editAvatarInput.value = data.photoURL || "";
                    selectedAvatarUrl = data.photoURL || "";
                }
            } catch (error) { console.error("Error fetching profile:", error); }
        }

        // Clip Art Generation (DiceBear API)
        function generateAvatars() {
            avatarGrid.innerHTML = "";
            const styles = ['bottts', 'avataaars', 'pixel-art', 'lorelei'];
            
            for (let i = 0; i < 8; i++) {
                const randomStyle = styles[Math.floor(Math.random() * styles.length)];
                const seed = Math.random().toString(36).substring(7);
                const url = `https://api.dicebear.com/7.x/${randomStyle}/svg?seed=${seed}`;
                
                const img = document.createElement("img");
                img.src = url;
                img.className = "w-full h-12 rounded-lg bg-gray-100 p-1 avatar-option border-2 border-transparent";
                img.onclick = () => {
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    img.classList.add('selected');
                    selectedAvatarUrl = url;
                    editAvatarInput.value = url;
                };
                avatarGrid.appendChild(img);
            }
        }

        function toggleEditModal(show) {
            if (show) {
                editModal.classList.remove("hidden");
                generateAvatars();
            } else {
                editModal.classList.add("hidden");
            }
        }

        // SAVE PROFILE
        profileForm.onsubmit = async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const finalPhotoUrl = editAvatarInput.value || selectedAvatarUrl;

            const profileData = {
                fullName: document.getElementById("editName").value,
                education: document.getElementById("editEducation").value,
                experience: document.getElementById("editExperience").value,
                dob: document.getElementById("editDOB").value,
                photoURL: finalPhotoUrl,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection("users").doc(user.uid).set(profileData, { merge: true });
                toggleEditModal(false);
                fetchUserProfile(user.uid);
            } catch (error) {
                alert("Error updating profile: " + error.message);
            }
        };

        const handleLogout = () => auth.signOut().then(() => window.location.href = "login.html");
        document.getElementById("logoutBtn")?.addEventListener('click', handleLogout);
        document.getElementById("mainLogoutBtn")?.addEventListener('click', handleLogout);

        if (typeof lucide !== 'undefined') lucide.createIcons();
    </script>
</body>
</html>

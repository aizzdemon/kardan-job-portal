
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BooterSpace | Search & Profile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  .transition-layout { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
  .avatar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
  .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
</style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- üî• SaaS Navbar -->
<div id="navbar"></div>

<script>
fetch("navbar.html")
.then(r=>r.text())
.then(html=>{
  document.getElementById("navbar").innerHTML=html;
  const s=document.createElement("script");
  s.src="navbar.js";
  document.body.appendChild(s);
});
</script>

<!-- üîç SEARCH BAR -->
<div class="bg-white border-b sticky top-0 z-20 shadow-sm">
  <div class="max-w-6xl mx-auto p-4 flex gap-2">
    <input
      id="searchInput"
      type="text"
      placeholder="Search people, education, university..."
      class="flex-1 border rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition shadow-inner"
    />
    <button
      id="searchBtn"
      class="bg-blue-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition shadow-md">
      Search
    </button>
  </div>
</div>

<!-- üìê MAIN LAYOUT -->
<div id="mainContainer" class="flex-1 max-w-6xl mx-auto p-4 w-full relative">
  <div id="gridWrapper" class="grid grid-cols-1 gap-6 transition-layout">
    
    <!-- üëà LEFT PANEL (Search Results & Dynamic Details) -->
    <div id="leftPanel" class="hidden transition-all duration-500 opacity-0 transform -translate-x-4">
      <div id="resultsListContainer">
        <div id="resultsHeader" class="mb-4 flex justify-between items-center hidden">
          <h3 class="font-bold text-gray-700 text-lg">Search Results</h3>
          <span id="resultsCount" class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">0 found</span>
        </div>
        <div id="resultsView" class="space-y-4"></div>
      </div>
      <div id="detailViewContainer" class="hidden bg-white rounded-xl shadow-lg overflow-hidden border"></div>
    </div>

    <!-- üëâ RIGHT PANEL (My Profile) -->
    <div id="rightPanel" class="w-full max-w-2xl mx-auto transition-layout">
      <div id="myProfileCard" class="bg-white rounded-xl shadow-lg border overflow-hidden relative opacity-0 transition-opacity duration-500">
        <div class="h-32 bg-gradient-to-r from-blue-600 to-indigo-600"></div>
        <div class="px-6 pb-6 relative">
          <!-- Profile Image with Avatar Click -->
          <div class="relative -mt-12 mb-4 flex justify-center lg:justify-start group cursor-pointer" onclick="openAvatarModal()">
             <img id="myPhoto" src="https://i.imgur.com/6VBx3io.png" class="w-24 h-24 rounded-full border-4 border-white shadow-md bg-gray-200 object-cover group-hover:brightness-75 transition">
             <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
             </div>
          </div>
          
          <div class="text-center lg:text-left">
            <h1 id="myName" class="text-2xl font-bold text-gray-800">Loading...</h1>
            <p id="myRole" class="text-blue-600 font-medium"></p>
            <p id="myLoc" class="text-gray-500 text-sm mb-4"></p>
            
            <div class="border-t pt-4 mt-4 space-y-4 text-left">
              <div class="flex items-start gap-3">
                <div class="mt-1 text-blue-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0z"></path></svg></div>
                <div>
                    <span class="text-xs font-bold text-gray-400 uppercase">Education</span>
                    <p id="myEdu" class="text-gray-700 text-sm">--</p>
                </div>
              </div>
              <div class="flex items-start gap-3">
                <div class="mt-1 text-blue-500"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd"></path><path d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"></path></svg></div>
                <div>
                    <span class="text-xs font-bold text-gray-400 uppercase">Current Position</span>
                    <p id="myExp" class="text-gray-700 text-sm">--</p>
                    <p id="myYears" class="text-xs text-blue-500 font-bold mt-1 uppercase"></p>
                </div>
              </div>
            </div>

            <div class="mt-6 flex gap-2 justify-center lg:justify-start">
              <button onclick="openEditModal()" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-200 text-sm text-center">Edit Profile</button>
              <button class="flex-1 bg-blue-50 text-blue-600 py-2 rounded-lg font-semibold hover:bg-blue-100 text-sm">Stats</button>
            </div>
          </div>
        </div>
      </div>
      <div id="searchHint" class="text-center mt-8 text-gray-400 animate-pulse">Type above to search for people...</div>
    </div>
  </div>
</div>

<!-- üñº AVATAR PICKER MODAL -->
<div id="avatarModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden">
        <div class="p-4 border-b flex justify-between items-center">
            <h3 class="font-bold text-gray-800">Choose Avatar</h3>
            <button onclick="closeAvatarModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
        </div>
        <div class="p-4 max-h-[60vh] overflow-y-auto avatar-grid" id="avatarGrid">
            <!-- Avatars generated here -->
        </div>
        <div class="p-4 border-t bg-gray-50 flex justify-end">
            <button onclick="closeAvatarModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold">Done</button>
        </div>
    </div>
</div>

<!-- üìù EDIT PROFILE MODAL -->
<div id="editModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
        <div class="p-4 border-b">
            <h3 class="font-bold text-gray-800">Edit Profile</h3>
        </div>
        <div class="p-6 space-y-4">
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">Full Name</label>
                <input id="editName" type="text" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">Education</label>
                <input id="editEdu" type="text" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div>
                <label class="text-xs font-bold text-gray-400 uppercase">University</label>
                <input id="editUni" type="text" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Position</label>
                    <input id="editPos" type="text" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase">Exp (Years)</label>
                    <input id="editYears" type="number" class="w-full border rounded-lg p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>
        </div>
        <div class="p-4 bg-gray-50 flex gap-2">
            <button onclick="closeEditModal()" class="flex-1 py-2 border rounded-lg font-bold text-gray-600 hover:bg-white">Cancel</button>
            <button id="saveProfileBtn" onclick="saveProfile()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700">Save Changes</button>
        </div>
    </div>
</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const state = {
  isSearching: false,
  searchResults: [],
  currentUser: null,
  profileData: {}
};

/* ================= AUTH & FETCH ================= */
auth.onAuthStateChanged(user => {
  if (user) {
    state.currentUser = user;
    fetchAndRenderMyProfile(user.uid);
  } else {
    document.getElementById('myName').innerText = "Guest User";
    myProfileCard.classList.remove('opacity-0');
  }
});

async function fetchAndRenderMyProfile(uid) {
  try {
    const doc = await db.collection("users").doc(uid).get();
    if (doc.exists) {
      const data = doc.data();
      state.profileData = data;
      document.getElementById('myName').innerText = data.fullName || "User Name";
      document.getElementById('myRole').innerText = data.role || data.position || "Professional";
      document.getElementById('myEdu').innerText = `${data.education || "No education info"} at ${data.university || "..."}`;
      document.getElementById('myExp').innerText = data.position || "No position info";
      document.getElementById('myYears').innerText = data.expYears ? `${data.expYears} Years Experience` : "";
      document.getElementById('myPhoto').src = data.photoURL || "https://i.imgur.com/6VBx3io.png";
    }
  } catch (err) { console.error(err); } 
  finally { myProfileCard.classList.remove('opacity-0'); }
}

/* ================= EDIT PROFILE ================= */
function openEditModal() {
  document.getElementById('editName').value = state.profileData.fullName || "";
  document.getElementById('editEdu').value = state.profileData.education || "";
  document.getElementById('editUni').value = state.profileData.university || "";
  document.getElementById('editPos').value = state.profileData.position || "";
  document.getElementById('editYears').value = state.profileData.expYears || "";
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }

async function saveProfile() {
  const btn = document.getElementById('saveProfileBtn');
  btn.innerText = "Saving...";
  btn.disabled = true;

  const updatedData = {
    fullName: document.getElementById('editName').value,
    education: document.getElementById('editEdu').value,
    university: document.getElementById('editUni').value,
    position: document.getElementById('editPos').value,
    expYears: document.getElementById('editYears').value
  };

  try {
    await db.collection("users").doc(state.currentUser.uid).set(updatedData, { merge: true });
    state.profileData = { ...state.profileData, ...updatedData };
    fetchAndRenderMyProfile(state.currentUser.uid);
    closeEditModal();
  } catch (err) { alert("Error saving profile"); }
  finally {
    btn.innerText = "Save Changes";
    btn.disabled = false;
  }
}

/* ================= AVATAR PICKER ================= */
function openAvatarModal() {
    const grid = document.getElementById('avatarGrid');
    grid.innerHTML = '';
    
    // Generate 30 avatars from different sets (avataaars, bottts, lorelei, etc)
    const sets = ['avataaars', 'bottts', 'lorelei', 'notionists'];
    for(let i=0; i < 40; i++) {
        const seed = Math.random().toString(36).substring(7);
        const set = sets[i % sets.length];
        const url = `https://api.dicebear.com/7.x/${set}/svg?seed=${seed}`;
        
        const div = document.createElement('div');
        div.className = "cursor-pointer hover:scale-110 transition p-1 border rounded-lg hover:border-blue-500 bg-gray-50";
        div.onclick = () => selectAvatar(url);
        div.innerHTML = `<img src="${url}" class="w-full h-full">`;
        grid.appendChild(div);
    }
    document.getElementById('avatarModal').classList.remove('hidden');
}

function closeAvatarModal() { document.getElementById('avatarModal').classList.add('hidden'); }

async function selectAvatar(url) {
    document.getElementById('myPhoto').src = url;
    try {
        await db.collection("users").doc(state.currentUser.uid).set({ photoURL: url }, { merge: true });
        state.profileData.photoURL = url;
    } catch(e) { console.error(e); }
    closeAvatarModal();
}

/* ================= SEARCH & LAYOUT (FROM PREVIOUS) ================= */
const input = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const resultsView = document.getElementById("resultsView");
const gridWrapper = document.getElementById("gridWrapper");
const leftPanel = document.getElementById("leftPanel");
const rightPanel = document.getElementById("rightPanel");
const searchHint = document.getElementById("searchHint");
const resultsListContainer = document.getElementById("resultsListContainer");
const detailViewContainer = document.getElementById("detailViewContainer");
const resultsHeader = document.getElementById("resultsHeader");
const resultsCount = document.getElementById("resultsCount");

searchBtn.addEventListener("click", runSearch);
input.addEventListener("keypress", e => { if (e.key === "Enter") runSearch(); });

async function runSearch() {
  const q = input.value.toLowerCase().trim();
  if (!q) return;

  activateSearchLayout();
  resultsView.innerHTML = `<div class="flex justify-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div></div>`;
  showResultsList();

  try {
    const snapshot = await db.collection("users").get();
    const results = [];
    snapshot.forEach(doc => {
      if (state.currentUser && doc.id === state.currentUser.uid) return;
      const u = doc.data();
      const searchable = `${u.fullName} ${u.education} ${u.university} ${u.position}`.toLowerCase();
      if (searchable.includes(q)) results.push({ id: doc.id, ...u });
    });
    state.searchResults = results;
    renderResults(results);
  } catch (error) { console.error(error); }
}

function activateSearchLayout() {
  if (state.isSearching) return;
  state.isSearching = true;
  gridWrapper.classList.remove('grid-cols-1');
  gridWrapper.classList.add('lg:grid-cols-3');
  rightPanel.classList.remove('max-w-2xl', 'mx-auto');
  rightPanel.classList.add('lg:col-span-1');
  searchHint.classList.add('hidden');
  leftPanel.classList.remove('hidden');
  setTimeout(() => leftPanel.classList.remove('opacity-0', '-translate-x-4'), 50);
  leftPanel.classList.add('lg:col-span-2');
}

function renderResults(users) {
  resultsHeader.classList.remove('hidden');
  resultsCount.innerText = `${users.length} found`;
  resultsView.innerHTML = users.length ? '' : '<div class="p-8 bg-white rounded-xl border text-center text-gray-400">No matches found</div>';
  users.forEach(u => {
    const card = document.createElement('div');
    card.className = "bg-white p-4 rounded-xl border hover:shadow-md transition flex justify-between items-center cursor-pointer group";
    card.onclick = () => openDetailView(u.id);
    card.innerHTML = `
      <div class="flex gap-4 items-center">
        <img src="${u.photoURL || 'https://i.imgur.com/6VBx3io.png'}" class="w-12 h-12 rounded-full border bg-gray-50 object-cover">
        <div>
          <p class="font-bold text-gray-800 group-hover:text-blue-600">${u.fullName || "User"}</p>
          <p class="text-xs text-gray-500">${u.position || u.education || "Professional"}</p>
        </div>
      </div>
      <button class="text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-xs font-bold">View</button>
    `;
    resultsView.appendChild(card);
  });
}

function openDetailView(userId) {
  const user = state.searchResults.find(u => u.id === userId);
  if (!user) return;
  resultsListContainer.classList.add('hidden');
  detailViewContainer.classList.remove('hidden');
  detailViewContainer.innerHTML = `
    <div class="h-24 bg-gray-50 border-b flex items-center px-6">
        <button onclick="showResultsList()" class="text-blue-600 font-bold text-sm flex items-center gap-1">‚Üê Back</button>
    </div>
    <div class="p-8">
        <div class="flex flex-col md:flex-row gap-6 items-center md:items-start text-center md:text-left">
            <img src="${user.photoURL || 'https://i.imgur.com/6VBx3io.png'}" class="w-24 h-24 rounded-full border-4 border-white shadow-lg">
            <div class="flex-1">
                <h2 class="text-3xl font-bold text-gray-900">${user.fullName}</h2>
                <p class="text-lg text-blue-600">${user.position || "Professional"}</p>
                <p class="text-gray-500 text-sm mt-1">${user.education} @ ${user.university}</p>
                <div class="mt-4 flex gap-2 justify-center md:justify-start">
                    <button class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-sm hover:bg-blue-700 transition">Connect</button>
                    <button class="px-6 py-2 border rounded-lg font-bold text-gray-600 hover:bg-gray-50 transition">Message</button>
                </div>
            </div>
        </div>
        <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 bg-gray-50 rounded-xl border">
                <span class="text-xs font-bold text-gray-400 uppercase">Experience</span>
                <p class="font-bold text-gray-800 mt-1">${user.expYears || "0"} Years</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-xl border">
                <span class="text-xs font-bold text-gray-400 uppercase">Education</span>
                <p class="font-bold text-gray-800 mt-1">${user.university}</p>
            </div>
        </div>
    </div>
  `;
}

function showResultsList() {
  detailViewContainer.classList.add('hidden');
  resultsListContainer.classList.remove('hidden');
}
</script>

</body>
</html>

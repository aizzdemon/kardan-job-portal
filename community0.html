<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Community - BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>

<!-- üî• Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, getDocs,
  doc, setDoc, getDoc, updateDoc, increment, serverTimestamp, limit, where
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'booter-space-app';

// Global access for button handlers
window.auth = auth;
window.db = db;

let currentUser = null;

// --- Auth Initialization (Rule 3) ---
const initAuth = async () => {
  try {
    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
      await signInWithCustomToken(auth, __initial_auth_token);
    } else {
      await signInAnonymously(auth);
    }
  } catch (err) {
    console.error("Auth failed:", err);
  }
};

onAuthStateChanged(auth, (user) => {
  currentUser = user;
  if (user) {
    // Ensuring the UI reacts to the user being ready
    loadPosts();
    loadSuggestions();
  }
});

initAuth();

/* ---------- POST ---------- */
window.postContent = async () => {
  if (!currentUser) return;

  const text = document.getElementById("postText").value.trim();
  if (!text) return;

  try {
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', "communityPosts"), {
      content: text,
      userId: currentUser.uid,
      userName: currentUser.displayName || "Anonymous Maker",
      userPhoto: currentUser.photoURL || "",
      likesCount: 0,
      dislikesCount: 0,
      timestamp: serverTimestamp()
    });

    document.getElementById("postText").value = "";
    loadPosts();
  } catch (e) {
    console.error("Post failed", e);
  }
};

/* ---------- LOAD POSTS ---------- */
async function loadPosts() {
  const wrap = document.getElementById("posts");
  wrap.innerHTML = '<div class="p-10 text-center text-gray-400">Loading feeds...</div>';

  try {
    // Fetching from the strict path mandated for public data
    const postsRef = collection(db, 'artifacts', appId, 'public', 'data', "communityPosts");
    const q = query(postsRef, orderBy("timestamp", "desc"));
    const snap = await getDocs(q);
    wrap.innerHTML = "";

    if (snap.empty) {
      wrap.innerHTML = `
        <div class="bg-white p-12 rounded-2xl text-center border border-dashed border-slate-300">
          <div class="text-4xl mb-4">üöÄ</div>
          <p class="text-slate-500 font-medium">No posts yet. Be the first to share your journey!</p>
        </div>`;
      return;
    }

    for (const d of snap.docs) {
      const p = d.data();
      const avatar = p.userPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.userName)}&background=random`;

      let reacted = null;
      try {
        const rSnap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', "communityPosts", d.id, "reactions", currentUser.uid));
        if (rSnap.exists()) reacted = rSnap.data().type;
      } catch(e) {}

      const postEl = document.createElement('div');
      postEl.className = "bg-white p-4 rounded-xl shadow-sm border mb-4 animate-in fade-in duration-500";
      postEl.innerHTML = `
          <div class="flex items-center gap-3 mb-3">
            <img src="${avatar}" class="w-10 h-10 rounded-full cursor-pointer object-cover border shadow-sm"
              onclick="openProfile('${p.userId}')" />
            <div>
              <p class="font-bold text-gray-800 text-sm cursor-pointer hover:underline"
                onclick="openProfile('${p.userId}')">${p.userName}</p>
              <p class="text-[10px] uppercase tracking-wider text-gray-400 font-medium">
                ${p.timestamp?.toDate().toLocaleString(undefined, {dateStyle: 'medium', timeStyle: 'short'}) || "Just now"}
              </p>
            </div>
          </div>

          <p class="text-gray-700 text-sm leading-relaxed mb-4">${p.content}</p>

          <div class="flex gap-6 border-t border-b py-2 mb-3">
            <button onclick="react('${d.id}','like')"
              class="flex items-center gap-1.5 transition-colors ${reacted==='like' ? 'text-red-500 scale-105' : 'text-gray-500 hover:text-red-400'}">
              <span class="text-lg">${reacted === 'like' ? '‚ù§Ô∏è' : 'ü§ç'}</span>
              <span class="text-xs font-bold">${p.likesCount ?? 0}</span>
            </button>

            <button onclick="react('${d.id}','dislike')"
              class="flex items-center gap-1.5 transition-colors ${reacted==='dislike' ? 'text-gray-800 scale-105' : 'text-gray-500 hover:text-gray-800'}">
              <span class="text-lg">üëé</span>
              <span class="text-xs font-bold">${p.dislikesCount ?? 0}</span>
            </button>
          </div>

          <div class="mt-3">
            <div id="comments-${d.id}" class="space-y-3 mb-3"></div>
            <div class="relative flex items-center">
              <input id="c-${d.id}"
                class="w-full bg-gray-50 border-none rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="Write a comment..."
                onkeydown="if(event.key==='Enter') addComment('${d.id}')" />
              <button onclick="addComment('${d.id}')" class="absolute right-2 text-blue-600 font-bold text-xs p-2">Send</button>
            </div>
          </div>
      `;
      wrap.appendChild(postEl);
      loadComments(d.id);
    }
  } catch (e) {
    console.error("Load posts error:", e);
    wrap.innerHTML = '<div class="p-10 text-center text-red-400 text-xs">Could not load feed. Please try again.</div>';
  }
}

/* ---------- SUGGESTIONS LOGIC ---------- */
window.loadSuggestions = async () => {
    const list = document.getElementById("suggestionList");
    if (!currentUser) return;

    list.innerHTML = `
      <div class="animate-pulse space-y-4">
          <div class="flex items-center gap-3"><div class="w-8 h-8 bg-slate-100 rounded-full"></div><div class="h-2 bg-slate-100 rounded w-1/2"></div></div>
          <div class="flex items-center gap-3"><div class="w-8 h-8 bg-slate-100 rounded-full"></div><div class="h-2 bg-slate-100 rounded w-1/2"></div></div>
      </div>`;

    try {
        const usersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', "users"));
        
        let allUsers = usersSnap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(u => u.id !== currentUser.uid);

        // Shuffle
        for (let i = allUsers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [allUsers[i], allUsers[j]] = [allUsers[j], allUsers[i]];
        }

        const suggestions = allUsers.slice(0, 5);

        if (suggestions.length === 0) {
            list.innerHTML = '<p class="text-[10px] text-gray-400">No suggestions available at the moment.</p>';
            return;
        }

        list.innerHTML = suggestions.map(user => `
            <div class="flex items-center gap-3 group animate-in fade-in duration-300">
                <img src="${user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || 'User')}&background=random`}" 
                     class="w-10 h-10 rounded-full border border-gray-100 shadow-sm object-cover" alt="User">
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-bold text-gray-800 truncate cursor-pointer hover:text-blue-600" 
                       onclick="openProfile('${user.id}')">${user.fullName || 'Anonymous'}</p>
                    <p class="text-[10px] text-gray-400 uppercase tracking-tighter">${user.bio || 'Maker'}</p>
                </div>
                <button onclick="connectUser('${user.id}')" id="btn-${user.id}" 
                  class="w-8 h-8 flex items-center justify-center rounded-full bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition-all duration-200 border border-blue-100 shadow-sm active:scale-90">
                    <span class="text-xl font-medium leading-none mb-0.5">+</span>
                </button>
            </div>
        `).join("");
    } catch (e) {
        list.innerHTML = '<p class="text-[10px] text-gray-400 italic">No makers found nearby.</p>';
    }
}

/* ---------- CONNECT ACTION ---------- */
window.connectUser = async (targetUid) => {
    if (!currentUser) return;
    const btn = document.getElementById(`btn-${targetUid}`);
    const originalHTML = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = `
      <svg class="animate-spin h-4 w-4 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>`;

    try {
        // Rule 1: Using strict path for private user data
        await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, "connections", targetUid), {
            connectedAt: serverTimestamp()
        });
        
        btn.classList.remove('bg-blue-50', 'text-blue-600', 'hover:bg-blue-600', 'hover:text-white', 'border-blue-100');
        btn.classList.add('bg-green-500', 'text-white', 'border-green-500');
        btn.innerHTML = `
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
          </svg>`;
          
        setTimeout(() => loadSuggestions(), 2000);
    } catch (e) {
        console.error("Connect error:", e);
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

/* ---------- REACT ---------- */
window.react = async (postId, type) => {
  if (!currentUser) return;

  const ref = doc(db, 'artifacts', appId, 'public', 'data', "communityPosts", postId, "reactions", currentUser.uid);
  try {
    const existing = await getDoc(ref);
    if (existing.exists()) return;

    await setDoc(ref, { type });
    const update = {};
    update[type === "like" ? "likesCount" : "dislikesCount"] = increment(1);
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', "communityPosts", postId), update);
    loadPosts();
  } catch(e) {}
};

/* ---------- COMMENTS ---------- */
window.addComment = async (postId) => {
  if (!currentUser) return;
  const input = document.getElementById(`c-${postId}`);
  const text = input.value.trim();
  if (!text) return;

  try {
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', "communityPosts", postId, "comments"), {
      text: text,
      userId: currentUser.uid,
      userName: currentUser.displayName || "User",
      userPhoto: currentUser.photoURL || "",
      timestamp: serverTimestamp()
    });
    input.value = "";
    loadComments(postId);
  } catch(e) {}
};

async function loadComments(postId) {
  const box = document.getElementById(`comments-${postId}`);
  try {
    const snap = await getDocs(query(collection(db, 'artifacts', appId, 'public', 'data', "communityPosts", postId, "comments"), orderBy("timestamp")));
    if (snap.empty) return;
    box.innerHTML = snap.docs.map(d => {
      const c = d.data();
      const av = c.userPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(c.userName)}&background=f0f2f5&color=1c1e21`;
      return `
        <div class="flex gap-2">
          <img src="${av}" class="w-7 h-7 rounded-full shadow-sm" />
          <div class="bg-gray-100 px-3 py-2 rounded-2xl flex-1">
            <p class="text-[11px] font-bold text-gray-900 leading-tight">${c.userName}</p>
            <p class="text-xs text-gray-700 mt-0.5">${c.text}</p>
          </div>
        </div>
      `;
    }).join("");
  } catch(e) {}
}

window.openProfile = (uid) => {
  console.log("Navigating to profile:", uid);
};
</script>

<style>
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-in { animation: fadeIn 0.4s ease-out forwards; }
    textarea { resize: none; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
</style>
</head>

<body class="bg-slate-50 font-sans text-slate-900 pb-20">

<header class="bg-white border-b py-8 px-4">
  <div class="max-w-6xl mx-auto flex flex-col items-center">
      <div class="bg-blue-600 text-white px-4 py-1 rounded-full text-[10px] font-black uppercase tracking-widest mb-3">Feed</div>
      <h1 class="text-4xl font-black tracking-tight">
        Booter<span class="text-blue-600">Space</span>
      </h1>
      <p class="text-gray-500 mt-2 text-sm font-medium text-center">Join the conversation with makers worldwide</p>
  </div>
</header>

<main class="max-w-6xl mx-auto mt-8 px-4 grid grid-cols-1 lg:grid-cols-12 gap-6">
  
  <!-- LEFT SIDEBAR: Suggestions -->
  <aside class="lg:col-span-3 hidden lg:block sticky top-8 h-fit">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
          <h2 class="font-black text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
            <span class="w-2 h-2 bg-blue-600 rounded-full"></span>
            Suggestions
          </h2>
          
          <div id="suggestionList" class="space-y-4">
              <!-- Loading state -->
              <div class="animate-pulse space-y-4">
                  <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-slate-100 rounded-full"></div>
                      <div class="h-2 bg-slate-100 rounded w-1/2"></div>
                  </div>
              </div>
          </div>

          <button onclick="loadSuggestions()" class="w-full mt-6 py-2 text-[11px] font-bold text-gray-500 border border-slate-100 rounded-lg hover:bg-slate-50 transition-colors">
              Shuffle suggestions
          </button>
      </div>

      <div class="mt-6 px-2 space-y-4">
          <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl p-4 text-white">
              <p class="text-[10px] font-black uppercase opacity-80 mb-1">Pro Tip</p>
              <p class="text-xs font-medium leading-relaxed">Connect more people to increase your visibility!</p>
          </div>
          <div class="flex flex-wrap gap-x-3 gap-y-1 text-[9px] text-gray-400 font-medium uppercase tracking-tighter">
              <a href="#" class="hover:underline">Privacy</a>
              <a href="#" class="hover:underline">Terms</a>
              <span>¬© 2024 BooterSpace</span>
          </div>
      </div>
  </aside>

  <!-- CENTER: MAIN FEED -->
  <div class="lg:col-span-9 xl:col-span-7">
    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 mb-6 transition-all focus-within:ring-2 focus-within:ring-blue-100">
      <div class="flex gap-4">
          <div class="h-10 w-10 bg-slate-100 rounded-full flex-shrink-0 flex items-center justify-center border border-slate-200">
              <span class="text-slate-400 text-xs">üë§</span>
          </div>
          <textarea id="postText" class="w-full bg-slate-50 border-none rounded-xl p-4 text-sm focus:ring-0 placeholder:text-slate-400"
            rows="3" placeholder="What's happening in your space?"></textarea>
      </div>
      <div class="mt-4 flex justify-between items-center border-t pt-4">
          <div class="flex gap-4 text-gray-400">
              <button class="hover:text-blue-600 transition-colors text-lg">üì∑</button>
              <button class="hover:text-blue-600 transition-colors text-lg">üîó</button>
          </div>
          <button onclick="postContent()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-full font-bold text-sm shadow-md transition-all active:scale-95">
            Post
          </button>
      </div>
    </div>

    <div id="posts" class="space-y-4"></div>
  </div>

  <!-- RIGHT SIDEBAR -->
  <aside class="hidden xl:block xl:col-span-2"></aside>

</main>

</body>
</html>

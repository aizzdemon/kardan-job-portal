<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Community - BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>

<!-- üî• Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, getDocs,
  doc, setDoc, getDoc, updateDoc, increment, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, (user) => {
  currentUser = user;
  loadPosts();
  loadSuggestions(true);
});

/* ================= POST ================= */
window.postContent = async () => {
  if (!currentUser) return alert("Login required");

  const textEl = document.getElementById("postText");
  const text = textEl.value.trim();
  if (!text) return;

  await addDoc(collection(db, "communityPosts"), {
    content: text,
    userId: currentUser.uid,
    userName: currentUser.displayName || "User",
    userPhoto: currentUser.photoURL || "",
    likesCount: 0,
    dislikesCount: 0,
    timestamp: serverTimestamp()
  });

  textEl.value = "";
  loadPosts();
};

/* ================= POSTS ================= */
async function loadPosts() {
  const wrap = document.getElementById("posts");
  wrap.innerHTML = '<div class="p-8 text-center text-gray-400">Loading feeds...</div>';

  const q = query(collection(db, "communityPosts"), orderBy("timestamp", "desc"));
  const snap = await getDocs(q);

  wrap.innerHTML = "";
  if (snap.empty) {
    wrap.innerHTML = '<div class="bg-white p-6 rounded-xl border text-center">No posts yet</div>';
    return;
  }

  for (const d of snap.docs) {
    const p = d.data();
    const avatar = p.userPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.userName)}`;

    const post = document.createElement("div");
    post.className = "bg-white p-4 rounded-xl border shadow-sm";

    post.innerHTML = `
      <div class="flex gap-3 mb-3">
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover cursor-pointer"
          onclick="openProfile('${p.userId}')">
        <div>
          <p class="font-bold text-sm cursor-pointer" onclick="openProfile('${p.userId}')">${p.userName}</p>
          <p class="text-[10px] text-gray-400">${p.timestamp?.toDate().toLocaleString() || "Just now"}</p>
        </div>
      </div>

      <p class="text-sm text-gray-700 mb-3">${p.content}</p>

      <div class="flex gap-6 border-t border-b py-2 mb-2">
        <button onclick="react('${d.id}','like')" class="text-gray-500 hover:text-red-500 flex gap-1">
          ‚ù§Ô∏è <span>${p.likesCount || 0}</span>
        </button>
        <button onclick="react('${d.id}','dislike')" class="text-gray-500 hover:text-gray-800 flex gap-1">
          üëé <span>${p.dislikesCount || 0}</span>
        </button>
      </div>

      <div id="comments-${d.id}" class="space-y-2"></div>
      <input id="c-${d.id}" placeholder="Write a comment..."
        class="w-full bg-gray-100 rounded-full px-4 py-2 text-sm"
        onkeydown="if(event.key==='Enter') addComment('${d.id}')">
    `;

    wrap.appendChild(post);
    loadComments(d.id);
  }
}

/* ================= COMMENTS ================= */
window.addComment = async (postId) => {
  const input = document.getElementById(`c-${postId}`);
  const text = input.value.trim();
  if (!text || !currentUser) return;

  await addDoc(collection(db, "communityPosts", postId, "comments"), {
    text,
    userId: currentUser.uid,
    userName: currentUser.displayName || "User",
    userPhoto: currentUser.photoURL || "",
    timestamp: serverTimestamp()
  });

  input.value = "";
  loadComments(postId);
};

async function loadComments(postId) {
  const box = document.getElementById(`comments-${postId}`);
  const snap = await getDocs(
    query(collection(db, "communityPosts", postId, "comments"), orderBy("timestamp"))
  );

  box.innerHTML = snap.docs.map(d => {
    const c = d.data();
    return `
      <div class="flex gap-2">
        <img src="${c.userPhoto || 'https://ui-avatars.com/api/?name=User'}"
          class="w-6 h-6 rounded-full">
        <div class="bg-gray-100 px-3 py-2 rounded-xl">
          <p class="text-[11px] font-bold">${c.userName}</p>
          <p class="text-xs">${c.text}</p>
        </div>
      </div>
    `;
  }).join("");
}

/* ================= REACT ================= */
window.react = async (postId, type) => {
  if (!currentUser) return;

  const ref = doc(db, "communityPosts", postId, "reactions", currentUser.uid);
  if ((await getDoc(ref)).exists()) return;

  await setDoc(ref, { type });

  await updateDoc(doc(db, "communityPosts", postId), {
    likesCount: type === "like" ? increment(1) : increment(0),
    dislikesCount: type === "dislike" ? increment(1) : increment(0)
  });

  loadPosts();
};

/* ================= SUGGESTIONS (FIXED SHUFFLE) ================= */
async function loadSuggestions(force = false) {
  const list = document.getElementById("suggestionList");
  if (!currentUser) return;

  list.innerHTML = '<p class="text-[10px] text-gray-400">Refreshing...</p>';

  const connectionsSnap = await getDocs(collection(db, "users", currentUser.uid, "connections"));
  const connectedIds = connectionsSnap.docs.map(d => d.id);
  connectedIds.push(currentUser.uid);

  const usersSnap = await getDocs(collection(db, "users"));

  let users = usersSnap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(u => !connectedIds.includes(u.id));

  // TRUE shuffle every click
  users.sort(() => Math.random() - 0.5);
  users = users.slice(0, 5);

  if (!users.length) {
    list.innerHTML = '<p class="text-[10px] text-gray-400">No suggestions</p>';
    return;
  }

  list.innerHTML = users.map(u => `
    <div class="flex items-center gap-3">
      <img src="${u.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.fullName || 'User')}`}"
        class="w-8 h-8 rounded-full">
      <div class="flex-1">
        <p class="text-xs font-bold cursor-pointer" onclick="openProfile('${u.id}')">
          ${u.fullName || 'Anonymous'}
        </p>
        <p class="text-[9px] text-gray-400">${u.bio || 'Maker'}</p>
      </div>
      <button onclick="connectUser('${u.id}')" class="text-blue-600 font-bold text-xs">+</button>
    </div>
  `).join("");
}

/* ================= CONNECT ================= */
window.connectUser = async (uid) => {
  if (!currentUser) return;

  await setDoc(doc(db, "users", currentUser.uid, "connections", uid), { at: serverTimestamp() });
  await setDoc(doc(db, "users", uid, "connections", currentUser.uid), { at: serverTimestamp() });

  loadSuggestions(true);
};

/* ================= PROFILE ================= */
window.openProfile = uid => location.href = `profile.html?uid=${uid}`;

</script>
</head>

<body class="bg-slate-50 pb-20">

<div id="navbar"></div>
<script>
fetch("navbar.html")
  .then(r => r.text())
  .then(h => document.getElementById("navbar").innerHTML = h);
</script>

<!-- UI remains exactly same -->
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jobs – BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<!-- ================= FIREBASE INIT (ONLY ONCE) ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

const app = initializeApp(firebaseConfig);

window.auth = getAuth(app);
window.db = getFirestore(app);
</script>

<style>
/* Flashing animation for the "New" badge */
.latest-badge {
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(0.95); }
  100% { opacity: 1; transform: scale(1); }
}
</style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

<!-- ================= NAVBAR ================= -->
<div id="navbar"></div>
<script>
fetch("navbar.html").then(r=>r.text()).then(html=>{
  document.getElementById("navbar").innerHTML = html;
  const s = document.createElement("script");
  s.type = "module";
  s.src = "navbar.js";
  document.body.appendChild(s);
}).catch(err => console.log("Navbar placeholder - file not found locally"));
</script>

<!-- ================= HEADER ================= -->
<header class="bg-white border-b">
  <div class="max-w-6xl mx-auto px-4 py-10 text-center">
    <h1 class="text-4xl font-extrabold">Explore <span class="text-blue-600">Careers</span></h1>
    <p class="text-gray-500 mt-2">Find the best jobs for you</p>

    <div class="bg-white p-2 rounded-2xl shadow-xl border max-w-5xl mx-auto mt-8">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
        <input id="searchInput" placeholder="Job title or company" class="md:col-span-4 p-4 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500">
        <input id="locationInput" placeholder="Location" class="md:col-span-3 p-4 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500">
        <select id="dateFilter" class="md:col-span-3 p-4 rounded-xl bg-gray-50 outline-none">
          <option value="all">Any time</option>
          <option value="1">24 Hours</option>
          <option value="7">7 Days</option>
          <option value="30">30 Days</option>
        </select>
        <button id="mainSearchBtn" class="md:col-span-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-colors">Search</button>
      </div>
    </div>
  </div>
</header>

<!-- ================= JOBS LIST ================= -->
<main class="max-w-5xl mx-auto px-4 py-10 flex-grow">
  <h2 id="jobCount" class="font-bold mb-6 text-gray-700 text-xl text-center md:text-left">Loading jobs…</h2>
  <div id="jobsList" class="space-y-6"></div>
  <div class="flex justify-center">
    <button id="loadMoreBtn" class="hidden mt-10 bg-white border px-8 py-3 rounded-xl hover:bg-gray-50 shadow-sm transition-all">Load More</button>
  </div>
</main>

<!-- ================= JOBS FIRESTORE ================= -->
<script type="module">
import { collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const db = window.db;

const jobsList = document.getElementById("jobsList");
const loadMoreBtn = document.getElementById("loadMoreBtn");
const jobCount = document.getElementById("jobCount");

const searchInput = document.getElementById("searchInput");
const locationInput = document.getElementById("locationInput");
const mainSearchBtn = document.getElementById("mainSearchBtn");

let allJobs = [], filteredJobs = [], visible = [], index = 0, pageSize = 6;

async function loadJobs() {
  try {
    // Note: This requires a Firestore index for status and timestamp
    const q = query(collection(db, "jobs"), where("status", "==", "approved"), orderBy("timestamp", "desc"));
    const snap = await getDocs(q);
    allJobs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    filteredJobs = [...allJobs];
    render();
  } catch (error) {
    console.error("Error loading jobs:", error);
    jobCount.innerText = "Error loading jobs. Please check console.";
  }
}

function render() {
  const next = filteredJobs.slice(index, index + pageSize);
  visible = visible.concat(next);
  
  // Clear list only on first load/filter
  if (index === 0) jobsList.innerHTML = "";

  visible.forEach(job => {
    // Check if job is "new" (posted in last 7 days)
    let isNew = false;
    if (job.timestamp) {
      const postDate = job.timestamp.toDate ? job.timestamp.toDate() : new Date(job.timestamp);
      const diffTime = Math.abs(new Date() - postDate);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      if (diffDays <= 7) isNew = true;
    }

    const logo = job.companyImageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(job.company)}&background=random`;
    const div = document.createElement("div");
    div.className = "bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow flex flex-col md:flex-row gap-4 items-start md:items-center relative overflow-hidden";
    
    // The "New" badge HTML
    const newBadge = isNew ? `<span class="latest-badge bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full absolute top-4 right-4 uppercase tracking-wider border border-green-200">New</span>` : '';

    div.innerHTML = `
      ${newBadge}
      <img src="${logo}" class="w-16 h-16 rounded-xl object-cover bg-gray-100" onerror="this.src='https://ui-avatars.com/api/?name=Company'">
      <div class="flex-1">
        <div class="flex items-center gap-2">
            <h3 class="font-bold text-lg text-gray-800">${job.title}</h3>
        </div>
        <p class="text-sm text-gray-500 mt-1">${job.company} • <span class="text-gray-400">${job.location || "Remote"}</span></p>
        <p class="text-blue-600 font-bold mt-2 text-sm">${job.salary || "Salary not disclosed"}</p>
      </div>
      <div class="flex gap-2 w-full md:w-auto">
        <button onclick="viewJob('${job.id}')" class="flex-1 md:flex-none bg-white border border-gray-200 text-gray-700 px-5 py-2 rounded-lg hover:bg-gray-50 font-medium text-sm transition-all">Details</button>
        <button onclick="applyJob('${job.id}')" class="flex-1 md:flex-none bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 font-bold text-sm shadow-sm transition-all">Apply Now</button>
      </div>`;
    jobsList.appendChild(div);
  });
  
  index += pageSize;
  loadMoreBtn.classList.toggle("hidden", index >= filteredJobs.length);
  jobCount.innerText = filteredJobs.length > 0 ? `${filteredJobs.length} jobs available` : "No jobs found";
}

function filterJobs() {
  const q = searchInput.value.toLowerCase();
  const l = locationInput.value.toLowerCase();
  filteredJobs = allJobs.filter(j => {
    const t = (j.title || "").toLowerCase();
    const c = (j.company || "").toLowerCase();
    const loc = (j.location || "").toLowerCase();
    return (t.includes(q) || c.includes(q)) && loc.includes(l);
  });
  visible = []; 
  index = 0;
  jobsList.innerHTML = "";
  render();
}

mainSearchBtn.onclick = filterJobs;
loadMoreBtn.onclick = render;

window.viewJob = id => location.href = `job-detail.html?id=${id}`;
window.applyJob = id => location.href = `job-detail.html?id=${id}`;

// Initialize
loadJobs();
</script>

</body>
</html>

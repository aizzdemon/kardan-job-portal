<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jobs – BooterSpace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- ================= FIREBASE SDKs ================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
            authDomain: "kar-kardan.firebaseapp.com",
            projectId: "kar-kardan",
            storageBucket: "kar-kardan.firebasestorage.app",
            messagingSenderId: "554147696994",
            appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to window for global access
        window.db = db;
        window.auth = auth;

        // Ensure Auth for Firestore Access
        signInAnonymously(auth).catch(err => console.error("Auth failed:", err));
    </script>

    <style>
        /* Flashing animation for the Fire/New badge */
        .latest-badge { 
            animation: flashRed 1s infinite alternate; 
        }
        @keyframes flashRed {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0.7; transform: scale(1.05); }
        }
        .suggestion-item:hover { background-color: #f3f4f6; cursor: pointer; }
        .dropdown-panel { display: none; z-index: 50; }
        .dropdown-panel.active { display: block; }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

<!-- ================= NAVBAR ================= -->
<div id="navbar"></div>
<script>
fetch("navbar.html").then(r=>r.text()).then(html=>{
  document.getElementById("navbar").innerHTML = html;
  const s = document.createElement("script");
  s.type = "module";
  s.src = "navbar.js";
  document.body.appendChild(s);
}).catch(err => console.log("Navbar placeholder - file not found locally"));
</script>

<!-- ================= HEADER ================= -->
<header class="bg-white border-b">
    <div class="max-w-6xl mx-auto px-4 py-10 text-center">
        <h1 class="text-4xl font-extrabold">Explore <span class="text-blue-600">Careers</span></h1>
        <p class="text-gray-500 mt-2">Find the best jobs for you</p>

        <div class="relative bg-white p-2 rounded-2xl shadow-xl border max-w-5xl mx-auto mt-8">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
                <!-- Search Input with Dropdown -->
                <div class="md:col-span-4 relative">
                    <input id="searchInput" autocomplete="off" placeholder="Job title or company" class="w-full p-4 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="suggestionsDropdown" class="dropdown-panel absolute top-full left-0 right-0 bg-white border border-gray-200 mt-1 rounded-xl shadow-lg overflow-hidden max-h-60 overflow-y-auto"></div>
                </div>
                
                <!-- Location Input with Dropdown -->
                <div class="md:col-span-3 relative">
                    <input id="locationInput" autocomplete="off" placeholder="Location" class="w-full p-4 rounded-xl bg-gray-50 outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="locationDropdown" class="dropdown-panel absolute top-full left-0 right-0 bg-white border border-gray-200 mt-1 rounded-xl shadow-lg overflow-hidden max-h-60 overflow-y-auto"></div>
                </div>

                <select id="dateFilter" class="md:col-span-3 p-4 rounded-xl bg-gray-50 outline-none">
                    <option value="all">Any time</option>
                    <option value="1">Last 24 Hours</option>
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                </select>
                <button id="mainSearchBtn" class="md:col-span-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-colors">Search</button>
            </div>
        </div>
    </div>
</header>

<!-- ================= JOBS LIST ================= -->
<main class="max-w-5xl mx-auto px-4 py-10 flex-grow">
    <div id="statusContainer" class="flex flex-col items-center justify-center py-10 hidden">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-500">Finding opportunities...</p>
    </div>

    <h2 id="jobCount" class="font-bold mb-6 text-gray-700 text-xl text-center md:text-left">Initializing...</h2>
    
    <div id="jobsList" class="grid grid-cols-1 gap-6"></div>
    
    <div class="flex justify-center">
        <button id="loadMoreBtn" class="hidden mt-10 bg-white border px-8 py-3 rounded-xl hover:bg-gray-50 shadow-sm transition-all font-medium">Load More</button>
    </div>
</main>

<script type="module">
import { collection, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const jobsListEl = document.getElementById("jobsList");
const loadMoreBtn = document.getElementById("loadMoreBtn");
const jobCountEl = document.getElementById("jobCount");
const searchInput = document.getElementById("searchInput");
const locationInput = document.getElementById("locationInput");
const dateFilter = document.getElementById("dateFilter");
const mainSearchBtn = document.getElementById("mainSearchBtn");
const suggestionsDropdown = document.getElementById("suggestionsDropdown");
const locationDropdown = document.getElementById("locationDropdown");
const loader = document.getElementById("statusContainer");

let allJobs = [];
let filteredJobs = [];
let pageSize = 10;
let currentLimit = 10;

// Helper: Format Dates
const isRecentlyPosted = (timestamp, days) => {
    if (!timestamp) return false;
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const diff = (new Date() - date) / (1000 * 60 * 60 * 24);
    return diff <= days;
};

// Start Real-time Listener
function initJobsSync() {
    loader.classList.remove("hidden");
    const q = query(collection(window.db, "jobs"), where("status", "==", "approved"));
    
    onSnapshot(q, (snapshot) => {
        allJobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        
        loader.classList.add("hidden");
        applyFilters();
    }, (error) => {
        console.error("Firestore Error:", error);
        jobCountEl.innerText = "Check your Firestore indexes.";
    });
}

function applyFilters() {
    const term = searchInput.value.toLowerCase();
    const loc = locationInput.value.toLowerCase();
    const days = dateFilter.value === "all" ? Infinity : parseInt(dateFilter.value);

    filteredJobs = allJobs.filter(job => {
        const matchesTerm = (job.title || "").toLowerCase().includes(term) || (job.company || "").toLowerCase().includes(term);
        const matchesLoc = (job.location || "").toLowerCase().includes(loc);
        const matchesDate = days === Infinity || isRecentlyPosted(job.timestamp, days);
        return matchesTerm && matchesLoc && matchesDate;
    });

    currentLimit = pageSize;
    renderJobs();
}

function renderJobs() {
    jobsListEl.innerHTML = "";
    const toShow = filteredJobs.slice(0, currentLimit);

    if (toShow.length === 0) {
        jobCountEl.innerText = "No jobs found matching your criteria.";
        return;
    }

    jobCountEl.innerText = `${filteredJobs.length} jobs available`;

    toShow.forEach(job => {
        const isNew = isRecentlyPosted(job.timestamp, 7);
        const logo = job.companyImageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(job.company || 'C')}&background=random&color=fff&size=128`;
        
        const card = document.createElement("div");
        card.className = "bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-all flex flex-col md:flex-row gap-5 items-start md:items-center relative";
        
        const fireIcon = `<svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.395 2.553a1 1 0 00-1.45-.385c-.345.23-.614.558-.822.88-.214.33-.403.713-.57 1.116-.334.804-.614 1.768-.84 2.734a31.365 31.365 0 00-.613 3.58 2.64 2.64 0 01-.945-1.067c-.328-.68-.398-1.334-.398-1.817a1 1 0 00-1.514-.857 4.028 4.028 0 00-1.174 1.4c-.393.749-.607 1.81-.607 3.487 0 3.113 2.458 5.636 5.5 5.636s5.5-2.523 5.5-5.636c0-1.11-.305-2.167-.834-3.074-1.058-1.817-2.344-3.203-3.539-4.26a1 1 0 00-.312-.17z" clip-rule="evenodd"></path></svg>`;
        
        card.innerHTML = `
            <div class="w-16 h-16 shrink-0 bg-gray-50 rounded-xl overflow-hidden border border-gray-100 flex items-center justify-center">
                <img src="${logo}" alt="${job.company}" class="w-full h-full object-cover" onerror="this.src='https://ui-avatars.com/api/?name=Company&background=E5E7EB'">
            </div>
            <div class="flex-1">
                <div class="flex items-center gap-2 flex-wrap">
                    <h3 class="font-bold text-lg text-gray-900 leading-tight">${job.title}</h3>
                    ${isNew ? `
                        <span class="latest-badge inline-flex items-center bg-red-100 text-red-600 text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-tighter border border-red-200">
                            ${fireIcon} New
                        </span>
                    ` : ''}
                </div>
                <div class="flex flex-wrap items-center gap-x-3 gap-y-1 mt-1 text-sm text-gray-500">
                    <span class="font-medium text-gray-700">${job.company}</span>
                    <span>•</span>
                    <span>${job.location || "Remote"}</span>
                    <span>•</span>
                    <span class="text-blue-600 font-semibold">${job.salary || "Salary Undisclosed"}</span>
                </div>
            </div>
            <div class="flex gap-2 w-full md:w-auto mt-4 md:mt-0">
                <button onclick="window.viewJob('${job.id}')" class="flex-1 md:flex-none px-5 py-2.5 bg-gray-50 text-gray-700 border border-gray-200 rounded-lg font-semibold hover:bg-gray-100 transition-colors">Details</button>
                <button onclick="window.applyJob('${job.id}')" class="flex-1 md:flex-none px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-sm hover:bg-blue-700 transition-colors">Apply Now</button>
            </div>
        `;
        jobsListEl.appendChild(card);
    });

    loadMoreBtn.classList.toggle("hidden", currentLimit >= filteredJobs.length);
}

// Live Suggestions for Search Input
searchInput.oninput = (e) => {
    const val = e.target.value.toLowerCase();
    locationDropdown.classList.remove("active"); // Close other dropdown
    
    if (val.length < 2) {
        suggestionsDropdown.classList.remove("active");
        return;
    }

    const suggestions = new Set();
    allJobs.forEach(j => {
        if (j.title?.toLowerCase().includes(val)) suggestions.add(j.title);
        if (j.company?.toLowerCase().includes(val)) suggestions.add(j.company);
    });

    const list = Array.from(suggestions).slice(0, 6);
    if (list.length > 0) {
        suggestionsDropdown.innerHTML = list.map(item => `
            <div class="suggestion-item p-3 text-sm text-gray-700 border-b border-gray-50 last:border-0" onclick="window.selectSuggestion('search', '${item.replace(/'/g, "\\'")}')">
                ${item}
            </div>
        `).join("");
        suggestionsDropdown.classList.add("active");
    } else {
        suggestionsDropdown.classList.remove("active");
    }
    applyFilters();
};

// Live Suggestions for Location Input
locationInput.oninput = (e) => {
    const val = e.target.value.toLowerCase();
    suggestionsDropdown.classList.remove("active"); // Close other dropdown
    
    if (val.length < 1) {
        locationDropdown.classList.remove("active");
        return;
    }

    const locSuggestions = new Set();
    allJobs.forEach(j => {
        if (j.location && j.location.toLowerCase().includes(val)) {
            locSuggestions.add(j.location);
        }
    });

    const list = Array.from(locSuggestions).slice(0, 6);
    if (list.length > 0) {
        locationDropdown.innerHTML = list.map(loc => `
            <div class="suggestion-item p-3 text-sm text-gray-700 border-b border-gray-50 last:border-0" onclick="window.selectSuggestion('location', '${loc.replace(/'/g, "\\'")}')">
                <svg class="w-3 h-3 inline mr-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                ${loc}
            </div>
        `).join("");
        locationDropdown.classList.add("active");
    } else {
        locationDropdown.classList.remove("active");
    }
    applyFilters();
};

window.selectSuggestion = (type, val) => {
    if (type === 'search') {
        searchInput.value = val;
        suggestionsDropdown.classList.remove("active");
    } else {
        locationInput.value = val;
        locationDropdown.classList.remove("active");
    }
    applyFilters();
};

// Global Listeners
mainSearchBtn.onclick = applyFilters;
dateFilter.onchange = applyFilters;
loadMoreBtn.onclick = () => {
    currentLimit += pageSize;
    renderJobs();
};

document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !suggestionsDropdown.contains(e.target)) {
        suggestionsDropdown.classList.remove("active");
    }
    if (!locationInput.contains(e.target) && !locationDropdown.contains(e.target)) {
        locationDropdown.classList.remove("active");
    }
});

window.viewJob = (id) => window.location.href = `job-detail.html?id=${id}`;
window.applyJob = (id) => window.location.href = `job-detail.html?id=${id}`;

setTimeout(initJobsSync, 500);

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Community â€“ BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
</head>

<body class="bg-gray-100 min-h-screen">

<div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 px-4">

  <!-- POSTS -->
  <div class="md:col-span-2 space-y-4" id="postFeed"></div>

  <!-- SUGGESTIONS -->
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="font-semibold mb-3">People you may know</h3>
    <div id="suggestionList" class="space-y-3 text-sm text-gray-500">
      Loading...
    </div>
  </div>

</div>

<!-- LOGIN MODAL -->
<div id="loginModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg w-80 text-center">
    <h2 class="font-semibold mb-2">Login required</h2>
    <p class="text-sm text-gray-500 mb-4">Login to connect with people</p>
    <a href="login.html"
       class="bg-blue-600 text-white px-4 py-2 rounded">Login</a>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import {
  getFirestore, collection, getDocs, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

/* FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

/* AUTH */
onAuthStateChanged(auth, (user) => {
  currentUser = user;
  loadPosts();
  loadSuggestions();
});

/* LOAD POSTS (READ ONLY FOR GUEST) */
async function loadPosts() {
  const feed = document.getElementById("postFeed");
  feed.innerHTML = "";

  const snap = await getDocs(collection(db, "communityPosts"));

  if (snap.empty) {
    feed.innerHTML = `<p class="text-gray-400 text-sm">No posts yet</p>`;
    return;
  }

  snap.forEach(d => {
    const p = d.data();
    feed.innerHTML += `
      <div class="bg-white p-4 rounded shadow">
        <p class="font-semibold">${p.userName || "User"}</p>
        <p class="text-sm text-gray-600">${p.text || ""}</p>
      </div>
    `;
  });
}

/* LOAD SUGGESTIONS */
async function loadSuggestions() {
  const box = document.getElementById("suggestionList");
  box.innerHTML = "";

  if (!currentUser) {
    box.innerHTML = `<p class="text-xs text-center">Login to see suggestions</p>`;
    return;
  }

  const usersSnap = await getDocs(collection(db, "users"));

  usersSnap.forEach(async d => {
    if (d.id === currentUser.uid) return;

    const isConn = await getDoc(
      doc(db, "users", currentUser.uid, "connections", d.id)
    );

    if (isConn.exists()) return;

    box.innerHTML += `
      <div class="flex justify-between items-center">
        <span>${d.data().fullName || "User"}</span>
        <button onclick="connectUser('${d.id}')"
          class="text-blue-600 font-semibold">+</button>
      </div>
    `;
  });
}

/* CONNECT */
window.connectUser = async (uid) => {
  if (!currentUser) {
    showLoginModal();
    return;
  }

  await setDoc(
    doc(db, "users", currentUser.uid, "connections", uid),
    { at: Date.now() }
  );
};

/* MODAL */
window.showLoginModal = () => {
  document.getElementById("loginModal").classList.remove("hidden");
};
</script>

</body>
</html>

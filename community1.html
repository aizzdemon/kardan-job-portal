<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Community - BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>

<!-- ðŸ”¥ Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, query, orderBy, getDocs,
  doc, setDoc, getDoc, updateDoc, increment, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, (user) => {
  currentUser = user;
  loadPosts();
  loadSuggestions();
});

/* ---------- POST ---------- */
window.postContent = async () => {
  if (!currentUser) return alert("Login required");

  const text = document.getElementById("postText").value.trim();
  if (!text) return;

  await addDoc(collection(db, "communityPosts"), {
    content: text,
    userId: currentUser.uid,
    userName: currentUser.displayName || "User",
    userPhoto: currentUser.photoURL || "",
    likesCount: 0,
    dislikesCount: 0,
    timestamp: serverTimestamp()
  });

  document.getElementById("postText").value = "";
  loadPosts();
};

/* ---------- LOAD POSTS ---------- */
async function loadPosts() {
  const wrap = document.getElementById("posts");
  wrap.innerHTML = '<div class="p-10 text-center text-gray-400">Loading feeds...</div>';

  const q = query(collection(db, "communityPosts"), orderBy("timestamp", "desc"));
  const snap = await getDocs(q);
  wrap.innerHTML = "";

  if (snap.empty) {
    wrap.innerHTML = '<div class="bg-white p-8 rounded-xl text-center border">No posts yet.</div>';
  }

  for (const d of snap.docs) {
    const p = d.data();
    const avatar = p.userPhoto || `https://ui-avatars.com/api/?name=${encodeURIComponent(p.userName)}&background=random`;

    const postEl = document.createElement("div");
    postEl.className = "bg-white p-4 rounded-xl shadow-sm border mb-4";
    postEl.innerHTML = `
      <div class="flex items-center gap-3 mb-3">
        <img src="${avatar}" class="w-10 h-10 rounded-full object-cover border" />
        <div>
          <p class="font-bold text-sm">${p.userName}</p>
        </div>
      </div>
      <p class="text-sm">${p.content}</p>
    `;
    wrap.appendChild(postEl);
  }
}

/* ---------- âœ… FIXED SUGGESTIONS ---------- */
async function loadSuggestions() {
  const list = document.getElementById("suggestionList");
  if (!currentUser) return;

  try {
    const connectionsSnap = await getDocs(
      collection(db, "users", currentUser.uid, "connections")
    );

    const connectedIds = connectionsSnap.docs.map(d => d.id);
    connectedIds.push(currentUser.uid);

    const usersSnap = await getDocs(collection(db, "users"));

    let suggestions = usersSnap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(user => !connectedIds.includes(user.id))
      .sort(() => 0.5 - Math.random())
      .slice(0, 5);

    if (suggestions.length === 0) {
      list.innerHTML = `<p class="text-xs text-gray-400">No suggestions found</p>`;
      return;
    }

    list.innerHTML = suggestions.map(user => `
      <div class="flex items-center gap-3">
        <img
          src="${
            user.profilePhoto ||
            `https://ui-avatars.com/api/?name=${encodeURIComponent(user.fullName || "User")}&background=random`
          }"
          class="w-8 h-8 rounded-full border object-cover"
        />
        <div class="flex-1 min-w-0">
          <p class="text-xs font-bold truncate cursor-pointer"
             onclick="openProfile('${user.id}')">
            ${user.fullName || "Anonymous"}
          </p>
          <p class="text-[9px] text-gray-400 uppercase">
            ${user.role || "Member"}
          </p>
        </div>
        <button onclick="connectUser('${user.id}')"
          id="btn-${user.id}"
          class="text-xs font-bold text-blue-600">+</button>
      </div>
    `).join("");

  } catch (e) {
    console.error(e);
    list.innerHTML = `<p class="text-xs text-gray-400">Error loading</p>`;
  }
}

/* ---------- CONNECT ---------- */
window.connectUser = async (targetUid) => {
  await setDoc(doc(db, "users", currentUser.uid, "connections", targetUid), {
    connectedAt: serverTimestamp()
  });
  await setDoc(doc(db, "users", targetUid, "connections", currentUser.uid), {
    connectedAt: serverTimestamp()
  });
  loadSuggestions();
};

/* ---------- PROFILE ---------- */
window.openProfile = (uid) => {
  window.location.href = `profile.html?uid=${uid}`;
};
</script>
</head>

<body class="bg-slate-50">

<aside>
  <div id="suggestionList" class="p-4 space-y-4"></div>
</aside>

</body>
</html>

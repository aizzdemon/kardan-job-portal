<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Job Details – BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase COMPAT (same as your job pages) -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

<style>
body { background:#f8fafc; font-family: 'Plus Jakarta Sans', sans-serif; }
.job-card { background:#fff; border-radius:24px; }
.gradient-border::after {
  content:'';
  position:absolute; top:0; left:0; right:0;
  height:6px;
  background:linear-gradient(90deg,#ef4444,#f87171);
  border-radius:24px 24px 0 0;
}
.shimmer {
  background: linear-gradient(90deg,#f1f5f9 25%,#e2e8f0 50%,#f1f5f9 75%);
  background-size:200% 100%;
  animation: shimmer 1.5s infinite;
}
@keyframes shimmer {
  0% { background-position:200% 0 }
  100% { background-position:-200% 0 }
}
</style>
</head>

<body class="min-h-screen bg-gray-50">

<!-- ================= NAVBAR (SAME AS INDEX) ================= -->
<div id="navbar"></div>
<script>
fetch("navbar.html").then(r=>r.text()).then(html=>{
  document.getElementById("navbar").innerHTML = html;
  const s = document.createElement("script");
  s.type = "module";
  s.src = "navbar.js";
  document.body.appendChild(s);
});
</script>

<!-- ================= HEADER ================= -->
<header class="bg-white border-b border-gray-200 py-10">
  <div class="max-w-7xl mx-auto px-4 text-center">
    <h1 class="text-3xl font-black tracking-tight text-gray-900 sm:text-4xl">
      Booter<span class="text-blue-600">Space</span>
    </h1>
    <p class="mt-2 text-sm text-gray-500 max-w-md mx-auto">
      Explore your career opportunities and community posts
    </p>
  </div>
</header>

<!-- ================= MAIN ================= -->
<main class="max-w-4xl mx-auto px-4 py-10">
  <div id="jobDetailsContent" class="job-card gradient-border p-6 md:p-10 relative">

    <!-- Skeleton -->
    <div class="space-y-6">
      <div class="h-48 shimmer rounded-2xl"></div>
      <div class="h-10 w-3/4 shimmer rounded"></div>
    </div>

  </div>
</main>

<script>
/* ---------- FIREBASE INIT ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

let currentUser = null;
let currentJobId = null;

auth.onAuthStateChanged(u => currentUser = u);

/* ---------- HELPERS ---------- */
function getJobId() {
  return new URLSearchParams(window.location.search).get("id");
}

function isAdmin() {
  return currentUser &&
    currentUser.uid === "nkXAUBb7ffZQ5CtyShWl6YcQ39t2";
}

/* ---------- LOAD JOB ---------- */
window.addEventListener("DOMContentLoaded", async () => {
  currentJobId = getJobId();
  if (!currentJobId) return renderError("Invalid Job ID");

  try {
    const snap = await db.collection("jobs").doc(currentJobId).get();

    if (!snap.exists) return renderError("Job not found");

    const job = snap.data();

    // UI-level safety (rules already enforce this)
    if (job.status !== "approved" && !isAdmin()) {
      return renderError("This job is not approved yet");
    }

    renderJob(job);
    checkSaved();

  } catch (e) {
    console.error(e);
    renderError(
      e.code === "permission-denied"
        ? "You are not allowed to view this job"
        : "Something went wrong"
    );
  }
});

/* ---------- RENDER JOB ---------- */
function renderJob(job) {
  document.getElementById("jobDetailsContent").innerHTML = `
    <h1 class="text-3xl font-extrabold mb-4">${job.title}</h1>

    <p class="text-lg text-slate-600 mb-6">
      ${job.company || "Company"} • ${job.location || "Remote"}
    </p>

    <p class="text-slate-600 mb-8 whitespace-pre-line">
      ${job.details || "No description provided."}
    </p>

    <div class="flex gap-4 flex-wrap">
      <button onclick="applyJob('${job.applyLink || ""}')"
        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold transition">
        Apply Now
      </button>

      <button id="saveBtn" onclick="toggleSaveJob()"
        class="border px-6 py-3 rounded-xl font-bold">
        <i class="fa-regular fa-bookmark"></i> Save
      </button>

      <button onclick="shareJob()"
        class="border px-6 py-3 rounded-xl font-bold">
        <i class="fa-solid fa-share-nodes"></i> Share
      </button>
    </div>
  `;
}

/* ---------- APPLY ---------- */
function applyJob(link) {
  if (!currentUser) {
    alert("Please login to apply");
    location.href = "login.html";
    return;
  }
  if (!link) return alert("Application link not available");
  window.open(link, "_blank");
}

/* ---------- SAVE JOB ---------- */
async function toggleSaveJob() {
  if (!currentUser) {
    alert("Login required");
    location.href = "login.html";
    return;
  }

  const ref = db
    .collection("users")
    .doc(currentUser.uid)
    .collection("savedJobs")
    .doc(currentJobId);

  const snap = await ref.get();

  if (snap.exists) {
    await ref.delete();
    saveBtn.innerHTML = `<i class="fa-regular fa-bookmark"></i> Save`;
  } else {
    await ref.set({
      jobId: currentJobId,
      savedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    saveBtn.innerHTML = `<i class="fa-solid fa-bookmark"></i> Saved`;
  }
}

/* ---------- CHECK SAVED ---------- */
async function checkSaved() {
  if (!currentUser) return;

  const ref = db
    .collection("users")
    .doc(currentUser.uid)
    .collection("savedJobs")
    .doc(currentJobId);

  if ((await ref.get()).exists) {
    saveBtn.innerHTML = `<i class="fa-solid fa-bookmark"></i> Saved`;
  }
}

/* ---------- SHARE ---------- */
function shareJob() {
  navigator.clipboard.writeText(window.location.href);
  alert("Job link copied!");
}

/* ---------- ERROR ---------- */
function renderError(msg) {
  document.getElementById("jobDetailsContent").innerHTML = `
    <p class="text-center text-red-600 font-bold text-lg">${msg}</p>
  `;
}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jobs â€“ BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<!-- ================= FIREBASE INIT (ONLY ONCE) ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

const app = initializeApp(firebaseConfig);
window.auth = getAuth(app);
window.db = getFirestore(app);
</script>

<style>
.latest-badge{animation:pulse 1s infinite;}
@keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
</style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

<!-- ================= NAVBAR ================= -->
<div id="navbar"></div>
<script>
fetch("navbar.html").then(r=>r.text()).then(html=>{
  document.getElementById("navbar").innerHTML = html;
  const s = document.createElement("script");
  s.type = "module";
  s.src = "navbar.js";
  document.body.appendChild(s);
});
</script>

<!-- ================= HEADER ================= -->
<header class="bg-white border-b">
  <div class="max-w-6xl mx-auto px-4 py-10 text-center">
    <h1 class="text-4xl font-extrabold">Explore <span class="text-blue-600">Careers</span></h1>
    <p class="text-gray-500 mt-2">Find the best jobs for you</p>

    <div class="bg-white p-2 rounded-2xl shadow-xl border max-w-5xl mx-auto mt-8">
      <div class="grid grid-cols-1 md:grid-cols-12 gap-2">
        <input id="searchInput" list="titleSuggestions" placeholder="Job title or company" class="md:col-span-4 p-4 rounded-xl bg-gray-50">
        <datalist id="titleSuggestions"></datalist>

        <input id="locationInput" list="locationSuggestions" placeholder="Location" class="md:col-span-3 p-4 rounded-xl bg-gray-50">
        <datalist id="locationSuggestions"></datalist>

        <select id="dateFilter" class="md:col-span-3 p-4 rounded-xl bg-gray-50">
          <option value="all">Any time</option>
          <option value="1">24 Hours</option>
          <option value="7">7 Days</option>
          <option value="30">30 Days</option>
        </select>
        <button id="mainSearchBtn" class="md:col-span-2 bg-blue-600 text-white font-bold rounded-xl">Search</button>
      </div>
    </div>
  </div>
</header>

<!-- ================= JOBS LIST ================= -->
<main class="max-w-5xl mx-auto px-4 py-10 flex-grow">

  <!-- TOTAL JOBS CARD -->
  <div class="bg-white border rounded-xl shadow p-6 mb-6 text-center">
    <p class="text-gray-500">Total Available Jobs</p>
    <h2 id="totalJobs" class="text-3xl font-extrabold text-blue-600">Loadingâ€¦</h2>
  </div>

  <h2 id="jobCount" class="font-bold mb-6">Loading jobsâ€¦</h2>

  <div id="jobsList" class="space-y-6"></div>

  <button id="loadMoreBtn" class="hidden mt-10 bg-white border px-8 py-3 rounded-xl mx-auto block">
    Load More
  </button>
</main>

<!-- ================= JOBS FIRESTORE ================= -->
<script type="module">
import {
 collection, query, where, orderBy, limit,
 getDocs, startAfter, getCountFromServer
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const db = window.db;

const jobsList = document.getElementById("jobsList");
const loadMoreBtn = document.getElementById("loadMoreBtn");
const jobCount = document.getElementById("jobCount");
const totalJobsEl = document.getElementById("totalJobs");

const titleSuggestions = document.getElementById("titleSuggestions");
const locationSuggestions = document.getElementById("locationSuggestions");

let allJobs = [];
let lastDoc = null;
const pageSize = 30; // ðŸ”¥ LOAD 30 FIRST

function isNewJob(timestamp){
 const now = Date.now();
 const jobTime = timestamp?.toMillis?.() || 0;
 return (now - jobTime) <= 7 * 24 * 60 * 60 * 1000;
}

/* ---------- TOTAL JOB COUNT ---------- */
async function loadTotalJobs(){
 const q = query(
  collection(db,"jobs"),
  where("status","==","approved")
 );
 const snap = await getCountFromServer(q);
 totalJobsEl.innerText = snap.data().count;
}

/* ---------- LOAD JOBS ---------- */
async function loadJobs(){
 let q = query(
  collection(db,"jobs"),
  where("status","==","approved"),
  orderBy("timestamp","desc"),
  limit(pageSize)
 );

 if(lastDoc) q = query(q, startAfter(lastDoc));

 const snap = await getDocs(q);

 if(snap.empty){
  loadMoreBtn.classList.add("hidden");
  return;
 }

 lastDoc = snap.docs[snap.docs.length - 1];

 snap.docs.forEach(d=>{
  const job = {id:d.id, ...d.data()};
  allJobs.push(job);
  renderJob(job);
  addSuggestions(job);
 });

 jobCount.innerText = `${allJobs.length} jobs loaded`;
 loadMoreBtn.classList.remove("hidden");
}

/* ---------- RENDER JOB ---------- */
function renderJob(job){
 const logo =
  job.logoUrl ||
  job.companyImageUrl ||
  `https://ui-avatars.com/api/?name=${job.company}`;

 const badge = isNewJob(job.timestamp)
  ? `<span class="latest-badge text-xs bg-red-500 text-white px-2 py-1 rounded-full">ðŸ”¥ NEW</span>`
  : "";

 const div = document.createElement("div");
 div.className="bg-white p-6 rounded-xl border shadow flex gap-4";

 div.innerHTML=`
 <img src="${logo}" class="w-16 h-16 rounded-xl">
 <div class="flex-1">
   <div class="flex items-center gap-2">
     <h3 class="font-bold text-lg">${job.title}</h3>
     ${badge}
   </div>
   <p class="text-sm text-gray-600">${job.company} â€¢ ${job.location||"Remote"}</p>
   <p class="text-blue-600 font-bold">${job.salary||""}</p>
 </div>
 <div class="flex flex-col gap-2">
   <button onclick="viewJob('${job.id}')" class="bg-white border px-4 py-2 rounded">View</button>
   <button onclick="applyJob('${job.id}')" class="bg-blue-600 text-white px-4 py-2 rounded">Apply</button>
 </div>`;
 jobsList.appendChild(div);
}

/* ---------- SUGGESTIONS ---------- */
function addSuggestions(job){
 if(job.title) titleSuggestions.innerHTML += `<option value="${job.title}">`;
 if(job.company) titleSuggestions.innerHTML += `<option value="${job.company}">`;
 if(job.location) locationSuggestions.innerHTML += `<option value="${job.location}">`;
}

loadMoreBtn.onclick = loadJobs;

window.viewJob = id => location.href = `job-detail.html?id=${id}`;
window.applyJob = id => location.href = `job-detail.html?id=${id}`;

/* ---------- INIT ---------- */
loadTotalJobs();
loadJobs();
</script>

</body>
</html>

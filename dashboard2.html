<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard - BooterSpace Job Portal</title>

<script src="https://cdn.tailwindcss.com"></script>
<!-- Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
body { font-family: 'Inter', sans-serif; }
.popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(3px); overflow-y: auto; padding: 20px 0; }
.popup { background: white; border-radius: 1rem; box-shadow: 0 15px 30px rgba(0,0,0,0.3); padding: 2rem; width: 95%; max-width: 600px; margin: auto; animation: fadeIn 0.3s ease-in-out; }
@keyframes fadeIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
</style>
</head>
<body class="bg-gray-100">

<!-- Navbar -->
<div id="navbar-placeholder"></div>

<!-- Header -->
<section class="text-center my-6">
    <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
    <p class="text-gray-500 mt-1">üëã Welcome, <span id="userName" class="font-semibold text-gray-800">Loading...</span></p>
    <p id="userEmail" class="text-gray-500 text-sm"></p>
</section>

<!-- Main Layout -->
<div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-6 px-4 mb-16">
    <div class="md:w-1/3 space-y-4">
        <div class="bg-white shadow rounded-xl p-5 text-center">
            <h4 class="text-lg font-semibold text-blue-600 mb-2">Your Applications</h4>
            <p class="text-gray-500">You haven‚Äôt applied for any jobs yet.</p>
            <a href="jobs.html" class="mt-2 inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-150">+ Find Jobs</a>
        </div>
        <div class="bg-white shadow rounded-xl p-5 text-center">
            <h4 class="text-lg font-semibold text-green-600 mb-2">Profile Management</h4>
            <p class="text-gray-500">Keep your profile up-to-date.</p>
            <button id="profileBtn" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-150">‚úèÔ∏è Edit Profile</button>
        </div>
        <div class="bg-white shadow rounded-xl p-5 text-center">
            <h4 class="text-lg font-semibold text-yellow-600 mb-2">Post a New Job</h4>
            <p class="text-gray-500">Share opportunities with others.</p>
            <button id="postJobBtn" class="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-150">üìù Post Job</button>
        </div>
    </div>
    <div id="postedJobsSection" class="md:w-2/3 bg-white p-6 rounded-xl shadow">
        <h4 class="font-bold text-2xl text-gray-800 mb-4">üìã Your Posted Jobs</h4>
        <div id="jobsList" class="space-y-4 text-sm text-gray-700">
            <p class='text-gray-500 text-center py-8'>Loading jobs...</p>
        </div>
        <div id="loadMoreContainer" class="text-center pt-4" style="display:none;">
            <button id="loadMoreBtn" onclick="loadMoreJobs()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold shadow-md">
                Load More Jobs
            </button>
        </div>
    </div>
</div>

<!-- Popups omitted for brevity; same as your original code -->

<footer class="text-center text-gray-500 py-8 text-sm">
    ¬© 2025 BooterSpace Job Portal
</footer>

<script>
// 1Ô∏è‚É£ Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
    authDomain: "kar-kardan.firebaseapp.com",
    projectId: "kar-kardan",
    storageBucket: "kar-kardan.firebasestorage.app",
    messagingSenderId: "554147696994",
    appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// 2Ô∏è‚É£ Load Navbar dynamically
async function loadNavbar() {
    try {
        const res = await fetch("navbar.html");
        const html = await res.text();
        document.getElementById("navbar-placeholder").innerHTML = html;

        // Inject navbar.js script after HTML loads
        const script = document.createElement("script");
        script.src = "navbar.js";
        document.body.appendChild(script);

        // Update UI immediately if user is already logged in
        if (auth.currentUser) updateNavbarUI(auth.currentUser);

    } catch(err) {
        console.error("Navbar failed:", err);
    }
}

// Update Navbar for logged-in user
function updateNavbarUI(user) {
    const desktopAuth = document.getElementById('auth-links-desktop');
    const mobileAuth = document.getElementById('auth-links-mobile');
    if (!desktopAuth || !mobileAuth) return;

    desktopAuth.innerHTML = `
        <a href="dashboard.html" class="text-blue-600 font-bold">Dashboard</a>
        <button onclick="handleLogout()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">Logout</button>
    `;
    mobileAuth.innerHTML = `
        <a href="dashboard.html" class="block py-2 text-blue-600 font-bold">Dashboard</a>
        <button onclick="handleLogout()" class="block w-full text-left py-2 text-red-600 font-medium">Logout</button>
    `;
}

// Logout
window.handleLogout = () => auth.signOut().then(()=>window.location.href='index.html');

// 3Ô∏è‚É£ Auth state
auth.onAuthStateChanged(user => {
    if (!user) return window.location.href='login.html';
    updateNavbarUI(user);
    loadProfile(user);
    loadUserJobs(user.uid);
});

// 4Ô∏è‚É£ Load user profile
function getProfileDoc(uid) { 
    return db.collection('users').doc(uid); 
}

function loadProfile(user) {
    getProfileDoc(user.uid).get().then(docSnap => {
        let name = user.displayName || user.email?.split('@')[0] || 'User';
        if (docSnap.exists) name = docSnap.data().fullName || name;

        document.getElementById('userName').innerText = name;
        document.getElementById('userEmail').innerText = user.email;
        if(docSnap.exists) {
            document.getElementById('profileName').value = docSnap.data().fullName || '';
            document.getElementById('profileExperience').value = docSnap.data().experience || '';
            document.getElementById('profileEducation').value = docSnap.data().education || '';
        }
    });
}

// 5Ô∏è‚É£ Load user's posted jobs
let allJobs = [];
let jobsToShow = 10;
function getJobsCollection() { return db.collection('jobs'); }

function loadUserJobs(uid) {
    getJobsCollection().where('userId', '==', uid)
        .orderBy('timestamp', 'desc')
        .onSnapshot(snap => {
            allJobs = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderJobs();
        });
}

function renderJobs() {
    const list = document.getElementById('jobsList');
    list.innerHTML = '';
    const slice = allJobs.slice(0, jobsToShow);

    if(!slice.length) {
        list.innerHTML = `<p class="text-center py-8 text-gray-500">No jobs posted yet.</p>`;
        document.getElementById('loadMoreContainer').style.display = 'none';
        return;
    }

    slice.forEach(job => {
        const div = document.createElement('div');
        const statusClass = job.status==='approved'?'text-green-600':'text-yellow-600';
        div.className = "border p-4 rounded-lg bg-gray-50 flex justify-between items-center shadow-sm";
        div.innerHTML = `
            <div>
                <h5 class="font-bold text-lg">${job.title}</h5>
                <p class="text-gray-600 text-sm">${job.companyName} ‚Ä¢ ${job.location}</p>
                <p class="text-xs font-semibold mt-1 ${statusClass}">Status: ${job.status || 'pending'}</p>
            </div>
            <button onclick="deleteJob('${job.id}')" class="text-red-500 hover:text-red-700 font-medium hover:underline">Delete</button>
        `;
        list.appendChild(div);
    });

    document.getElementById('loadMoreContainer').style.display = allJobs.length>jobsToShow?'block':'none';
}

window.deleteJob = async (id) => {
    if(confirm("Are you sure you want to delete this job posting?")) {
        try { await getJobsCollection().doc(id).delete(); }
        catch(err){ alert("Delete failed."); console.error(err); }
    }
};
window.loadMoreJobs = ()=>{ jobsToShow+=10; renderJobs(); };

// 6Ô∏è‚É£ Show popups
document.getElementById('profileBtn').onclick = ()=>document.getElementById('profilePopup').style.display='flex';
document.getElementById('postJobBtn').onclick = ()=>document.getElementById('postJobPopup').style.display='flex';

document.getElementById('profileForm').onsubmit = async e=>{
    e.preventDefault();
    const user = auth.currentUser; if(!user) return;
    try {
        await getProfileDoc(user.uid).set({
            fullName: document.getElementById('profileName').value,
            experience: document.getElementById('profileExperience').value,
            education: document.getElementById('profileEducation').value
        }, {merge:true});
        document.getElementById('profilePopup').style.display='none';
        loadProfile(user);
    } catch(err){ console.error(err); }
};

document.getElementById('postJobForm').onsubmit = async e=>{
    e.preventDefault();
    const user = auth.currentUser; if(!user) return;
    try {
        await getJobsCollection().add({
            title: document.getElementById('jobTitle').value,
            companyName: document.getElementById('jobCompanyName').value,
            employmentType: document.getElementById('jobEmploymentType').value,
            location: document.getElementById('jobLocation').value,
            applyLink: document.getElementById('jobApplyLink').value,
            details: document.getElementById('jobDetails').value,
            userId: user.uid,
            status: "pending",
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('postJobPopup').style.display='none';
        document.getElementById('postJobForm').reset();
    } catch(err){ console.error(err); alert("Failed to post job"); }
};

// ‚úÖ Load navbar on start
loadNavbar();

</script>
</body>
</html>

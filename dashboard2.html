<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - BooterSpace Job Portal</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            backdrop-filter: blur(3px);
            overflow-y: auto;
            padding: 20px 0;
        }
        .popup {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            padding: 2rem;
            width: 95%;
            max-width: 600px;
            margin: auto;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- Navbar Container -->
<div id="navbar-placeholder"></div>

<!-- Header -->
<section class="text-center my-6">
    <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
    <p class="text-gray-500 mt-1">üëã Welcome, <span id="userName" class="font-semibold text-gray-800">Loading...</span></p>
    <p id="userEmail" class="text-gray-500 text-sm"></p>
</section>

<!-- Main Layout -->
<div class="max-w-6xl mx-auto flex flex-col md:flex-row gap-6 px-4 mb-16">
    <!-- Left Column -->
    <div class="md:w-1/3 space-y-4">
        <div class="bg-white shadow rounded-xl p-5 text-center">
            <h4 class="text-lg font-semibold text-blue-600 mb-2">Your Applications</h4>
            <p class="text-gray-500">You haven‚Äôt applied for any jobs yet.</p>
            <a href="jobs.html" class="mt-2 inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-150">+ Find Jobs</a>
        </div>

        <div class="bg-white shadow rounded-xl p-5 text-center">
            <h4 class="text-lg font-semibold text-red-600 mb-2">Saved Jobs</h4>
            <p class="text-gray-500">No saved jobs yet.</p>
            <a href="jobs.html" class="mt-2 inline-block bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-150">üîç Browse Listings</a>
        </div>

        <div class="bg-white shadow rounded-xl p-5 text-center">
            <h4 class="text-lg font-semibold text-green-600 mb-2">Profile Management</h4>
            <p class="text-gray-500">Keep your profile up-to-date.</p>
            <button id="profileBtn" class="mt-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-150">‚úèÔ∏è Edit Profile</button>
        </div>

        <div class="bg-white shadow rounded-xl p-5 text-center">
            <h4 class="text-lg font-semibold text-yellow-600 mb-2">Post a New Job</h4>
            <p class="text-gray-500">Share opportunities with others.</p>
            <button id="postJobBtn" class="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition duration-150">üìù Post Job</button>
        </div>
    </div>

    <!-- Right Column -->
    <div id="postedJobsSection" class="md:w-2/3 bg-white p-6 rounded-xl shadow">
        <h4 class="font-bold text-2xl text-gray-800 mb-4">üìã Your Posted Jobs</h4>
        <div id="jobsList" class="space-y-4 text-sm text-gray-700">
            <p class='text-gray-500 text-center py-8'>Loading jobs...</p>
        </div>
        <!-- Load More Button -->
        <div id="loadMoreContainer" class="text-center pt-4" style="display:none;">
            <button id="loadMoreBtn" onclick="loadMoreJobs()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition duration-150 font-semibold shadow-md">
                Load More Jobs
            </button>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="profilePopup" class="popup-overlay">
    <div class="popup">
        <h3 class="text-xl font-bold mb-4 text-center text-gray-800">üë§ Edit Profile</h3>
        <form id="profileForm" class="space-y-3">
            <div><label class="block mb-1 font-medium">Full Name</label><input type="text" id="profileName" class="w-full border rounded-lg p-2" required /></div>
            <div><label class="block mb-1 font-medium">Email</label><input type="email" id="profileEmail" class="w-full border rounded-lg p-2 bg-gray-100" disabled /></div>
            <div><label class="block mb-1 font-medium">Experience</label><input type="text" id="profileExperience" class="w-full border rounded-lg p-2" placeholder="e.g., 2 years in Sales" /></div>
            <div><label class="block mb-1 font-medium">Education</label><input type="text" id="profileEducation" class="w-full border rounded-lg p-2" placeholder="e.g., B.Tech, XYZ University" /></div>
            <div class="flex justify-between pt-3">
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">üíæ Save Changes</button>
                <button type="button" onclick="document.getElementById('profilePopup').style.display='none'" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div id="postJobPopup" class="popup-overlay">
    <div class="popup">
        <h3 class="text-xl font-bold mb-4 text-center text-gray-800">üìù Post a New Job</h3>
        <form id="postJobForm" class="space-y-3">
            <div><label class="block mb-1 font-medium">Job Title</label><input type="text" id="jobTitle" class="w-full border rounded-lg p-2" required /></div>
            <div><label class="block mb-1 font-medium">Company Name</label><input type="text" id="jobCompanyName" class="w-full border rounded-lg p-2" required /></div>
            <div>
                <label class="block mb-1 font-medium">Employment Type</label>
                <select id="jobEmploymentType" class="w-full border rounded-lg p-2" required>
                    <option value="">Select Type *</option>
                    <option value="Full-time">Full-time</option>
                    <option value="Part-time">Part-time</option>
                    <option value="Internship">Internship</option>
                </select>
            </div>
            <div><label class="block mb-1 font-medium">Salary Range (Optional)</label><input type="text" id="jobSalary" class="w-full border rounded-lg p-2" /></div>
            <div><label class="block mb-1 font-medium">Location</label><input type="text" id="jobLocation" class="w-full border rounded-lg p-2" required /></div>
            <div><label class="block mb-1 font-medium">Application Link</label><input type="url" id="jobApplyLink" class="w-full border rounded-lg p-2" required /></div>
            <div><label class="block mb-1 font-medium">Company Logo URL (Optional)</label><input type="url" id="jobCompanyImageUrl" class="w-full border rounded-lg p-2" /></div>
            <div><label class="block mb-1 font-medium">Job Header Image URL (Optional)</label><input type="url" id="jobJobImageUrl" class="w-full border rounded-lg p-2" /></div>
            <div><label class="block mb-1 font-medium">Job Details / Description</label><textarea id="jobDetails" rows="4" class="w-full border rounded-lg p-2" required></textarea></div>
            <div class="flex justify-between pt-3">
                <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg">üöÄ Publish Job</button>
                <button type="button" onclick="document.getElementById('postJobPopup').style.display='none'" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Job Popup -->
<div id="editJobPopup" class="popup-overlay">
    <div class="popup">
        <h3 class="text-xl font-bold mb-4 text-center text-gray-800">‚úçÔ∏è Edit Job Posting</h3>
        <form id="editJobForm" class="space-y-3">
            <input type="hidden" id="editJobId" />
            <div><label class="block mb-1 font-medium">Job Title</label><input type="text" id="editJobTitle" class="w-full border rounded-lg p-2" required /></div>
            <div><label class="block mb-1 font-medium">Company Name</label><input type="text" id="editJobCompanyName" class="w-full border rounded-lg p-2" required /></div>
            <div>
                <label class="block mb-1 font-medium">Employment Type</label>
                <select id="editJobEmploymentType" class="w-full border rounded-lg p-2" required>
                    <option value="">Select Type *</option>
                    <option value="Full-time">Full-time</option>
                    <option value="Part-time">Part-time</option>
                    <option value="Internship">Internship</option>
                </select>
            </div>
            <div><label class="block mb-1 font-medium">Salary Range (Optional)</label><input type="text" id="editJobSalary" class="w-full border rounded-lg p-2" /></div>
            <div><label class="block mb-1 font-medium">Location</label><input type="text" id="editJobLocation" class="w-full border rounded-lg p-2" required /></div>
            <div><label class="block mb-1 font-medium">Application Link</label><input type="url" id="editJobApplyLink" class="w-full border rounded-lg p-2" required /></div>
            <div><label class="block mb-1 font-medium">Company Logo URL (Optional)</label><input type="url" id="editJobCompanyImageUrl" class="w-full border rounded-lg p-2" /></div>
            <div><label class="block mb-1 font-medium">Job Header Image URL (Optional)</label><input type="url" id="editJobJobImageUrl" class="w-full border rounded-lg p-2" /></div>
            <div><label class="block mb-1 font-medium">Job Details / Description</label><textarea id="editJobDetails" rows="4" class="w-full border rounded-lg p-2" required></textarea></div>
            <div class="flex justify-between pt-3">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">‚úÖ Update Job</button>
                <button type="button" onclick="document.getElementById('editJobPopup').style.display='none'" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg">Cancel</button>
            </div>
        </form>
    </div>
</div>

<footer class="text-center text-gray-500 py-8 text-sm">
    ¬© 2025 BooterSpace Job Portal
</footer>

<script>
/* Global Variables for Firestore Paths */
const appId = typeof __app_id !== 'undefined' ? __app_id : 'booterspace-job-portal';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
    apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
    authDomain: "kar-kardan.firebaseapp.com",
    projectId: "kar-kardan",
    storageBucket: "kar-kardan.firebasestorage.app",
    messagingSenderId: "554147696994",
    appId: "1:554147696994:web:221dcb883e3b65dcea5c3b",
    measurementId: "G-RRC3X485KQ"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let allJobs = [];
const JOB_LIMIT = 10;
let jobsToShow = JOB_LIMIT;

const $id = (id) => document.getElementById(id);

/* Load External Navbar */
async function loadNavbar() {
    try {
        const response = await fetch("navbar.html");
        const html = await response.text();
        document.getElementById("navbar-placeholder").innerHTML = html;
        
        // After loading HTML, we need to load navbar.js for interactivity
        const script = document.createElement("script");
        script.type = "module";
        script.src = "navbar.js";
        document.body.appendChild(script);

        // Re-run the auth UI update once navbar elements exist
        if (auth.currentUser) {
            // Give a small delay for DOM to settle
            setTimeout(() => updateNavbarUI(auth.currentUser), 100);
        }
    } catch (err) {
        console.error("Failed to load navbar:", err);
    }
}

// Function to update dynamic auth links inside the loaded navbar
function updateNavbarUI(user) {
    const desktopAuth = $id('auth-links-desktop');
    const mobileAuth = $id('auth-links-mobile');
    
    if (!desktopAuth || !mobileAuth) return;

    if (user) {
        desktopAuth.innerHTML = `
            <a href="dashboard.html" class="text-blue-600 font-bold">Dashboard</a>
            <button onclick="logout()" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition">Logout</button>
        `;
        mobileAuth.innerHTML = `
            <a href="dashboard.html" class="block py-2 text-blue-600 font-bold">Dashboard</a>
            <button onclick="logout()" class="block w-full text-left py-2 text-red-600 font-medium">Logout</button>
        `;
    }
}

window.logout = () => {
    auth.signOut().then(() => {
        window.location.href = 'index.html';
    });
};

/* Auth Guard & Initialization */
auth.onAuthStateChanged(async (user) => {
    updateNavbarUI(user);
    if (!user) {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
                await auth.signInWithCustomToken(__initial_auth_token);
            } catch (e) {
                console.error("Auth error", e);
                window.location.href = 'login.html';
            }
        } else {
             window.location.href = 'login.html';
        }
        return;
    }
    loadProfile(user);
    loadJobs(user.uid);
});

/* Paths following MANDATORY RULE 1 */
const getProfileDoc = (uid) => db.collection('artifacts').doc(appId).collection('users').doc(uid).collection('profile').doc('info');
const getJobsCollection = () => db.collection('artifacts').doc(appId).collection('public').doc('data').collection('jobs');

/* Profile Handling */
function loadProfile(user) {
    if ($id('profileEmail')) $id('profileEmail').value = user.email || 'Anonymous';
    getProfileDoc(user.uid).get().then(doc => {
        let name = (user.email || 'User').split('@')[0];
        if (doc.exists) {
            const data = doc.data();
            name = data.fullName || name;
            $id('profileName').value = data.fullName || '';
            $id('profileExperience').value = data.experience || '';
            $id('profileEducation').value = data.education || '';
        }
        $id('userName').innerText = name;
        $id('userEmail').innerText = user.email || 'Anonymous Access';
    }).catch(err => console.error("Error loading profile:", err));
}

$id('profileBtn').onclick = () => $id('profilePopup').style.display = 'flex';
$id('profileForm').onsubmit = async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return;
    try {
        await getProfileDoc(user.uid).set({
            fullName: $id('profileName').value,
            experience: $id('profileExperience').value,
            education: $id('profileEducation').value,
            email: user.email || 'anonymous'
        }, { merge: true });
        $id('profilePopup').style.display = 'none';
        loadProfile(user);
    } catch (err) {
        console.error("Error saving profile:", err);
    }
};

/* Job Management */
$id('postJobBtn').onclick = () => $id('postJobPopup').style.display = 'flex';
$id('postJobForm').onsubmit = async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) return;
    
    const jobData = {
        title: $id('jobTitle').value,
        companyName: $id('jobCompanyName').value,
        employmentType: $id('jobEmploymentType').value,
        salary: $id('jobSalary').value,
        location: $id('jobLocation').value,
        applyLink: $id('jobApplyLink').value,
        companyImageUrl: $id('jobCompanyImageUrl').value,
        jobImageUrl: $id('jobJobImageUrl').value,
        details: $id('jobDetails').value,
        postedBy: user.uid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    try {
        await getJobsCollection().add(jobData);
        $id('postJobPopup').style.display = 'none';
        $id('postJobForm').reset();
    } catch (err) {
        console.error("Error posting job:", err);
    }
};

window.openEditJobPopup = async (jobId) => {
    try {
        const doc = await getJobsCollection().doc(jobId).get();
        const job = doc.data();
        $id('editJobId').value = jobId;
        $id('editJobTitle').value = job.title;
        $id('editJobCompanyName').value = job.companyName;
        $id('editJobEmploymentType').value = job.employmentType;
        $id('editJobSalary').value = job.salary;
        $id('editJobLocation').value = job.location;
        $id('editJobApplyLink').value = job.applyLink;
        $id('editJobCompanyImageUrl').value = job.companyImageUrl;
        $id('editJobJobImageUrl').value = job.jobImageUrl;
        $id('editJobDetails').value = job.details;
        $id('editJobPopup').style.display = 'flex';
    } catch (err) {
        console.error("Error opening edit popup:", err);
    }
};

$id('editJobForm').onsubmit = async (e) => {
    e.preventDefault();
    const id = $id('editJobId').value;
    try {
        await getJobsCollection().doc(id).update({
            title: $id('editJobTitle').value,
            companyName: $id('editJobCompanyName').value,
            employmentType: $id('editJobEmploymentType').value,
            salary: $id('editJobSalary').value,
            location: $id('editJobLocation').value,
            applyLink: $id('editJobApplyLink').value,
            companyImageUrl: $id('editJobCompanyImageUrl').value,
            jobImageUrl: $id('editJobJobImageUrl').value,
            details: $id('editJobDetails').value
        });
        $id('editJobPopup').style.display = 'none';
    } catch (err) {
        console.error("Error updating job:", err);
    }
};

async function deleteJob(id) {
    if (confirm("Delete this posting?")) {
        try {
            await getJobsCollection().doc(id).delete();
        } catch (err) {
            console.error("Error deleting job:", err);
        }
    }
}

/* Rendering */
function loadJobs(uid) {
    getJobsCollection().onSnapshot(snap => {
        allJobs = snap.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(job => job.postedBy === uid)
            .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
        renderJobs();
    }, (error) => {
        console.error("Snapshot error:", error);
        $id('jobsList').innerHTML = `<p class='text-red-500 text-center py-8'>Permission Error: ${error.message}</p>`;
    });
}

function renderJobs() {
    const list = $id('jobsList');
    list.innerHTML = '';
    const slice = allJobs.slice(0, jobsToShow);

    if (!slice.length) {
        list.innerHTML = `<p class="text-center py-8 text-gray-500">No jobs posted yet.</p>`;
        $id('loadMoreContainer').style.display = 'none';
        return;
    }

    slice.forEach(job => {
        const item = document.createElement('div');
        item.className = "border p-4 rounded-lg bg-gray-50 flex flex-wrap justify-between items-center gap-4 shadow-sm";
        item.innerHTML = `
            <div>
                <h5 class="font-bold text-lg">${job.title}</h5>
                <p class="text-gray-600 text-sm">${job.companyName} ‚Ä¢ ${job.location}</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openEditJobPopup('${job.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 transition">Edit</button>
                <button onclick="deleteJob('${job.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition">Delete</button>
            </div>
        `;
        list.appendChild(item);
    });

    $id('loadMoreContainer').style.display = allJobs.length > jobsToShow ? 'block' : 'none';
    if ($id('loadMoreBtn')) {
        $id('loadMoreBtn').innerText = `Load More (${allJobs.length - jobsToShow} left)`;
    }
}

window.loadMoreJobs = () => {
    jobsToShow += JOB_LIMIT;
    renderJobs();
};

// Initialize navbar load
window.addEventListener('DOMContentLoaded', loadNavbar);

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Jobs â€“ BooterSpace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<!-- ================= FIREBASE INIT (ONLY ONCE) ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
import { getFirestore, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b"
};

const app = initializeApp(firebaseConfig);
window.auth = getAuth(app);
const db = getFirestore(app);
window.db = db;

// Fix latency: Enable Offline Persistence (Cache)
enableIndexedDbPersistence(db).catch((err) => {
    if (err.code == 'failed-precondition') {
        console.warn("Multiple tabs open, persistence can only be enabled in one tab at a time.");
    } else if (err.code == 'unimplemented') {
        console.warn("The current browser does not support all of the features required to enable persistence");
    }
});
</script>

<style>
.latest-badge{animation:pulse 1s infinite;}
@keyframes pulse{0%{opacity:1}50%{opacity:.4}100%{opacity:1}}
/* Skeleton loader for latency perception */
.skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* Ensure datalist dropdowns are properly constrained */
input::-webkit-calendar-picker-indicator {
  display: none !important;
}

/* Hide clear button by default */
.clear-btn { display: none; }
input:not(:placeholder-shown) + .clear-btn { display: flex; }
</style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">

<!-- ================= NAVBAR ================= -->
<div id="navbar"></div>
<script>
fetch("navbar.html").then(r=>r.text()).then(html=>{
  document.getElementById("navbar").innerHTML = html;
  const s = document.createElement("script");
  s.type = "module";
  s.src = "navbar.js";
  document.body.appendChild(s);
}).catch(e => console.error("Navbar failed to load"));
</script>

<!-- ================= HEADER ================= -->
<header class="bg-white border-b">
  <div class="max-w-6xl mx-auto px-4 py-10 text-center">
    <h1 class="text-4xl font-extrabold">Explore <span class="text-blue-600">Careers</span></h1>
    <p class="text-gray-500 mt-2">Find the best jobs for you</p>

    <!-- Unified Search Bar Container -->
    <div class="bg-white p-2 rounded-2xl shadow-xl border max-w-5xl mx-auto mt-8">
      <div class="flex flex-col md:flex-row gap-2">
        
        <!-- Job Search Column -->
        <div class="relative flex-1 md:w-4/12 flex items-center">
          <input id="searchInput" list="titleSuggestions" placeholder="Job title or company" 
                 class="w-full p-4 pr-10 rounded-xl bg-gray-50 border border-transparent focus:border-blue-500 focus:bg-white outline-none transition">
          <button onclick="resetInput('searchInput')" class="clear-btn absolute right-3 text-gray-400 hover:text-gray-600 w-6 h-6 items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <datalist id="titleSuggestions"></datalist>
        </div>

        <!-- Location Search Column -->
        <div class="relative flex-1 md:w-3/12 flex items-center">
          <input id="locationInput" list="locationSuggestions" placeholder="Location" 
                 class="w-full p-4 pr-10 rounded-xl bg-gray-50 border border-transparent focus:border-blue-500 focus:bg-white outline-none transition">
          <button onclick="resetInput('locationInput')" class="clear-btn absolute right-3 text-gray-400 hover:text-gray-600 w-6 h-6 items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
          <datalist id="locationSuggestions"></datalist>
        </div>

        <!-- Date Filter Column -->
        <div class="flex-1 md:w-3/12">
          <select id="dateFilter" class="w-full p-4 rounded-xl bg-gray-50 border border-transparent focus:border-blue-500 focus:bg-white outline-none transition appearance-none cursor-pointer">
            <option value="all">Any time</option>
            <option value="1">Last 24 Hours</option>
            <option value="7">Last 7 Days</option>
            <option value="30">Last 30 Days</option>
          </select>
        </div>

        <!-- Action Column -->
        <button id="mainSearchBtn" class="md:w-2/12 bg-blue-600 text-white font-bold p-4 rounded-xl hover:bg-blue-700 transition">
          Search
        </button>

      </div>
    </div>
  </div>
</header>

<!-- ================= JOBS LIST ================= -->
<main class="max-w-5xl mx-auto px-4 py-10 flex-grow">

  <!-- TOTAL JOBS CARD -->
  <div class="bg-white border rounded-xl shadow p-6 mb-6 text-center">
    <p class="text-gray-500">Total Available Jobs</p>
    <h2 id="totalJobs" class="text-3xl font-extrabold text-blue-600">...</h2>
  </div>

  <h2 id="jobCount" class="font-bold mb-6 text-gray-700 uppercase tracking-wide text-sm">Checking for jobs...</h2>

  <div id="jobsList" class="space-y-6">
    <!-- Initial Loading Skeletons for better UX -->
    <div class="skeleton h-32 w-full rounded-xl border"></div>
    <div class="skeleton h-32 w-full rounded-xl border"></div>
    <div class="skeleton h-32 w-full rounded-xl border"></div>
  </div>

  <button id="loadMoreBtn" class="hidden mt-10 bg-white border border-gray-200 px-8 py-3 rounded-xl mx-auto block hover:bg-gray-50 transition shadow-sm font-semibold">
    Load More
  </button>
</main>

<!-- ================= JOBS FIRESTORE ================= -->
<script type="module">
import {
 collection, query, where, orderBy, limit,
 getDocs, startAfter, getCountFromServer, doc, updateDoc, increment
} from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const db = window.db;

const jobsList = document.getElementById("jobsList");
const loadMoreBtn = document.getElementById("loadMoreBtn");
const jobCount = document.getElementById("jobCount");
const totalJobsEl = document.getElementById("totalJobs");

const searchInput = document.getElementById("searchInput");
const locationInput = document.getElementById("locationInput");
const dateFilter = document.getElementById("dateFilter");
const mainSearchBtn = document.getElementById("mainSearchBtn");

const titleSuggestions = document.getElementById("titleSuggestions");
const locationSuggestions = document.getElementById("locationSuggestions");

let allJobs = [];
let lastDoc = null;
const pageSize = 30; 
const suggestionSet = new Set(); 

function isNewJob(timestamp){
 const now = Date.now();
 const jobTime = timestamp?.toMillis?.() || 0;
 return (now - jobTime) <= 7 * 24 * 60 * 60 * 1000;
}

/* ---------- TRACK INTERACTION ---------- */
window.trackAndRedirect = async (id, action) => {
  try {
    const jobRef = doc(db, "jobs", id);
    await updateDoc(jobRef, {
      interactions: increment(1)
    });
  } catch (e) {
    console.error("Error updating interaction count:", e);
  } finally {
    location.href = `job-detail.html?id=${id}`;
  }
};

window.viewJob = id => trackAndRedirect(id, 'view');
window.applyJob = id => trackAndRedirect(id, 'apply');

/* ---------- RESET INPUT ---------- */
window.resetInput = (inputId) => {
  const el = document.getElementById(inputId);
  if (el) {
    el.value = "";
    filterJobs(); // Re-trigger filter after clear
  }
};

/* ---------- FILTER LOGIC ---------- */
function filterJobs() {
  const searchTerm = searchInput.value.toLowerCase().trim();
  const locationTerm = locationInput.value.toLowerCase().trim();
  const dateLimit = dateFilter.value;
  
  const filtered = allJobs.filter(job => {
    const matchesSearch = !searchTerm || 
      job.title?.toLowerCase().includes(searchTerm) || 
      job.company?.toLowerCase().includes(searchTerm);
      
    const matchesLocation = !locationTerm || 
      (job.location || "remote").toLowerCase().includes(locationTerm);
      
    let matchesDate = true;
    if (dateLimit !== "all") {
      const now = Date.now();
      const jobTime = job.timestamp?.toMillis?.() || 0;
      const hoursDiff = (now - jobTime) / (1000 * 60 * 60);
      matchesDate = hoursDiff <= (parseInt(dateLimit) * 24);
    }

    return matchesSearch && matchesLocation && matchesDate;
  });

  renderFilteredList(filtered);
}

// Ensure filterJobs is globally accessible for resetInput
window.filterJobs = filterJobs;

function renderFilteredList(list) {
  jobsList.innerHTML = "";
  if (list.length === 0) {
    jobCount.innerText = "No jobs matching your criteria.";
    return;
  }
  
  const fragment = document.createDocumentFragment();
  list.forEach(job => {
    fragment.appendChild(renderJobElement(job));
  });
  jobsList.appendChild(fragment);
  jobCount.innerText = `${list.length} jobs shown`;
}

/* ---------- TOTAL JOB COUNT ---------- */
async function loadTotalJobs(){
 try {
  const q = query(
   collection(db,"jobs"),
   where("status","==","approved")
  );
  const snap = await getCountFromServer(q);
  totalJobsEl.innerText = snap.data().count.toLocaleString();
 } catch (e) {
  totalJobsEl.innerText = "Error";
 }
}

/* ---------- LOAD JOBS ---------- */
async function loadJobs(){
 try {
  let q = query(
   collection(db,"jobs"),
   where("status","==","approved"),
   orderBy("timestamp","desc"),
   limit(pageSize)
  );

  if(lastDoc) q = query(q, startAfter(lastDoc));

  const snap = await getDocs(q);

  if (!lastDoc) {
    jobsList.innerHTML = "";
    allJobs = [];
  }

  if(snap.empty){
   loadMoreBtn.classList.add("hidden");
   if(allJobs.length === 0) jobCount.innerText = "No jobs found.";
   return;
  }

  lastDoc = snap.docs[snap.docs.length - 1];

  snap.docs.forEach(d=>{
   const job = {id:d.id, ...d.data()};
   allJobs.push(job);
   addSuggestions(job);
  });
  
  filterJobs();
  loadMoreBtn.classList.remove("hidden");
 } catch (e) {
  console.error("Load jobs error:", e);
  jobCount.innerText = "Failed to load jobs.";
 }
}

/* ---------- RENDER JOB ELEMENT ---------- */
function renderJobElement(job){
 const logo =
  job.logoUrl ||
  job.companyImageUrl ||
  `https://ui-avatars.com/api/?name=${encodeURIComponent(job.company)}`;

 const badge = isNewJob(job.timestamp)
  ? `<span class="latest-badge text-xs bg-red-500 text-white px-2 py-1 rounded-full font-bold">ðŸ”¥ NEW</span>`
  : "";

 const views = job.interactions || 0;

 const div = document.createElement("div");
 div.className="bg-white p-6 rounded-xl border border-gray-100 shadow-sm flex flex-col md:flex-row gap-4 hover:border-blue-300 hover:shadow-md transition-all";

 div.innerHTML=`
 <div class="flex gap-4 flex-1">
   <img src="${logo}" class="w-16 h-16 rounded-xl object-cover bg-gray-50 border" onerror="this.src='https://ui-avatars.com/api/?name=Company'">
   <div class="flex-1">
     <div class="flex items-center gap-2">
       <h3 class="font-bold text-lg text-gray-900">${job.title}</h3>
       ${badge}
     </div>
     
     <div class="flex flex-wrap items-center gap-y-1 mt-1 text-sm text-gray-600">
       <!-- Company Info -->
       <div class="flex items-center gap-1.5 mr-3">
         <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></svg>
         <span class="font-medium">${job.company}</span>
       </div>
       
       <!-- Location Info -->
       <div class="flex items-center gap-1">
         <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
         <span>${job.location||"Remote"}</span>
       </div>
     </div>

     <p class="text-blue-600 font-bold mt-2">${job.salary||"Salary Undisclosed"}</p>
   </div>
 </div>
 <div class="flex md:flex-col gap-2 justify-center items-center md:items-stretch min-w-[120px]">
   <button onclick="viewJob('${job.id}')" class="w-full bg-white border border-gray-200 px-4 py-2 rounded-lg hover:bg-gray-50 transition font-semibold text-gray-700 flex flex-col items-center">
     <span>View</span>
     <span class="text-[10px] text-gray-400 font-medium">${views} views</span>
   </button>
   <button onclick="applyJob('${job.id}')" class="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold shadow-sm">Apply Now</button>
 </div>`;
 return div;
}

/* ---------- SUGGESTIONS ---------- */
function addSuggestions(job){
 const options = [];
 if(job.title && !suggestionSet.has(job.title)) {
   suggestionSet.add(job.title);
   options.push({target: titleSuggestions, val: job.title});
 }
 if(job.company && !suggestionSet.has(job.company)) {
   suggestionSet.add(job.company);
   options.push({target: titleSuggestions, val: job.company});
 }
 if(job.location && !suggestionSet.has(job.location)) {
   suggestionSet.add(job.location);
   options.push({target: locationSuggestions, val: job.location});
 }
 
 options.forEach(opt => {
   const o = document.createElement('option');
   o.value = opt.val;
   opt.target.appendChild(o);
 });
}

/* ---------- EVENT LISTENERS ---------- */
loadMoreBtn.onclick = loadJobs;
mainSearchBtn.onclick = filterJobs;

searchInput.oninput = filterJobs;
locationInput.oninput = filterJobs;
dateFilter.onchange = filterJobs;

/* ---------- INIT ---------- */
loadTotalJobs();
loadJobs();
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Search Results</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@0.230.0/dist/lucide.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>

<body class="bg-gray-100">

<!-- ================= HEADER ================= -->
<header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
    <a href="index.html" class="text-lg font-bold text-blue-600 flex gap-2">
      <i data-lucide="users"></i> BooterSpace
    </a>

    <div class="text-sm text-gray-600" id="resultCount"></div>
  </div>
</header>

<!-- ================= RESULTS ================= -->
<main class="max-w-5xl mx-auto px-4 py-6">
  <h2 class="text-xl font-semibold mb-4">
    Results for "<span id="queryText"></span>"
  </h2>

  <div id="results" class="space-y-3"></div>

  <button id="loadMoreBtn"
    class="hidden mx-auto mt-6 px-6 py-2 bg-blue-600 text-white rounded-xl">
    Load more
  </button>
</main>

<script>
lucide.createIcons();

/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan"
});

const db = firebase.firestore();

/* GET QUERY */
const params = new URLSearchParams(window.location.search);
const query = params.get("q")?.toLowerCase() || "";

document.getElementById("queryText").textContent = query;

/* STATE */
let lastDoc = null;
let pageSize = 8;
let totalResults = 0;
let loadedIds = new Set();

/* SEARCH */
async function fetchResults(loadMore = false) {
  if (!query) return;

  const queries = [
    db.collection("users").orderBy("nameLower").startAt(query).endAt(query+"\uf8ff").limit(pageSize),
    db.collection("users").orderBy("usernameLower").startAt(query).endAt(query+"\uf8ff").limit(pageSize),
    db.collection("users").orderBy("emailLower").startAt(query).endAt(query+"\uf8ff").limit(pageSize)
  ];

  let resultsBox = document.getElementById("results");

  for (const q of queries) {
    const snap = await q.get();

    snap.forEach(doc => {
      if (loadedIds.has(doc.id)) return;
      loadedIds.add(doc.id);
      totalResults++;

      const u = doc.data();

      const div = document.createElement("div");
      div.className = "bg-white p-4 rounded-xl shadow flex gap-4 items-center cursor-pointer hover:bg-gray-50";
      div.innerHTML = `
        <img src="${u.photoURL || `https://ui-avatars.com/api/?name=${u.name}`}"
          class="w-12 h-12 rounded-full">
        <div>
          <div class="font-semibold">${u.name}</div>
          <div class="text-sm text-gray-500">@${u.username || u.email}</div>
        </div>
      `;

      div.onclick = () => location.href = `profile.html?uid=${doc.id}`;
      resultsBox.appendChild(div);
    });
  }

  document.getElementById("resultCount").textContent =
    `${totalResults} result(s) found`;

  document.getElementById("loadMoreBtn").classList.remove("hidden");
}

/* LOAD MORE */
document.getElementById("loadMoreBtn").onclick = () => fetchResults(true);

/* INIT */
fetchResults();
</script>

</body>
</html>

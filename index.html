<script>
  const notifyOverlay = document.getElementById("notifyOverlay");
  const allowBtn = document.getElementById("allowNotify");
  const denyBtn = document.getElementById("denyNotify");

  // Show popup only if user hasn't made a choice before
  window.addEventListener("load", () => {
    const notifyPref = localStorage.getItem("notifyPref");
    if (!notifyPref) {
      setTimeout(() => {
        notifyOverlay.classList.remove("hidden");
      }, 3000); // â³ show after 3s
    }
  });

  // Handle Allow with FCM
  allowBtn.addEventListener("click", async () => {
    localStorage.setItem("notifyPref", "allowed");
    notifyOverlay.classList.add("hidden");

    try {
      const token = await messaging.getToken({
        vapidKey: "YOUR_VAPID_KEY_HERE" // âš ï¸ replace with Firebase console key
      });

      if (token) {
        console.log("âœ… FCM Token:", token);
        alert("Notifications enabled! Youâ€™ll get real-time job alerts.");

        // ðŸ”½ Optional: Save token to Firestore under logged-in user
        /*
        const userId = firebase.auth().currentUser?.uid;
        if (userId) {
          await db.collection("users").doc(userId).update({ fcmToken: token });
        }
        */
      } else {
        console.log("âš ï¸ No registration token available.");
      }
    } catch (error) {
      console.error("FCM error:", error);
    }
  });

  // Handle Deny
  denyBtn.addEventListener("click", () => {
    localStorage.setItem("notifyPref", "denied");
    notifyOverlay.classList.add("hidden");
  });

  // Listen for foreground messages
  messaging.onMessage((payload) => {
    console.log("ðŸ“© Message received:", payload);
    new Notification(payload.notification.title, {
      body: payload.notification.body,
      icon: payload.notification.icon
    });
  });
</script>

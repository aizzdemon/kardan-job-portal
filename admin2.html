<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard ‚Äì KARDAN</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4,0,0.2,1); }
    .nav-btn.active { border-color: #4f46e5; background-color: #eef2ff; color: #4f46e5; }
    .user-card.new-user { border-left: 4px solid #10b981; }
    
    /* Modal Styles */
    .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); z-index: 50; align-items: center; justify-content: center; padding: 1rem; }
    .modal.active { display: flex; }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    
    .stats-card { transition: all 0.2s ease; }
    .stats-card:hover { transform: translateY(-2px); }
    .stats-highlight { animation: pulse-indigo 2s infinite; }

    @keyframes pulse-indigo {
      0%, 100% { outline: 2px solid transparent; }
      50% { outline: 2px solid #4f46e5; }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

<!-- USER EDIT MODAL -->
<div id="editUserModal" class="modal">
  <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
    <div class="p-6 border-b flex justify-between items-center bg-slate-50">
      <h3 class="font-black text-slate-800">User Profile Details</h3>
      <button onclick="closeUserModal()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
    </div>
    <div class="p-6 max-h-[70vh] overflow-y-auto">
      <form id="editUserForm" class="space-y-4">
        <input type="hidden" id="editUserId">
        <div id="dynamicFields" class="space-y-4">
          <!-- Form fields will be injected here -->
        </div>
      </form>
    </div>
    <div class="p-6 border-t bg-slate-50 flex gap-3 justify-end">
      <button onclick="closeUserModal()" class="px-4 py-2 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
      <button onclick="saveUserDetails()" id="saveUserBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition">Save Changes</button>
    </div>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="loginDiv" class="flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl border border-slate-200">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-black text-indigo-600">KARDAN</h1>
      <p class="text-slate-500 font-medium">Administrative Gateway</p>
    </div>
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Admin Email</label>
        <input id="email" type="email" placeholder="admin@kardan.com" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition"/>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Password</label>
        <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition"/>
      </div>
      <button onclick="login()" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 active:scale-95 transition-all shadow-lg shadow-indigo-200">Authorize Access</button>
      <p id="loginError" class="text-red-500 text-sm text-center mt-2 font-medium"></p>
    </div>
  </div>
</div>

<!-- ADMIN INTERFACE -->
<div id="adminDiv" class="hidden pb-20">
  <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl font-black text-indigo-600">KARDAN</span>
        <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded font-bold">ADMIN</span>
      </div>
      <button onclick="logout()" class="text-sm font-bold text-slate-500 hover:text-red-600 transition flex items-center gap-1">
        Logout
      </button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">
    <!-- Quick Statistics Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
      <div id="card-users" class="stats-card bg-white border border-slate-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center text-2xl shadow-sm">üë•</div>
        <div>
          <p id="stat-user-label" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Users</p>
          <h3 id="stat-totalUsers" class="text-2xl font-black text-slate-800">--</h3>
        </div>
      </div>
      <div id="card-jobs" class="stats-card bg-white border border-slate-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
        <div class="w-12 h-12 bg-green-50 text-green-600 rounded-xl flex items-center justify-center text-2xl shadow-sm">üíº</div>
        <div>
          <p id="stat-jobs-label" class="text-xs font-bold text-slate-400 uppercase tracking-wider">Active Jobs</p>
          <h3 id="stat-totalJobs" class="text-2xl font-black text-slate-800">--</h3>
        </div>
      </div>
      <div class="stats-card bg-white border border-slate-200 p-5 rounded-2xl shadow-sm flex items-center gap-4">
        <div class="w-12 h-12 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center text-2xl shadow-sm">‚è≥</div>
        <div>
          <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Pending Review</p>
          <h3 id="stat-pendingJobs" class="text-2xl font-black text-slate-800">--</h3>
        </div>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <button onclick="setActiveTab('jobs')" id="btn-jobs" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center">
        <span class="text-2xl">üíº</span>
        <span class="text-sm font-bold mt-2">Approved Jobs</span>
      </button>
      <button onclick="setActiveTab('pendingJobs')" id="btn-pendingJobs" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center">
        <span class="text-2xl">‚è≥</span>
        <span class="text-sm font-bold mt-2">Pending Jobs</span>
      </button>
      <button onclick="setActiveTab('users')" id="btn-users" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center">
        <span class="text-2xl">üë•</span>
        <span class="text-sm font-bold mt-2">Manage Users</span>
      </button>
      <button onclick="setActiveTab('posts')" id="btn-posts" class="nav-btn bg-white border border-slate-200 p-4 rounded-xl shadow-sm hover:shadow-md transition flex flex-col items-center">
        <span class="text-2xl">üí¨</span>
        <span class="text-sm font-bold mt-2">Community Posts</span>
      </button>
    </div>

    <div id="content" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 min-h-[400px]">
      <div class="flex flex-col items-center justify-center h-64 text-slate-400">
        <span class="text-5xl mb-4">üñ•Ô∏è</span>
        <p>Verified Administrative Session Active.</p>
      </div>
    </div>
  </main>
</div>

<script>
/* ============================
   Firebase Configuration
============================ */
const firebaseConfig = {
  apiKey: "AIzaSyBeGZBE1u1-y1hDWbRouchgwkgp89D973I",
  authDomain: "kar-kardan.firebaseapp.com",
  projectId: "kar-kardan",
  storageBucket: "kar-kardan.firebasestorage.app",
  messagingSenderId: "554147696994",
  appId: "1:554147696994:web:221dcb883e3b65dcea5c3b",
  measurementId: "G-RRC3X485KQ"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_UID = "nkXAUBb7ffZQ5CtyShWl6YcQ39t2";

/* ============================
   UI & Auth Functions
============================ */
let activeTab = null;

function setActiveTab(tab) {
    activeTab = tab;
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(`btn-${tab}`);
    if(activeBtn) activeBtn.classList.add('active');

    switch(tab) {
        case 'jobs': showJobs(); break;
        case 'pendingJobs': showPendingJobs(); break;
        case 'users': showUsers(); break;
        case 'posts': showPosts(); break;
    }
}

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const errorDiv = document.getElementById("loginError");
  try {
    const userCred = await auth.signInWithEmailAndPassword(email, password);
    if (userCred.user.uid !== ADMIN_UID) {
      errorDiv.textContent = "Access Denied: Non-Administrative Account.";
      await auth.signOut();
    }
  } catch (err) {
    errorDiv.textContent = "Auth Error: " + err.message;
  }
}

async function logout() { await auth.signOut(); }

auth.onAuthStateChanged(user => {
  if (user && user.uid === ADMIN_UID) {
    document.getElementById("loginDiv").classList.add("hidden");
    document.getElementById("adminDiv").classList.remove("hidden");
    refreshDashboardStats();
  } else {
    document.getElementById("loginDiv").classList.remove("hidden");
    document.getElementById("adminDiv").classList.add("hidden");
    document.getElementById("content").innerHTML = ""; 
  }
});

/* ============================
   Global Stats Function
============================ */
async function refreshDashboardStats(specificUserCount = null, isFiltered = false, specificJobCount = null) {
    try {
        if (!isFiltered) {
            // Default Counts
            const usersSnap = await db.collection("users").get();
            document.getElementById("stat-totalUsers").innerText = usersSnap.size;
            document.getElementById("stat-user-label").innerText = "Total Users";
            document.getElementById("card-users").classList.remove("stats-highlight");

            const approvedJobsSnap = await db.collection("jobs").where("status", "==", "approved").get();
            document.getElementById("stat-totalJobs").innerText = approvedJobsSnap.size;
            document.getElementById("stat-jobs-label").innerText = "Active Jobs";
            document.getElementById("card-jobs").classList.remove("stats-highlight");
        } else {
            // Filtered Counts
            document.getElementById("stat-totalUsers").innerText = specificUserCount ?? '--';
            document.getElementById("stat-user-label").innerText = "Users on Date";
            document.getElementById("card-users").classList.add("stats-highlight");

            document.getElementById("stat-totalJobs").innerText = specificJobCount ?? '--';
            document.getElementById("stat-jobs-label").innerText = "Jobs on Date";
            document.getElementById("card-jobs").classList.add("stats-highlight");
        }

        const pendingJobsSnap = await db.collection("jobs").where("status", "==", "pending").get();
        document.getElementById("stat-pendingJobs").innerText = pendingJobsSnap.size;
    } catch (e) {
        console.error("Stats Error:", e);
    }
}

async function fetchUserName(uid) {
    if(!uid) return "System";
    try {
        const uDoc = await db.collection("users").doc(uid).get();
        if(uDoc.exists) {
            const data = uDoc.data();
            return data.name || data.fullName || data.displayName || "Kardan User";
        }
        return "Guest User";
    } catch { return "Unknown"; }
}

/* ============================
   Jobs Module
============================ */
async function showJobs() {
    const content = document.getElementById("content");
    content.innerHTML = `
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">Approved Job Listings</h2>
        <div class="flex gap-2">
          <input id="jobSearch" type="text" placeholder="Search title..." class="text-sm p-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" onkeyup="if(event.key==='Enter') loadJobs()"/>
          <button onclick="loadJobs()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Search</button>
        </div>
      </div>
      <div id="jobsList" class="space-y-3">Loading records...</div>
    `;
    loadJobs();
}

async function loadJobs() {
    const searchVal = document.getElementById("jobSearch")?.value.toLowerCase() || "";
    const list = document.getElementById("jobsList");
    list.innerHTML = "Searching...";
    try {
        const snap = await db.collection("jobs").where("status", "==", "approved").orderBy("timestamp", "desc").get();
        if(snap.empty) {
            list.innerHTML = `<div class="text-center py-10 text-slate-400">No approved jobs found.</div>`;
            return;
        }
        const items = await Promise.all(snap.docs.map(async doc => {
            const j = doc.data();
            if(searchVal && !j.title?.toLowerCase().includes(searchVal)) return null;
            const poster = await fetchUserName(j.userId);
            const displayDate = j.timestamp?.toDate ? j.timestamp.toDate().toLocaleDateString() : "N/A";
            return `<div class="p-4 rounded-xl border border-slate-200 bg-white flex justify-between items-center hover:bg-slate-50 transition">
                <div class="min-w-0"><h3 class="font-bold text-slate-800 truncate">${j.title}</h3><p class="text-xs text-slate-500">${j.company} ‚Ä¢ ${displayDate}</p><p class="text-[10px] text-indigo-500 font-bold mt-1 uppercase">Post ID: ${doc.id.substring(0,8)} | Poster: ${poster}</p></div>
                <div class="flex items-center gap-2"><button onclick="deleteJob('${doc.id}')" class="bg-red-50 text-red-600 p-2 px-4 rounded-lg text-xs font-bold hover:bg-red-100">Delete</button></div>
              </div>`;
        }));
        const filtered = items.filter(x => x !== null);
        list.innerHTML = filtered.length > 0 ? filtered.join("") : `<div class="text-center py-10 text-slate-400">No results for "${searchVal}"</div>`;
    } catch(e) { list.innerHTML = `<p class="text-red-500">Query Error: ${e.message}</p>`; }
}

async function showPendingJobs() {
    const content = document.getElementById("content");
    content.innerHTML = `<h2 class="text-xl font-bold mb-6 text-amber-600">Pending Review</h2><div id="pendingList" class="space-y-3">Loading...</div>`;
    const list = document.getElementById("pendingList");
    try {
        const snap = await db.collection("jobs").where("status", "==", "pending").get();
        if(snap.empty) { list.innerHTML = `<div class="text-center py-20 text-slate-400 italic">Clear queue! No pending jobs.</div>`; return; }
        const htmlArr = await Promise.all(snap.docs.map(async doc => {
            const j = doc.data();
            const poster = await fetchUserName(j.userId);
            const displayDate = j.timestamp?.toDate ? j.timestamp.toDate().toLocaleDateString() : "N/A";
            return `<div class="bg-amber-50/50 p-4 rounded-xl border border-amber-200 flex justify-between items-center shadow-sm">
                <div class="min-w-0 pr-4"><h4 class="font-bold text-slate-800 truncate">${j.title}</h4><p class="text-sm text-slate-600">${j.company} ‚Ä¢ ${j.postedBy || 'No Email'}</p>
                  <div class="flex gap-3 mt-1"><p class="text-[10px] text-slate-400 font-bold uppercase">By: ${poster}</p><p class="text-[10px] text-slate-400 font-bold uppercase">${displayDate}</p></div>
                </div>
                <div class="flex gap-2 shrink-0"><button onclick="updateJobStatus('${doc.id}','approved')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:shadow-lg transition-all active:scale-95">Approve</button>
                  <button onclick="deleteJob('${doc.id}')" class="bg-red-50 text-red-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-100 transition-all">Reject</button>
                </div>
              </div>`;
        }));
        list.innerHTML = htmlArr.join("");
    } catch(e) { list.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; }
}

async function updateJobStatus(id, status) {
    try { 
        await db.collection("jobs").doc(id).update({ status: status }); 
        refreshDashboardStats();
        if(activeTab === 'pendingJobs') showPendingJobs(); else loadJobs(); 
    }
    catch(e) { alert("Update failed: " + e.message); }
}

async function deleteJob(id) {
    if(confirm("Permanently delete this record?")) {
        try { 
            await db.collection("jobs").doc(id).delete(); 
            refreshDashboardStats();
            if(activeTab === 'pendingJobs') showPendingJobs(); else loadJobs(); 
        }
        catch(e) { alert("Delete failed: " + e.message); }
    }
}

/* ============================
   Community Posts Module
============================ */
async function showPosts() {
    const content = document.getElementById("content");
    content.innerHTML = `
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold">Community Activity Feed</h2>
        <button onclick="loadPostsData()" class="text-xs bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded font-bold transition">Refresh Feed</button>
      </div>
      <div id="postsList" class="space-y-4">Loading community posts...</div>
    `;
    loadPostsData();
}

async function loadPostsData() {
    const list = document.getElementById("postsList");
    try {
        const snap = await db.collection("posts").orderBy("timestamp", "desc").get();
        if(snap.empty) {
            list.innerHTML = `<div class="text-center py-20 text-slate-400 italic">The community is quiet... No posts yet.</div>`;
            return;
        }

        const htmlArr = await Promise.all(snap.docs.map(async doc => {
            const p = doc.data();
            const author = await fetchUserName(p.userId);
            const date = p.timestamp?.toDate ? p.timestamp.toDate().toLocaleString() : "Recently";
            
            return `
              <div class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center font-bold text-indigo-600">
                      ${author.charAt(0).toUpperCase()}
                    </div>
                    <div>
                      <p class="font-bold text-slate-800 text-sm">${author}</p>
                      <p class="text-[10px] text-slate-400 font-semibold uppercase tracking-wider">${date}</p>
                    </div>
                  </div>
                  <button onclick="deletePost('${doc.id}')" class="text-red-500 hover:text-red-700 p-2 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
                <div class="text-slate-600 text-sm leading-relaxed whitespace-pre-wrap">${p.content || p.text || 'No content'}</div>
                ${p.imageUrl ? `<img src="${p.imageUrl}" class="mt-3 rounded-lg max-h-64 w-full object-cover border" onerror="this.style.display='none'">` : ''}
              </div>
            `;
        }));
        list.innerHTML = htmlArr.join("");
    } catch(e) {
        list.innerHTML = `<div class="bg-red-50 text-red-600 p-4 rounded-lg text-sm font-medium">Query Error: ${e.message}</div>`;
    }
}

async function deletePost(postId) {
    if(confirm("This will permanently remove the post from the community feed. Proceed?")) {
        try {
            await db.collection("posts").doc(postId).delete();
            loadPostsData();
        } catch(e) {
            alert("Delete failed: " + e.message);
        }
    }
}

/* ============================
   Users Module (With Filters & Editing)
============================ */
let currentFilter = 'all';

async function showUsers() {
    const content = document.getElementById("content");
    content.innerHTML = `
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <h2 class="text-xl font-bold">Registered Users</h2>
        <div class="flex flex-wrap items-center gap-3">
            <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg border">
                <button onclick="filterUsers('all')" id="u-all" class="px-3 py-1 text-xs font-bold rounded-md bg-white shadow-sm border border-slate-300">All</button>
                <button onclick="filterUsers('new')" id="u-new" class="px-3 py-1 text-xs font-bold rounded-md hover:bg-white transition-all">New (15d)</button>
            </div>
            <div class="flex items-center gap-2">
                <input type="date" id="dateFilter" class="text-xs p-2 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" onchange="loadUsersData()"/>
                <button onclick="resetUserFilters()" class="text-xs text-indigo-600 font-bold hover:underline">Reset</button>
            </div>
        </div>
      </div>
      <div id="usersList" class="space-y-3">Loading...</div>
    `;
    loadUsersData();
}

function filterUsers(type) {
    currentFilter = type;
    document.getElementById('u-all').className = type === 'all' ? 'px-3 py-1 text-xs font-bold rounded-md bg-white shadow-sm border border-slate-300' : 'px-3 py-1 text-xs font-bold rounded-md hover:bg-white';
    document.getElementById('u-new').className = type === 'new' ? 'px-3 py-1 text-xs font-bold rounded-md bg-white shadow-sm border border-slate-300' : 'px-3 py-1 text-xs font-bold rounded-md hover:bg-white';
    loadUsersData();
}

function resetUserFilters() { 
    document.getElementById('dateFilter').value = ''; 
    filterUsers('all'); 
    refreshDashboardStats(); 
}

async function loadUsersData() {
    const list = document.getElementById("usersList");
    const dateLimit = document.getElementById("dateFilter").value;
    list.innerHTML = '<div class="text-center py-10 text-slate-400">Fetching community...</div>';
    
    try {
        // Fetch users
        const userSnap = await db.collection("users").get();
        if(userSnap.empty) { list.innerHTML = `<p class="text-center text-slate-400">No user profiles found.</p>`; return; }

        const now = new Date();
        const fifteenDaysAgo = new Date();
        fifteenDaysAgo.setDate(now.getDate() - 15);

        let users = userSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Apply filters for users
        if (currentFilter === 'new') {
            users = users.filter(u => {
                const regDate = u.createdAt?.toDate ? u.createdAt.toDate() : (u.timestamp?.toDate ? u.timestamp.toDate() : null);
                return regDate && regDate >= fifteenDaysAgo;
            });
        }

        if (dateLimit) {
            const filterDateStr = dateLimit; // YYYY-MM-DD
            
            // Filter users list by date
            users = users.filter(u => {
                const regDate = u.createdAt?.toDate ? u.createdAt.toDate() : (u.timestamp?.toDate ? u.timestamp.toDate() : null);
                if (!regDate) return false;
                const dStr = regDate.toISOString().split('T')[0];
                return dStr === filterDateStr;
            });

            // ALSO Fetch Jobs count for this specific date
            const jobSnap = await db.collection("jobs").where("status", "==", "approved").get();
            const jobsOnDate = jobSnap.docs.filter(doc => {
                const jobData = doc.data();
                const jobDate = jobData.timestamp?.toDate ? jobData.timestamp.toDate() : null;
                return jobDate && jobDate.toISOString().split('T')[0] === filterDateStr;
            });

            // Update the top stats counter for both
            refreshDashboardStats(users.length, true, jobsOnDate.length);
        } else {
            // Restore default stats
            refreshDashboardStats();
        }

        if(users.length === 0) { list.innerHTML = `<div class="text-center py-20 text-slate-400">No users found for this selection.</div>`; return; }

        list.innerHTML = users.map(u => {
            const isThisAdmin = u.id === ADMIN_UID;
            const regDate = u.createdAt?.toDate ? u.createdAt.toDate() : (u.timestamp?.toDate ? u.timestamp.toDate() : null);
            const isNew = regDate && regDate >= fifteenDaysAgo;
            const dateStr = regDate ? regDate.toLocaleDateString() : 'Unknown Date';
            
            // Fix Name display
            const displayName = u.name || u.fullName || u.displayName || "Kardan User";

            return `<div class="user-card p-4 border rounded-xl bg-white flex justify-between items-center transition-all hover:shadow-md ${isNew ? 'new-user border-green-200 bg-green-50/10' : ''} ${isThisAdmin ? 'border-indigo-200 bg-indigo-50/30' : ''}">
                <div>
                  <h4 class="font-bold flex items-center gap-2">${displayName} 
                    ${isThisAdmin ? '<span class="text-[10px] bg-indigo-600 text-white px-1.5 py-0.5 rounded uppercase font-bold">Admin</span>' : ''}
                    ${isNew ? '<span class="text-[10px] bg-green-500 text-white px-1.5 py-0.5 rounded uppercase font-bold">New</span>' : ''}
                  </h4>
                  <p class="text-sm text-slate-500 font-medium">${u.email || 'No email provided'}</p>
                  <p class="text-[10px] text-slate-400 mt-1 uppercase font-semibold">Joined: ${dateStr}</p>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-[10px] font-mono text-slate-300 hidden md:block select-all">${u.id}</div>
                  <button onclick="openEditUser('${u.id}')" class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-100 transition">Details</button>
                </div>
              </div>`;
        }).join("");
    } catch(e) { 
        console.error(e);
        list.innerHTML = `<p class="text-red-500">Error: ${e.message}</p>`; 
    }
}

async function openEditUser(userId) {
    const modal = document.getElementById("editUserModal");
    const container = document.getElementById("dynamicFields");
    document.getElementById("editUserId").value = userId;
    container.innerHTML = "Fetching full profile...";
    modal.classList.add("active");

    try {
        const uDoc = await db.collection("users").doc(userId).get();
        if(!uDoc.exists) throw new Error("User document not found");
        
        const data = uDoc.data();
        container.innerHTML = "";
        
        const skipFields = ['createdAt', 'timestamp', 'uid'];
        const mainFields = ['name', 'fullName', 'email', 'phone', 'location', 'role', 'bio'];
        const allKeys = [...new Set([...mainFields, ...Object.keys(data)])].filter(k => !skipFields.includes(k));

        allKeys.forEach(key => {
            const val = data[key] || "";
            const isLong = typeof val === 'string' && val.length > 50;
            
            const fieldHtml = `
              <div>
                <label class="block text-xs font-bold text-slate-500 uppercase mb-1 tracking-wider">${key.replace(/([A-Z])/g, ' $1')}</label>
                ${isLong ? 
                  `<textarea data-key="${key}" class="w-full p-3 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 h-24 transition">${val}</textarea>` :
                  `<input type="text" data-key="${key}" value="${val}" class="w-full p-3 border rounded-lg text-sm bg-slate-50 focus:bg-white outline-none focus:ring-2 focus:ring-indigo-500 transition"/>`
                }
              </div>
            `;
            container.insertAdjacentHTML('beforeend', fieldHtml);
        });

    } catch(e) { container.innerHTML = `<p class="text-red-500 font-bold">Failed to load: ${e.message}</p>`; }
}

async function saveUserDetails() {
    const userId = document.getElementById("editUserId").value;
    const saveBtn = document.getElementById("saveUserBtn");
    const inputs = document.querySelectorAll("#dynamicFields [data-key]");
    const updatedData = {};

    inputs.forEach(el => { updatedData[el.dataset.key] = el.value; });

    try {
        saveBtn.disabled = true;
        saveBtn.innerText = "Saving...";
        await db.collection("users").doc(userId).update(updatedData);
        closeUserModal();
        loadUsersData(); 
    } catch(e) {
        alert("Save failed: " + e.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerText = "Save Changes";
    }
}

function closeUserModal() { document.getElementById("editUserModal").classList.remove("active"); }

window.onclick = (e) => { if(e.target === document.getElementById("editUserModal")) closeUserModal(); };
</script>
</body>
</html>
